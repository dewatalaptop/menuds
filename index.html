<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoApp - V7.8 Reactive UI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        :root {
            --primary-color: #4a7c59; --primary-light: #6b9d7a; --primary-dark: #385f46;
            --secondary-color: #f1f5f9; --white-color: #ffffff;
            --text-color: #1e293b; --text-light: #64748b;
            --border-color: #e2e8f0; --danger-color: #e53e3e; --warning-color: #dd6b20;
            --success-color: #38a169; --info-color: #3182ce;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 0.5rem; --transition: all 0.2s ease-in-out; --sidebar-width: 240px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--secondary-color); color: var(--text-color); line-height: 1.6; }
        #sidebar { width: var(--sidebar-width); background-color: var(--white-color); border-right: 1px solid var(--border-color); height: 100vh; position: fixed; top: 0; left: 0; z-index: 1000; display: flex; flex-direction: column; transition: transform 0.3s ease-in-out; box-shadow: var(--shadow-md); }
        .sidebar-header { padding: 1.25rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h1 { font-size: 1.5rem; color: var(--primary-color); font-weight: 600; margin: 0; }
        .sidebar-menu { flex-grow: 1; list-style: none; padding: 1rem 0; }
        .sidebar-menu a { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1.5rem; color: var(--text-light); text-decoration: none; font-weight: 500; border-left: 3px solid transparent; transition: var(--transition); }
        .sidebar-menu a:hover { background-color: var(--secondary-color); color: var(--primary-dark); }
        .sidebar-menu a.active { background-color: var(--secondary-color); color: var(--primary-color); border-left-color: var(--primary-color); font-weight: 600; }
        .sidebar-menu a i { width: 20px; text-align: center; font-size: 1.1rem; }
        .sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); }
        #app-container { flex-grow: 1; transition: margin-left 0.3s ease-in-out; padding-left: var(--sidebar-width); }
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        header { background-color: var(--white-color); padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); }
        header h2 { font-weight: 600; font-size: 1.5rem; color: var(--primary-color); margin: 0; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #header-alerts { position: relative; cursor: pointer; }
        #header-alerts .alert-icon { font-size: 1.5rem; color: var(--primary-dark); transition: transform 0.2s; }
        #header-alerts:hover .alert-icon { transform: scale(1.1); }
        #header-alerts .alert-badge { position: absolute; top: -5px; right: -10px; background-color: var(--danger-color); color: var(--white-color); border-radius: 50%; width: 22px; height: 22px; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: 600; border: 2px solid var(--white-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); } }
        @media (max-width: 768px) { #sidebar { transform: translateX(calc(-1 * var(--sidebar-width))); } #sidebar.open { transform: translateX(0); } #app-container { padding-left: 0; } .mobile-menu-toggle { display: block !important; z-index: 1001; } .page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none;} #sidebar.open ~ #app-container .page-overlay { display: block; } }
        @media (max-width: 480px) { .container { padding: 1rem; } .card { padding: 1rem; } header h2 { font-size: 1.2rem; } }
        .card { background: var(--white-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: var(--border-radius); font-weight: 500; cursor: pointer; transition: var(--transition); border: none; font-size: 0.9rem; }
        .btn:disabled { background-color: var(--text-light); cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: var(--primary-color); color: #fff; } .btn-primary:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger-color); color: #fff; } .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8rem; }
        .form-group { position: relative; margin-bottom: 1rem; }
        .form-label { display: block; font-weight: 500; font-size: 0.85rem; margin-bottom: 0.3rem; color: var(--text-color); }
        .form-control { width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9rem; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1100; display: flex; flex-direction: column; gap: 0.75rem; max-width: 350px; }
        .toast { background-color: var(--text-color); color: var(--white-color); padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); opacity: 0; transform: translateX(100%); transition: opacity 0.3s, transform 0.3s; display: flex; align-items: center; gap: 1rem; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--danger-color); } .toast.info { background-color: var(--info-color); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.25rem; }
        .dashboard-card { background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: var(--transition); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; text-decoration: none; color: inherit; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-color); }
        .dashboard-card i { font-size: 2.25rem; color: var(--primary-color); }
        .dashboard-card h3 { font-size: 1rem; font-weight: 500; color: var(--text-color); }
        .page { animation: fadeIn 0.3s ease; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(45, 55, 72, 0.6); backdrop-filter: blur(2px); z-index: 1040; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.2s ease; visibility: hidden; }
        .modal-backdrop.show { opacity: 1; visibility: visible; }
        .modal-content { background: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.2s ease; }
        .modal-backdrop.show .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-color); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        #login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #login-card { width: 100%; max-width: 400px; text-align: center; }
        #login-error { color: var(--danger-color); margin-top: 1rem; display: none; font-size: 0.9rem; }
        #app-root { display: none; }
        .item-row { display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center; padding: 0.75rem; border-radius: var(--border-radius); } .item-row:nth-child(odd) { background-color: var(--secondary-color); }
        .item-list { display: grid; gap: 0.75rem; }
        .item-label { font-weight: 500; } .stock-hint { color: var(--text-light); font-size: 0.85rem; }
        .table { width: 100%; border-collapse: collapse; } .table th, .table td { padding: 0.875rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); } .table th { background-color: var(--secondary-color); font-weight: 600; }
        .drag-handle { cursor: grab; } .dragging { opacity: 0.5; }
        .empty-state { text-align: center; padding: 2rem; color: var(--text-light); border: 2px dashed var(--border-color); border-radius: var(--border-radius); }
        .global-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--secondary-color); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: var(--primary-color); transition: opacity 0.3s ease; }
    </style>
</head>
<body>
    <div class="global-loader" id="global-loader"><i class="fas fa-spinner fa-spin"></i></div>

    <div id="login-page">
        <div class="card" id="login-card">
            <h1 style="justify-content: center; color: var(--primary-color); margin-bottom: 2rem; display:flex; align-items:center; gap: 0.75rem;"><i class="fas fa-utensils"></i> RestoApp V7.8</h1>
            <form id="login-form">
                <div class="form-group" style="text-align: left;"><label for="email" class="form-label">Email</label><input type="email" id="email" class="form-control" required></div>
                <div class="form-group" style="text-align: left;"><label for="password" class="form-label">Password</label><input type="password" id="password" class="form-control" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Login</button>
            </form>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="app-root">
        <nav id="sidebar">
            <div class="sidebar-header"><h1><i class="fas fa-utensils"></i> RestoApp</h1></div>
            <ul class="sidebar-menu" id="sidebar-menu-container"></ul>
            <div class="sidebar-footer">
                <div id="user-email-display" style="font-weight: 500; word-break: break-all;"></div>
                <button class="btn btn-sm btn-danger" data-action="logout" style="width: 100%; margin-top: 0.75rem;"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </nav>

        <div id="app-container">
            <div class="page-overlay" data-action="toggle-sidebar"></div>
            <div id="modal-container"></div>
            <div class="container">
                <header>
                    <h2 id="page-title">Dashboard</h2>
                    <div class="header-actions">
                        <div id="header-alerts"></div>
                        <button class="mobile-menu-toggle btn btn-primary" data-action="toggle-sidebar" style="display: none;"><i class="fas fa-bars"></i></button>
                    </div>
                </header>
                <main id="main-content"></main>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>
    <input type="file" id="import-file-input" accept=".json" style="display:none;">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBqpro-gmPkgE8cZVZ5LG0mjoyl5GUYVl8",
    authDomain: "restoapp-v6.firebaseapp.com",
    projectId: "restoapp-v6",
    storageBucket: "restoapp-v6.appspot.com",
    messagingSenderId: "163876863347",
    appId: "1:163876863347:web:2e5181c0bdae91e3809906"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const firestore = firebase.firestore();

window.RestoApp = {
    AppState: { currentUser: null, masterItems: [], recipes: {}, shoppingLists: [], stockTransactions: [], gudangItemIds: [], menuKeluarActive: [], isDataLoaded: false, unsubscribe: null },

    Utils: {
        formatCurrency: (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value || 0),
        calculateAvailablePortions(menuName) {
            const { recipes, masterItems } = RestoApp.AppState; if(!recipes || !masterItems) return 0;
            const recipe = recipes[menuName]; if (!recipe || !recipe.ingredients) return 0; let minPortions = Infinity;
            recipe.ingredients.forEach(ing => {
                const item = masterItems.find(mi => mi.id === ing.itemId);
                if (item && ing.qty > 0) minPortions = Math.min(minPortions, Math.floor((item.stock || 0) / ing.qty));
                else if (ing.qty > 0) minPortions = 0;
            });
            return minPortions === Infinity ? 0 : minPortions;
        },
        generateDailyReport() {
            const { stockTransactions, masterItems } = RestoApp.AppState; const now = new Date(); const yesterday = new Date(now.getTime() - (24 * 60 * 60 * 1000));
            const recentTransactions = (stockTransactions || []).filter(t => new Date(t.date) > yesterday);
            const menuProduksi = recentTransactions.filter(t => t.type === 'Produksi Menu');
            const menuCount = menuProduksi.reduce((acc, t) => { acc[t.details] = (acc[t.details] || 0) + t.change; return acc; }, {});
            const topMenus = Object.entries(menuCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
            return { topMenus, reportDate: now };
        },
        addDragDropHandlers(container) {
            container.addEventListener('dragstart', e => e.target.classList.add('dragging'));
            container.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            container.addEventListener('dragover', e => {
                e.preventDefault(); const afterElement = this.getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable) { if (afterElement == null) container.appendChild(draggable); else container.insertBefore(draggable, afterElement); }
            });
        },
        getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
            return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element;
        },
        /** PERBAIKAN: Helper untuk menangani state loading pada tombol */
        async handleAsyncButton(button, asyncFunction) {
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            try {
                await asyncFunction();
            } catch (error) {
                console.error("Async operation failed:", error);
                RestoApp.UI.showToast(`Operasi gagal: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        },
    },

    API: {
        listenToData() {
            const AppState = RestoApp.AppState; if (AppState.unsubscribe) AppState.unsubscribe(); if (!AppState.currentUser) return;
            const docRef = firestore.collection('restaurants').doc(AppState.currentUser.uid);
            AppState.unsubscribe = docRef.onSnapshot(doc => {
                const wasDataLoaded = AppState.isDataLoaded;
                if (doc.exists) {
                    const data = doc.data(); 
                    Object.keys(AppState).forEach(key => { if(data[key] !== undefined) AppState[key] = data[key]; });
                } else {
                    this.initializeDefaultData();
                }
                AppState.isDataLoaded = true;
                
                /** PERBAIKAN: Sistem reaktivitas terpusat.
                 * Setiap kali data dari Firebase berubah, panggil render ulang untuk halaman yang sedang aktif.
                 * Ini memastikan UI selalu sinkron dengan state data terbaru.
                */
                if (!wasDataLoaded) { // Pemuatan pertama
                    const loader = document.getElementById('global-loader');
                    loader.style.opacity = '0';
                    loader.addEventListener('transitionend', () => loader.style.display = 'none');
                    RestoApp.UI.renderPage(location.hash.substring(1) || 'page-dashboard');
                } else { // Update data real-time
                    RestoApp.UI.renderPage(location.hash.substring(1) || 'page-dashboard', null, true);
                }
                RestoApp.UI.lowStockAlerts(); // Selalu update notifikasi
            }, error => {
                console.error("Firebase listen error:", error);
                RestoApp.UI.showToast("Gagal sinkronisasi data real-time.", "error");
            });
        },
        async set(data) { if (!RestoApp.AppState.currentUser) return; await firestore.collection('restaurants').doc(RestoApp.AppState.currentUser.uid).set(data, { merge: true }); },
        async setKey(key, value) { if (!RestoApp.AppState.currentUser) return; await firestore.collection('restaurants').doc(RestoApp.AppState.currentUser.uid).set({ [key]: value }, { merge: true }); },
        async initializeDefaultData() {
            const initialData = { masterItems: [], recipes: {}, gudangItemIds: [], menuKeluarActive: [], shoppingLists: [], stockTransactions: [] };
            await this.set(initialData); RestoApp.UI.showToast("Selamat datang! Data awal telah disiapkan.", "success");
            Object.assign(RestoApp.AppState, initialData);
        }
    },

    Auth: {
        listen() {
            auth.onAuthStateChanged(user => {
                const loginPage = document.getElementById('login-page'); const appRoot = document.getElementById('app-root');
                const loader = document.getElementById('global-loader');
                if (user) {
                    RestoApp.AppState.currentUser = user; 
                    loginPage.style.display = 'none'; appRoot.style.display = 'block';
                    RestoApp.App.initOnLogin();
                } else {
                    RestoApp.AppState.currentUser = null; 
                    loginPage.style.display = 'flex'; appRoot.style.display = 'none';
                    loader.style.display = 'none';
                    if (RestoApp.AppState.unsubscribe) { RestoApp.AppState.unsubscribe(); RestoApp.AppState.unsubscribe = null; }
                    RestoApp.AppState.isDataLoaded = false;
                }
            });
        },
        async login(email, password) { await auth.signInWithEmailAndPassword(email, password); },
        async logout() { await auth.signOut(); }
    },
    
    UI: {
        menuConfig: [
            { id: 'page-dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
            { id: 'page-input-belanja', icon: 'fa-shopping-cart', text: 'Buat List Belanja' },
            { id: 'page-riwayat-stok', icon: 'fa-history', text: 'Riwayat Stok' },
            { id: 'page-manager-area', icon: 'fa-user-tie', text: 'Manager Area' },
        ],
        /** PERBAIKAN: Parameter isUpdate untuk mencegah perubahan hash yang tidak perlu saat re-render */
        renderPage(pageId, data = null, isUpdate = false) {
            if (!RestoApp.AppState.isDataLoaded && pageId !== 'login-page') return; // Jangan render apapun sebelum data siap
            const pageConfig = this.menuConfig.find(p => p.id === pageId) || {id: pageId, text: pageId.replace('page-','').replace(/-/g,' ').replace(/\b\w/g, l => l.toUpperCase())};
            
            if (location.hash !== `#${pageId}` && !isUpdate) { location.hash = `#${pageId}`; }

            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.toggle('active', a.dataset.page === pageId));
            const pageContent = this.Pages[pageId] ? this.Pages[pageId](data) : `<div class="card"><p>Halaman tidak ditemukan.</p></div>`;
            document.getElementById('main-content').innerHTML = pageContent;
            document.getElementById('page-title').textContent = pageConfig.text;
            document.title = `${pageConfig.text} - RestoApp`;
            
            if(pageId === 'page-manager-items') RestoApp.Utils.addDragDropHandlers(document.getElementById('db-editor-tbody'));
        },
        renderSidebar() {
            document.getElementById('sidebar-menu-container').innerHTML = this.menuConfig.map(item => `<li><a href="#${item.id}" data-page="${item.id}"><i class="fas ${item.icon}"></i><span>${item.text}</span></a></li>`).join('');
            document.getElementById('user-email-display').textContent = RestoApp.AppState.currentUser.email;
        },
        lowStockAlerts() {
            const container = document.getElementById('header-alerts'); if (!container) return;
            const lowStockItems = RestoApp.AppState.masterItems.filter(item => (item.stock || 0) < (item.minStock || 0));
            container.innerHTML = lowStockItems.length > 0 ? `<div data-action="show-low-stock-modal"><i class="fas fa-bell alert-icon"></i><span class="alert-badge">${lowStockItems.length}</span></div>` : '';
        },
        showLowStockModal() {
            const lowStockItems = RestoApp.AppState.masterItems.filter(item => (item.stock || 0) < (item.minStock || 0)); if (lowStockItems.length === 0) return;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `<div class="modal-backdrop show" data-action="close-modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Peringatan Stok Rendah</h3><button class="modal-close-btn" data-action="close-modal" aria-label="Tutup">&times;</button></div><div class="modal-body"><div style="position: relative; height:60vh;"><canvas id="lowStockChart"></canvas></div></div></div></div>`;
            const ctx = document.getElementById('lowStockChart').getContext('2d');
            new Chart(ctx, { type: 'bar', data: { labels: lowStockItems.map(item => `${item.name} (${item.unit})`), datasets: [{ label: 'Stok Saat Ini', data: lowStockItems.map(item => item.stock), backgroundColor: 'rgba(221, 107, 32, 0.7)' }, { label: 'Stok Minimum', data: lowStockItems.map(item => item.minStock), backgroundColor: 'rgba(229, 62, 62, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' } });
        },
        closeModal() { document.getElementById('modal-container').innerHTML = ''; },
        showToast(message, type = 'success') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            toast.className = `toast ${type}`; toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        },
        
        Pages: {
            'page-dashboard': () => `<div class="dashboard-grid">
                <a href="#" class="dashboard-card" data-page="page-input-belanja-datang"><i class="fas fa-truck-loading"></i><h3>Input Belanja Datang</h3></a>
                <a href="#" class="dashboard-card" data-page="page-input-menu-keluar"><i class="fas fa-utensils"></i><h3>Input Menu Keluar</h3></a>
                <a href="#" class="dashboard-card" data-page="page-ambil-gudang"><i class="fas fa-warehouse"></i><h3>Ambil dari Gudang</h3></a>
                <a href="#" class="dashboard-card" data-page="page-laporan-harian"><i class="fas fa-chart-line"></i><h3>Laporan Harian</h3></a>
            </div>`,
            'page-input-belanja': () => {
                const { masterItems } = RestoApp.AppState; const categories = [...new Set(masterItems.map(item => item.category))];
                let formHTML = categories.map(cat => {
                    let itemsHTML = masterItems.filter(item => item.category === cat).sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0)).map(item => `<div class="item-row"><label for="shopitem-${item.id}" class="item-label">${item.name}<div class="stock-hint">Stok: ${(item.stock || 0).toFixed(2)} ${item.unit}</div></label><input type="number" id="shopitem-${item.id}" class="form-control" placeholder="Jumlah" min="0" step="any" data-item-id="${item.id}"><span class="item-unit">${item.purchaseUnit || item.unit}</span></div>`).join('');
                    return `<div class="card"><h3 class="card-title">${cat}</h3><div class="item-list">${itemsHTML}</div></div>`;
                }).join('');
                return `<div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-shopping-cart"></i><span>Buat List Belanja</span></div><button class="btn btn-sm" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div>${formHTML}<button class="btn btn-primary" style="width:100%" data-action="save-shopping-list"><i class="fas fa-save"></i> Simpan List Belanja</button></div>`;
            },
            'page-input-belanja-datang': (data) => {
                if(data) return RestoApp.UI.Pages.stockInDetail(data);
                const { shoppingLists } = RestoApp.AppState;
                let content = (shoppingLists.length === 0) ? `<div class="empty-state">Tidak ada list belanja yang menunggu.</div>` : shoppingLists.map(list => `<div class="card" style="cursor:pointer;" data-action="select-pending-list" data-date="${list.date}"><strong>List Belanja - ${new Date(list.date).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}</strong></div>`).join('');
                return `<div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-truck-loading"></i><span>Pilih List Belanja</span></div><button class="btn btn-sm" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div>${content}</div>`;
            },
            'stockInDetail': (listDate) => {
                const shoppingList = RestoApp.AppState.shoppingLists.find(l => l.date === listDate); if (!shoppingList) return `Error: List not found.`;
                const itemsHTML = shoppingList.items.map(item => { const masterItem = RestoApp.AppState.masterItems.find(mi => mi.id === item.id); if (!masterItem) return '';
                    return `<div class="item-row"><label for="stockin-${item.id}" class="item-label">${masterItem.name}</label><input type="number" id="stockin-${item.id}" class="form-control" value="${item.qty}" min="0" step="any"><span class="item-unit">${masterItem.purchaseUnit || masterItem.unit}</span></div>`; }).join('');
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Konfirmasi Barang Datang</span></div><button class="btn btn-sm" data-page="page-input-belanja-datang"><i class="fas fa-arrow-left"></i> Kembali</button></div><div class="item-list">${itemsHTML}</div><div style="display:flex; gap: 10px; margin-top:1rem;"><button class="btn btn-primary" style="flex-grow:1;" data-action="process-stock-in" data-date="${listDate}">Proses</button><button class="btn btn-danger" data-action="cancel-shopping-list" data-date="${listDate}">Batalkan</button></div></div>`;
            },
            'page-input-menu-keluar': () => RestoApp.UI.Pages.stockOutPage('menu'),
            'page-ambil-gudang': () => RestoApp.UI.Pages.stockOutPage('gudang'),
            'stockOutPage': (type) => {
                const { masterItems, recipes, gudangItemIds, menuKeluarActive } = RestoApp.AppState; let itemsToRender, title, icon;
                if (type === 'gudang') { title = "Ambil dari Gudang"; icon = "fa-warehouse"; itemsToRender = masterItems.filter(item => gudangItemIds.includes(item.id)).sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0)); } 
                else { title = "Input Menu Keluar"; icon = "fa-utensils"; itemsToRender = menuKeluarActive.map(key => ({ name: key, ...recipes[key] })).sort((a,b) => a.name.localeCompare(b.name)); }
                let formHTML = itemsToRender.map(item => {
                    const stockHint = (type === 'gudang') ? `Stok: ${(item.stock || 0).toFixed(2)} ${item.unit}` : `Stok cukup untuk: ${RestoApp.Utils.calculateAvailablePortions(item.name)} ${item.unit}`;
                    return `<div class="item-row"><label class="item-label">${item.name}<div class="stock-hint">${stockHint}</div></label><input type="number" class="form-control" data-name="${item.name}" placeholder="Jumlah" min="0" step="any"><span class="item-unit">${item.unit}</span></div>`;
                }).join('');
                if (itemsToRender.length === 0) formHTML = `<div class="empty-state">Tidak ada item untuk ditampilkan. Atur di Manager Area -> Atur Tampilan.</div>`;
                return `<div class="card"><div class="card-header"><div class="card-title"><i class="fas ${icon}"></i><span>${title}</span></div><button class="btn btn-sm" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div><div class="item-list" id="stockout-list" data-type="${type}">${formHTML}</div><button class="btn btn-primary" style="width:100%; margin-top:1rem;" data-action="process-stock-out"><i class="fas fa-check"></i> Proses</button></div>`;
            },
            'page-riwayat-stok': () => {
                const { stockTransactions, masterItems } = RestoApp.AppState;
                const rows = [...(stockTransactions || [])].reverse().map(t => { const item = masterItems.find(i => i.id === t.itemId); const changeClass = t.change > 0 ? 'color: var(--success-color);' : 'color: var(--danger-color);';
                    let itemName = item ? item.name : (t.type === 'Produksi Menu' ? t.details : 'Item Dihapus');
                    return `<tr><td>${new Date(t.date).toLocaleString('id-ID', {dateStyle: 'short', timeStyle: 'short'})}</td><td>${itemName}</td><td>${t.type}</td><td style="${changeClass}">${t.change > 0 ? '+' : ''}${t.change.toFixed(2)}</td><td>${(t.newStock !== null && t.newStock !== undefined ? t.newStock.toFixed(2) : '-')}</td></tr>`; }).join('');
                const tableContent = rows.length > 0 ? `<div style="overflow-x:auto;"><table class="table"><thead><tr><th>Waktu</th><th>Item/Menu</th><th>Jenis</th><th>+/-</th><th>Sisa</th></tr></thead><tbody>${rows}</tbody></table></div>` : `<div class="empty-state">Belum ada riwayat transaksi stok.</div>`;
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Riwayat Stok</span></div><button class="btn btn-sm" data-page="page-dashboard">Kembali</button></div>${tableContent}</div>`;
            },
            'page-laporan-harian': () => {
                const report = RestoApp.Utils.generateDailyReport(); const createListHTML = (data, unit = '') => (data.length === 0) ? `<p>Tidak ada data.</p>` : `<ul>${data.map(item => `<li>${item[0]}: <strong>${parseFloat(item[1]).toFixed(1)} ${unit}</strong></li>`).join('')}</ul>`;
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Laporan Harian</span></div><button class="btn btn-sm" data-page="page-dashboard">Kembali</button></div><p>Laporan 24 jam terakhir (dibuat ${report.reportDate.toLocaleTimeString('id-ID')})</p><div class="card"><h4>Top Menu Terjual</h4>${createListHTML(report.topMenus, 'porsi')}</div></div>`;
            },
            'page-manager-area': () => `<div class="card"><div class="card-header"><div class="card-title"><span>Manager Area</span></div><button class="btn btn-sm" data-page="page-dashboard">Kembali</button></div><div class="dashboard-grid">
                <a href="#" class="dashboard-card" data-page="page-manager-items"><i class="fas fa-database"></i><h3>Database Barang</h3></a>
                <a href="#" class="dashboard-card" data-page="page-manager-recipes"><i class="fas fa-book-open"></i><h3>Manajemen Resep</h3></a>
                <a href="#" class="dashboard-card" data-page="page-manager-display"><i class="fas fa-desktop"></i><h3>Atur Tampilan</h3></a>
                <a href="#" class="dashboard-card" data-page="page-manager-backup"><i class="fas fa-cloud-upload-alt"></i><h3>Cadangkan Data</h3></a>
            </div></div>`,
            'page-manager-items': () => {
                const itemsHTML = RestoApp.AppState.masterItems.sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0)).map(item => `<tr data-id="${item.id}" draggable="true"><td class="drag-handle" aria-label="Urutkan"><i class="fas fa-grip-vertical"></i></td><td>${item.name}<div class="stock-hint">${item.category}</div></td><td>${(item.stock || 0).toFixed(2)} ${item.unit}</td><td style="display:flex;gap:0.5rem;"><button class="btn btn-sm" data-action="edit-item" data-id="${item.id}" aria-label="Edit"><i class="fas fa-pencil-alt"></i></button><button class="btn btn-sm btn-danger" data-action="delete-item" data-id="${item.id}" aria-label="Hapus"><i class="fas fa-trash"></i></button></td></tr>`).join('');
                const tableContent = RestoApp.AppState.masterItems.length > 0 ? `<div style="overflow-x:auto;"><table class="table"><thead><tr><th>Urutan</th><th>Nama</th><th>Stok</th><th>Aksi</th></tr></thead><tbody id="db-editor-tbody">${itemsHTML}</tbody></table></div>` : `<div class="empty-state">Database barang masih kosong. Silakan tambahkan barang baru.</div>`;
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Database Barang</span></div><button class="btn btn-sm" data-page="page-manager-area">Kembali</button></div>
                <div class="card"><h3 class="card-title">Tambah / Edit Barang</h3><form id="add-item-form"><input type="hidden" id="edit-item-id"><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"><div class="form-group"><label class="form-label">Nama Barang</label><input class="form-control" type="text" id="item-name" required></div><div class="form-group"><label class="form-label">Kategori</label><input class="form-control" type="text" id="item-category" list="category-suggestions" required></div><div class="form-group"><label class="form-label">Satuan Stok</label><input class="form-control" type="text" id="item-unit" required></div><div class="form-group"><label class="form-label">Satuan Beli</label><input class="form-control" type="text" id="item-purchase-unit"></div><div class="form-group"><label class="form-label">Konversi</label><input class="form-control" type="number" id="item-conversion" min="0" step="any"></div><div class="form-group"><label class="form-label">Stok Minimum</label><input class="form-control" type="number" id="item-min-stock" min="0" step="any"></div></div><div style="display:flex; gap:10px; margin-top: 1rem;"><button type="button" class="btn btn-primary" data-action="save-item" id="save-item-btn" style="flex-grow:1;">Simpan</button><button type="button" class="btn" data-action="cancel-edit" id="cancel-edit-btn" style="display:none;">Batal</button></div></form><datalist id="category-suggestions"></datalist></div>
                <div class="card"><div class="card-header"><h3 class="card-title">Daftar Barang</h3><button class="btn btn-sm btn-primary" data-action="save-item-order">Simpan Urutan</button></div>${tableContent}</div></div>`;
            },
            'page-manager-recipes': (data) => {
                if(data) return RestoApp.UI.Pages.recipeEditor(data);
                const { recipes } = RestoApp.AppState;
                const listHTML = Object.keys(recipes).sort().map(name => `<div class="item-row"><span>${name}</span><span>${recipes[name].unit}</span><div style="display:flex;gap:0.5rem;"><button class="btn btn-sm" data-action="edit-recipe" data-name="${name}" aria-label="Edit Resep">Edit</button><button class="btn btn-sm btn-danger" data-action="delete-recipe" data-name="${name}" aria-label="Hapus Resep">Hapus</button></div></div>`).join('') || `<div class="empty-state">Belum ada resep yang dibuat.</div>`;
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Manajemen Resep</span></div><button class="btn btn-sm" data-page="page-manager-area">Kembali</button></div><div class="card-header"><h3>Daftar Resep</h3><button class="btn btn-sm btn-primary" data-action="add-recipe"><i class="fas fa-plus"></i> Tambah</button></div><div class="item-list">${listHTML}</div></div>`;
            },
            'recipeEditor': (recipeName = null) => {
                const isEditing = recipeName != null; const { recipes, masterItems } = RestoApp.AppState; const recipe = isEditing ? recipes[recipeName] : { unit: '', ingredients: [] };
                const itemOptions = masterItems.sort((a, b) => a.name.localeCompare(b.name)).map(item => `<option value="${item.id}">${item.name} (${item.unit})</option>`).join('');
                let ingredientsHTML = recipe.ingredients.map(ing => { const item = masterItems.find(mi => mi.id === ing.itemId); return `<div class="item-row ingredient-item" data-item-id="${ing.itemId}"><span>${item ? item.name : 'N/A'}</span><input type="number" class="form-control" value="${ing.qty}" step="any" min="0"><div><span>${item ? item.unit : ''}</span><button class="btn btn-sm btn-danger" data-action="remove-ingredient" aria-label="Hapus Bahan"><i class="fas fa-trash"></i></button></div></div>`; }).join('');
                return `<div class="card"><div class="card-header"><h2 class="card-title">${isEditing ? 'Edit' : 'Tambah'} Resep</h2><button class="btn btn-sm" data-page="page-manager-recipes">Kembali</button></div>
                    <div class="form-group"><label class="form-label">Nama Menu</label><input type="text" id="recipe-name" class="form-control" value="${isEditing ? recipeName : ''}" ${isEditing ? 'readonly' : ''}></div>
                    <div class="form-group"><label class="form-label">Satuan Hasil</label><input type="text" id="recipe-unit" class="form-control" value="${recipe.unit}"></div>
                    <div class="card"><h3 class="card-title">Bahan</h3><div id="ingredients-list">${ingredientsHTML}</div><div style="margin-top:1rem;padding-top:1rem;border-top:1px dashed #ccc;display:grid;grid-template-columns:2fr 1fr auto;gap:10px;align-items:center;"><select id="new-ingredient-item" class="form-control">${itemOptions}</select><input type="number" id="new-ingredient-qty" class="form-control" placeholder="Jumlah"><button class="btn btn-primary" data-action="add-ingredient">+</button></div></div>
                    <button class="btn btn-primary" style="width:100%;margin-top:1rem;" data-action="save-recipe" data-original-name="${isEditing ? recipeName : ''}">Simpan</button></div>`;
            },
            'page-manager-display': () => {
                const { masterItems, recipes, menuKeluarActive, gudangItemIds } = RestoApp.AppState;
                const menuCheckboxes = Object.keys(recipes).sort().map(name => `<label><input type="checkbox" data-type="menu" value="${name}" ${menuKeluarActive.includes(name) ? 'checked' : ''}> ${name}</label>`).join('');
                const gudangCheckboxes = masterItems.filter(item => item.category === 'Gudang' || item.category === 'Operasional').sort((a,b)=>a.name.localeCompare(b.name)).map(item => `<label><input type="checkbox" data-type="gudang" value="${item.id}" ${gudangItemIds.includes(item.id) ? 'checked' : ''}> ${item.name}</label>`).join('');
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Atur Tampilan</span></div><button class="btn btn-sm" data-page="page-manager-area">Kembali</button></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div style="display:flex;flex-direction:column;gap:0.5rem;"><h4>Menu Keluar</h4>${menuCheckboxes || 'Tidak ada resep.'}</div>
                    <div style="display:flex;flex-direction:column;gap:0.5rem;"><h4>Ambil Gudang</h4>${gudangCheckboxes || 'Tidak ada item gudang.'}</div>
                </div>
                <button class="btn btn-primary" style="margin-top:1rem;" data-action="save-display-config">Simpan</button></div>`;
            },
            'page-manager-backup': () => `<div class="card"><div class="card-header"><div class="card-title"><span>Cadangkan Data</span></div><button class="btn btn-sm" data-page="page-manager-area">Kembali</button></div><p>Simpan atau muat semua data dari file JSON. Import akan menimpa data saat ini.</p><div style="display:flex; gap:10px;"><button class="btn btn-primary" data-action="export-data">Export</button><button class="btn btn-warning" data-action="import-data">Import</button></div></div>`,
        }
    },
    
    Events: {
        handle(event) {
            const target = event.target.closest('[data-action], [data-page]'); if (!target) return;
            event.preventDefault(); const { action, page, ...data } = target.dataset;
            if (page) { RestoApp.UI.renderPage(page); return; }
            if (action) { 
                const handler = RestoApp.Events.ActionHandlers[action]; 
                if (handler) {
                    const isAsync = handler.constructor.name === 'AsyncFunction';
                    if (isAsync && event.target.tagName === 'BUTTON') {
                        RestoApp.Utils.handleAsyncButton(event.target, () => handler({ target, ...data }));
                    } else {
                        handler({ target, ...data });
                    }
                }
            }
        },
        ActionHandlers: {
            'logout': () => RestoApp.Auth.logout(),
            'toggle-sidebar': () => document.getElementById('sidebar').classList.toggle('open'),
            'show-low-stock-modal': () => RestoApp.UI.showLowStockModal(),
            'close-modal': ({target}) => { if (target.classList.contains('modal-backdrop') || target.closest('.modal-close-btn')) RestoApp.UI.closeModal(); },
            'save-shopping-list': async () => {
                const items = Array.from(document.querySelectorAll('#page-input-belanja input[data-item-id]')).map(input => ({ id: parseInt(input.dataset.itemId), qty: parseFloat(input.value) })).filter(item => item.qty > 0);
                if (items.length === 0) return RestoApp.UI.showToast('List belanja kosong.', 'info');
                const shoppingLists = RestoApp.AppState.shoppingLists || []; shoppingLists.push({ date: new Date().toISOString(), items });
                await RestoApp.API.setKey('shoppingLists', shoppingLists); RestoApp.UI.showToast('List belanja disimpan!', 'success'); RestoApp.UI.renderPage('page-dashboard');
            },
            'select-pending-list': ({date}) => RestoApp.UI.renderPage('page-input-belanja-datang', date),
            'process-stock-in': async ({date}) => {
                const shoppingList = RestoApp.AppState.shoppingLists.find(l => l.date === date); let { masterItems, stockTransactions } = RestoApp.AppState;
                shoppingList.items.forEach(item => {
                    const qtyReceived = parseFloat(document.getElementById(`stockin-${item.id}`).value);
                    if (qtyReceived > 0) {
                        const itemIndex = masterItems.findIndex(mi => mi.id === item.id);
                        if (itemIndex > -1) {
                            const stockIncrease = qtyReceived * (masterItems[itemIndex].purchaseUnitConversion || 1); masterItems[itemIndex].stock = (masterItems[itemIndex].stock || 0) + stockIncrease;
                            stockTransactions.push({ date: new Date().toISOString(), itemId: item.id, type: 'Stok Masuk', change: stockIncrease, newStock: masterItems[itemIndex].stock });
                        }
                    }
                });
                await RestoApp.API.set({ shoppingLists: RestoApp.AppState.shoppingLists.filter(l => l.date !== date), masterItems, stockTransactions });
                RestoApp.UI.showToast('Stok diperbarui!', 'success'); RestoApp.UI.renderPage('page-dashboard');
            },
            'cancel-shopping-list': async ({date}) => { if (!confirm('Batalkan list ini?')) return; await RestoApp.API.setKey('shoppingLists', RestoApp.AppState.shoppingLists.filter(l => l.date !== date)); RestoApp.UI.showToast('List belanja dibatalkan.', 'success');},
            'process-stock-out': async () => {
                const type = document.getElementById('stockout-list').dataset.type; let { masterItems, recipes, stockTransactions } = RestoApp.AppState; const txDate = new Date().toISOString();
                document.querySelectorAll('#stockout-list input[data-name]').forEach(input => {
                    const qty = parseFloat(input.value); if (qty > 0) { const itemName = input.dataset.name;
                        if (type === 'menu') {
                            stockTransactions.push({ date: txDate, itemId: null, type: 'Produksi Menu', change: qty, newStock: null, details: itemName });
                            recipes[itemName].ingredients.forEach(ing => {
                                const itemIndex = masterItems.findIndex(mi => mi.id === ing.itemId); if (itemIndex > -1) {
                                    const stockDecrease = ing.qty * qty; masterItems[itemIndex].stock -= stockDecrease;
                                    stockTransactions.push({ date: txDate, itemId: ing.itemId, type: `Menu: ${itemName}`, change: -stockDecrease, newStock: masterItems[itemIndex].stock });
                                }
                            });
                        } else {
                            const itemIndex = masterItems.findIndex(mi => mi.name === itemName); if (itemIndex > -1) {
                                masterItems[itemIndex].stock -= qty;
                                stockTransactions.push({ date: txDate, itemId: masterItems[itemIndex].id, type: 'Gudang', change: -qty, newStock: masterItems[itemIndex].stock });
                            }
                        }
                    }
                });
                await RestoApp.API.set({ masterItems, stockTransactions }); 
                RestoApp.UI.showToast('Stok dikeluarkan!', 'success'); 
                document.querySelectorAll('#stockout-list input').forEach(input => input.value = ''); // Reset form
            },
            'save-item': async () => {
                const newName = document.getElementById('item-name').value.trim(); const id = document.getElementById('edit-item-id').value;
                if (!newName) return RestoApp.UI.showToast('Nama harus diisi!', 'error');
                const isNameDuplicate = RestoApp.AppState.masterItems.some(item => item.name.toLowerCase() === newName.toLowerCase() && item.id != id);
                if (isNameDuplicate) return RestoApp.UI.showToast(`Nama barang "${newName}" sudah ada.`, 'error');

                const newItemData = {
                    name: newName, category: document.getElementById('item-category').value.trim() || 'Lainnya', unit: document.getElementById('item-unit').value.trim(), 
                    purchaseUnit: document.getElementById('item-purchase-unit').value.trim() || document.getElementById('item-unit').value.trim(), 
                    purchaseUnitConversion: parseFloat(document.getElementById('item-conversion').value) || 1, minStock: parseFloat(document.getElementById('item-min-stock').value) || 0
                };
                let masterItems = RestoApp.AppState.masterItems;
                if (id) {
                    const index = masterItems.findIndex(i => i.id == id); masterItems[index] = { ...masterItems[index], ...newItemData };
                } else {
                    const newId = masterItems.length > 0 ? Math.max(...masterItems.map(i => i.id)) + 1 : 1;
                    masterItems.push({ ...newItemData, id: newId, stock: 0, sortOrder: masterItems.length });
                }
                await RestoApp.API.setKey('masterItems', masterItems); 
                RestoApp.UI.showToast('Barang disimpan!', 'success'); 
                RestoApp.Events.ActionHandlers['cancel-edit'](); // Reset form
            },
            'edit-item': ({id}) => {
                const item = RestoApp.AppState.masterItems.find(i => i.id == id); if(!item) return;
                document.getElementById('edit-item-id').value = item.id; document.getElementById('item-name').value = item.name; document.getElementById('item-category').value = item.category; document.getElementById('item-unit').value = item.unit; document.getElementById('item-purchase-unit').value = item.purchaseUnit; document.getElementById('item-conversion').value = item.purchaseUnitConversion; document.getElementById('item-min-stock').value = item.minStock;
                document.getElementById('save-item-btn').innerHTML = 'Update'; document.getElementById('cancel-edit-btn').style.display = 'inline-flex';
                document.getElementById('item-name').focus();
            },
            'cancel-edit': () => { document.getElementById('add-item-form').reset(); document.getElementById('edit-item-id').value = ''; document.getElementById('save-item-btn').innerHTML = 'Simpan'; document.getElementById('cancel-edit-btn').style.display = 'none'; },
            'delete-item': async ({id}) => {
                const item = RestoApp.AppState.masterItems.find(i => i.id == id);
                if ((item.stock || 0) > 0) return RestoApp.UI.showToast('Tidak bisa hapus, barang masih ada stok.', 'error');
                if (Object.values(RestoApp.AppState.recipes).some(r => r.ingredients.some(i => i.itemId == id))) return RestoApp.UI.showToast(`Gagal! "${item.name}" masih digunakan di resep.`, 'error');
                if (!confirm(`Hapus "${item.name}"?`)) return; 
                await RestoApp.API.setKey('masterItems', RestoApp.AppState.masterItems.filter(i => i.id != id)); RestoApp.UI.showToast('Barang dihapus.', 'success');
            },
            'save-item-order': async () => {
                const masterItems = [...RestoApp.AppState.masterItems]; document.querySelectorAll('#db-editor-tbody tr').forEach((row, index) => { const item = masterItems.find(i => i.id == row.dataset.id); if (item) item.sortOrder = index; });
                await RestoApp.API.setKey('masterItems', masterItems); RestoApp.UI.showToast('Urutan disimpan!', 'success');
            },
            'add-recipe': () => RestoApp.UI.renderPage('page-manager-recipes', 'new'),
            'edit-recipe': ({name}) => RestoApp.UI.renderPage('page-manager-recipes', name),
            'delete-recipe': async ({name}) => {
                if (!confirm(`Hapus resep "${name}"?`)) return; let { recipes, menuKeluarActive } = RestoApp.AppState;
                delete recipes[name]; menuKeluarActive = menuKeluarActive.filter(menu => menu !== name);
                await RestoApp.API.set({ recipes, menuKeluarActive }); RestoApp.UI.showToast('Resep dihapus.', 'success');
            },
            'add-ingredient': () => {
                const list = document.getElementById('ingredients-list'); const itemId = document.getElementById('new-ingredient-item').value; const qty = parseFloat(document.getElementById('new-ingredient-qty').value);
                if (!itemId || !(qty > 0)) return RestoApp.UI.showToast('Pilih barang dan isi jumlah.', 'error');
                const item = RestoApp.AppState.masterItems.find(mi => mi.id == itemId); const newIngredientHTML = document.createElement('div');
                newIngredientHTML.className = 'item-row ingredient-item'; newIngredientHTML.dataset.itemId = item.id;
                newIngredientHTML.innerHTML = `<span>${item.name}</span><input type="number" class="form-control" value="${qty}" step="any" min="0"><div><span>${item.unit}</span><button class="btn btn-sm btn-danger" data-action="remove-ingredient"><i class="fas fa-trash"></i></button></div>`;
                list.appendChild(newIngredientHTML); document.getElementById('new-ingredient-qty').value = '';
            },
            'remove-ingredient': ({target}) => target.closest('.ingredient-item').remove(),
            'save-recipe': async ({target}) => {
                const originalName = target.dataset.originalName; const newName = document.getElementById('recipe-name').value.trim(); const unit = document.getElementById('recipe-unit').value.trim();
                if (!newName || !unit) throw new Error('Nama dan satuan resep harus diisi.');
                const ingredients = Array.from(document.querySelectorAll('.ingredient-item')).map(el => ({ itemId: parseInt(el.dataset.itemId), qty: parseFloat(el.querySelector('input').value) }));
                if (ingredients.length === 0) throw new Error('Resep harus memiliki minimal 1 bahan.');
                let { recipes, menuKeluarActive } = RestoApp.AppState; if (originalName !== 'new' && recipes[newName]) throw new Error('Nama menu sudah ada.');
                if (originalName && originalName !== 'new' && originalName !== newName) { delete recipes[originalName]; menuKeluarActive = menuKeluarActive.map(m => m === originalName ? newName : m); }
                recipes[newName] = { unit, ingredients }; if (originalName === 'new' && !menuKeluarActive.includes(newName)) menuKeluarActive.push(newName);
                await RestoApp.API.set({ recipes, menuKeluarActive }); 
                RestoApp.UI.showToast(`Resep "${newName}" disimpan.`, 'success'); 
                RestoApp.UI.renderPage('page-manager-recipes');
            },
            'save-display-config': async () => {
                const container = document.querySelector('.card > div[style*="grid-template-columns:1fr 1fr"]');
                const menuKeluarActive = Array.from(container.querySelectorAll('input[data-type="menu"]:checked')).map(cb => cb.value); const gudangItemIds = Array.from(container.querySelectorAll('input[data-type="gudang"]:checked')).map(cb => parseInt(cb.value));
                await RestoApp.API.set({ menuKeluarActive, gudangItemIds }); RestoApp.UI.showToast('Tampilan disimpan!', 'success');
            },
            'export-data': () => {
                const dataToExport = { ...RestoApp.AppState };
                ['currentUser', 'isDataLoaded', 'unsubscribe'].forEach(key => delete dataToExport[key]); // Hapus state sementara
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                a.download = `restoapp_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
            },
            'import-data': () => {
                const fileInput = document.getElementById('import-file-input');
                fileInput.onchange = e => { const file = e.target.files[0]; if (!file || !confirm("PERINGATAN: Ini akan menimpa semua data Anda saat ini. Lanjutkan?")) return;
                    const reader = new FileReader();
                    reader.onload = async event => {
                        try {
                            const data = JSON.parse(event.target.result); await RestoApp.API.set(data);
                            RestoApp.UI.showToast('Impor berhasil! Memuat ulang...', 'success'); setTimeout(() => window.location.reload(), 1500);
                        } catch (error) { RestoApp.UI.showToast('Gagal impor: ' + error.message, 'error'); }
                    };
                    reader.readAsText(file);
                };
                fileInput.click();
            },
        },
    },

    App: {
        init() {
            RestoApp.Auth.listen();
            document.addEventListener('submit', (e) => {
                if (e.target.id === 'login-form') {
                    e.preventDefault(); 
                    const button = e.target.querySelector('button[type="submit"]');
                    const errorEl = document.getElementById('login-error');
                    errorEl.style.display = 'none';
                    RestoApp.Utils.handleAsyncButton(button, async () => {
                        try {
                            await RestoApp.Auth.login(document.getElementById('email').value, document.getElementById('password').value);
                        } catch(error) {
                            errorEl.textContent = "Login Gagal: Periksa kembali email dan password Anda.";
                            errorEl.style.display = 'block';
                            throw error; // Lempar error agar handleAsyncButton tahu ada kegagalan
                        }
                    });
                }
            });
            document.addEventListener('click', (e) => RestoApp.Events.handle(e));
            window.addEventListener('hashchange', () => RestoApp.UI.renderPage(location.hash.substring(1) || 'page-dashboard'));
        },
        initOnLogin() {
            RestoApp.UI.renderSidebar();
            RestoApp.API.listenToData();
        },
    }
};

RestoApp.App.init();
</script>
</body>
</html>
