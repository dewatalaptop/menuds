<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoApp - V3.2 (Stable)</title>
    <style>
        /* --- Import Font --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        /* --- Reset & Global Styles --- */
        :root {
            --primary-color: #4a7c59; /* Muted Green */
            --secondary-color: #f4f4f4; /* Light Gray */
            --text-color: #333333;
            --white-color: #ffffff;
            --border-color: #e0e0e0;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: var(--white-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        header {
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 20px;
            text-align: center;
        }

        header h1 {
            font-weight: 600;
            font-size: 1.5rem;
        }
        
        main {
            padding: 20px;
        }

        /* --- Page Styles --- */
        .page {
            display: none; /* Hidden by default */
        }

        .page.active {
            display: block;
        }
        
        /* --- LocalStorage Warning --- */
        .storage-warning {
            background-color: var(--warning-color);
            color: #333;
            padding: 10px 20px;
            font-size: 0.85rem;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        /* --- Toast Notification --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: var(--primary-color); }
        .toast.error { background-color: var(--danger-color); }


        /* --- Dashboard & Buttons Styles --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .dashboard-button, .list-item-button {
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--text-color);
            height: 120px;
        }
        .list-item-button {
            height: auto;
            align-items: flex-start;
            text-align: left;
        }

        .dashboard-button:hover, .list-item-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .dashboard-button .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary-color);
            pointer-events: none;
        }

        .dashboard-button span {
            font-weight: 500;
            font-size: 0.9rem;
            pointer-events: none; /* Agar klik tetap terdeteksi di parent */
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .page-header h2 { color: var(--primary-color); font-size: 1.2rem; }

        .btn {
            background-color: var(--primary-color);
            color: var(--white-color);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-secondary { background-color: #aaa; }
        .btn-danger { background-color: var(--danger-color); }
        .btn:hover { background-color: #3a6347; }
        .btn-danger:hover { background-color: #a71d2a; }
        
        .category-group {
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
        }

        .category-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .item-row {
            display: grid;
            grid-template-columns: minmax(0, 2fr) 100px 100px; 
            gap: 10px;
            align-items: start;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .item-row label { line-height: 1.4; word-wrap: break-word; }

        .item-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        
        .copy-button {
            background-color: #007BFF;
            color: white;
            padding: 8px 12px;
            font-size: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .copy-button:hover { background-color: #0056b3; }

        .table-container { overflow-x: auto; }
        #db-editor-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #db-editor-table th, #db-editor-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
            font-size: 0.9rem;
            vertical-align: top;
        }
        #db-editor-table th { background-color: #f8f8f8; }

        .action-btn {
            padding: 5px 8px;
            font-size: 0.8rem;
            margin-right: 5px;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            color: white;
        }
        .edit-btn { background-color: var(--warning-color); color:#333; }
        .delete-btn { background-color: var(--danger-color); }

        #add-item-form, #recipe-editor-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            border: 1px dashed var(--border-color);
            border-radius: var(--border-radius);
        }
        #add-item-form input, #recipe-editor-form input, #recipe-editor-form select { padding: 8px; border-radius:6px; border: 1px solid var(--border-color); }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: monospace;
            margin-top: 10px;
        }
        
        /* Gaya untuk editor list menu */
        .menu-list-editor {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 8px;
        }
        .menu-list-editor label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="toast-container"></div>
        <div class="storage-warning">
            ‚ö†Ô∏è <strong>Peringatan:</strong> Aplikasi ini menyimpan data di browser Anda. Membersihkan cache akan menghapus semua data.
        </div>
        <header>
            <h1>RestoApp V3.2</h1>
        </header>
        <main id="main-content">
            <div id="page-dashboard" class="page active">
                <div class="dashboard-grid">
                    <a href="#" class="dashboard-button" data-page="page-input-belanja-datang">
                        <div class="icon">üì•</div>
                        <span>Input Belanja Datang</span>
                    </a>
                    <a href="#" class="dashboard-button" data-page="page-input-menu-keluar">
                        <div class="icon">üç≤</div>
                        <span>Input Menu Keluar</span>
                    </a>
                     <a href="#" class="dashboard-button" data-page="page-ambil-gudang">
                        <div class="icon">üì¶</div>
                        <span>Ambil dari Gudang</span>
                    </a>
                    <a href="#" class="dashboard-button" data-page="page-input-belanja">
                        <div class="icon">üõí</div>
                        <span>Input List Belanja</span>
                    </a>
                    <a href="#" class="dashboard-button" data-action="show-alert" data-message="Fitur ini sedang dalam pengembangan.">
                        <div class="icon">üìà</div>
                        <span>Input Total Penjualan</span>
                    </a>
                    <a href="#" class="dashboard-button" data-action="show-alert" data-message="Fitur ini sedang dalam pengembangan.">
                        <div class="icon">üóëÔ∏è</div>
                        <span>Input Waste</span>
                    </a>
                    <a href="#" class="dashboard-button" data-page="page-manager-area">
                        <div class="icon">üëë</div>
                        <span>Manager Area</span>
                    </a>
                </div>
                 <div style="text-align:center; margin-top: 20px; font-size: 0.8rem; color: #888;">
                    <p>Waktu saat ini: <span id="current-time"></span></p>
                </div>
            </div>
            <div id="page-input-belanja" class="page"></div>
            <div id="page-rangkuman-belanja" class="page"></div>
            <div id="page-input-belanja-datang" class="page"></div>
            <div id="page-input-menu-keluar" class="page"></div>
            <div id="page-ambil-gudang" class="page"></div>
            <div id="page-manager-area" class="page"></div>
        </main>
    </div>

<script>
const App = {
    data: {
        initialMasterItems: [
            { id: 1, name: "Kolbis", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 2, name: "Labu Siam", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 3, name: "Jagung Manis", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 4, name: "Pare", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 5, name: "Kangkung", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 6, name: "Kentang", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 7, name: "Wortel", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 8, name: "Daun Bawang", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 9, name: "Kacang Panjang", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 10, name: "Cabe Plintir Merah", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 11, name: "Cabe Plintir Ijo", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 12, name: "Cabe Ceplus", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 13, name: "Cabe Rawit Merah", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 14, name: "Cabe Teropong Merah", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 15, name: "Cabe Teropong Hijau", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 16, name: "Tomat Merah", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 17, name: "Tomat Hijau", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 18, name: "Timun", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 19, name: "Brokoli", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 20, name: "Sawi Bakso", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 21, name: "Kembang Kol", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 22, name: "Kapri", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 23, name: "Buncis", category: "Sayur", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 24, name: "Seledri", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 25, name: "Terong", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 26, name: "Paha Tepong (1kg/4pcs)", category: "Ayam", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 27, name: "Paha Bawah (1kg/8pcs)", category: "Ayam", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 28, name: "Tepong (1kg/6pcs)", category: "Ayam", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 29, name: "Fillet Paha Tepong", category: "Ayam", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 30, name: "Fillet Dada", category: "Ayam", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 31, name: "Ayam Kampung", category: "Bebek dan ayam kampung", unit: "ekor", purchaseUnit: "ekor", purchaseUnitConversion: 1, stock: 0 },
            { id: 32, name: "Bebek", category: "Bebek dan ayam kampung", unit: "ekor", purchaseUnit: "ekor", purchaseUnitConversion: 1, stock: 0 },
            { id: 33, name: "Blue Band", category: "Keringan", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 60, stock: 0 },
            { id: 34, name: "Mie Atom Bulan", category: "Keringan", unit: "bungkus", purchaseUnit: "dus", purchaseUnitConversion: 20, stock: 0 },
            { id: 35, name: "Bihun Padamu", category: "Keringan", unit: "bungkus", purchaseUnit: "bal", purchaseUnitConversion: 12, stock: 0 },
            { id: 36, name: "Gula Pasir", category: "Keringan", unit: "kg", purchaseUnit: "karung", purchaseUnitConversion: 50, stock: 0 },
            { id: 37, name: "Tepung Segitiga", category: "Keringan", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 12, stock: 0 },
            { id: 38, name: "Kara", category: "Keringan", unit: "pcs", purchaseUnit: "dus", purchaseUnitConversion: 32, stock: 0 },
            { id: 39, name: "Kecap", category: "Keringan", unit: "pouch", purchaseUnit: "dus", purchaseUnitConversion: 12, stock: 0 },
            { id: 40, name: "Sunlight", category: "Keringan", unit: "pouch", purchaseUnit: "dus", purchaseUnitConversion: 12, stock: 0 },
            { id: 41, name: "Hemart", category: "Keringan", unit: "botol", purchaseUnit: "dus", purchaseUnitConversion: 12, stock: 0 },
            { id: 42, name: "Micin Koki", category: "Keringan", unit: "pcs", purchaseUnit: "dus", purchaseUnitConversion: 20, stock: 0 },
            { id: 43, name: "Royco Sapi", category: "Keringan", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 24, stock: 0 },
            { id: 44, name: "Tepung Pisang Sasa", category: "Keringan", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 24, stock: 0 },
            { id: 45, name: "Garam Kapal", category: "Keringan", unit: "pcs", purchaseUnit: "bal", purchaseUnitConversion: 40, stock: 0 },
            { id: 46, name: "Kobe Ayam Krispy", category: "Keringan", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 12, stock: 0 },
            { id: 47, name: "Telur Waringin", category: "Keringan", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 48, name: "Tepung Tapioka (Kanji)", category: "Keringan", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 20, stock: 0 },
            { id: 49, name: "Nila", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 50, name: "Lele", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 51, name: "Belut", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 52, name: "Kecap Ikan", category: "Belanja Pusat", unit: "botol", purchaseUnit: "botol", purchaseUnitConversion: 1, stock: 0 },
            { id: 53, name: "Cuka Dixi", category: "Belanja Pusat", unit: "botol", purchaseUnit: "botol", purchaseUnitConversion: 1, stock: 0 },
            { id: 54, name: "Kerupuk Udang Besar", category: "Belanja Pusat", unit: "kg", purchaseUnit: "dus", purchaseUnitConversion: 5, stock: 0 },
            { id: 55, name: "Kerupuk Bawang", category: "Belanja Pusat", unit: "kg", purchaseUnit: "bal", purchaseUnitConversion: 5, stock: 0 },
            { id: 56, name: "Saus Tiram", category: "Belanja Pusat", unit: "botol", purchaseUnit: "dus", purchaseUnitConversion: 12, stock: 0 },
            { id: 57, name: "Saus Inggris", category: "Belanja Pusat", unit: "botol", purchaseUnit: "dus", purchaseUnitConversion: 12, stock: 0 },
            { id: 58, name: "Tepung Panir Coklat", category: "Belanja Pusat", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 10, stock: 0 },
            { id: 59, name: "Ikan Asin Jambal", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 60, name: "Merica Gelondongan", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 61, name: "Pala", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 62, name: "Bawang Bombay", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 63, name: "Tahu Pong", category: "Belanja Pusat", unit: "pcs", purchaseUnit: "kantong", purchaseUnitConversion: 50, stock: 0 },
            { id: 64, name: "Tauge", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 65, name: "Bawang Putih", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 66, name: "Bawang Merah", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 67, name: "Tahu Kulit", category: "Belanja Pusat", unit: "pcs", purchaseUnit: "kantong", purchaseUnitConversion: 50, stock: 0 },
            { id: 68, name: "Tempe", category: "Belanja Pusat", unit: "pcs", purchaseUnit: "papan", purchaseUnitConversion: 1, stock: 0 },
            { id: 69, name: "Kelapa Gelondong", category: "Belanja Pusat", unit: "pcs", purchaseUnit: "pcs", purchaseUnitConversion: 1, stock: 0 },
            { id: 70, name: "Daging Sapi Giling", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 71, name: "Daging Ayam Giling", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 72, name: "Mangut", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 73, name: "Kemangi", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 74, name: "Sereh", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 75, name: "Teri", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 76, name: "Kemiri", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 77, name: "Cumi Kering", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 78, name: "Kacang Tanah Kupas", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 79, name: "Lengkuas", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 80, name: "Kencur", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 81, name: "Kunyit", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 82, name: "Daun Melinjo", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 83, name: "Bunga Pepaya", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 84, name: "Daun Pepaya", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 85, name: "Jantung Pisang", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 86, name: "Krecek Sum", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 87, name: "Salam", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 88, name: "Pandan", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 89, name: "Daun Jeruk", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 90, name: "Bandeng", category: "Belanja Pusat", unit: "ekor", purchaseUnit: "ekor", purchaseUnitConversion: 1, stock: 0 },
            { id: 91, name: "Maizena", category: "Belanja Pusat", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 18, stock: 0 },
            { id: 92, name: "Daun Pisang", category: "Belanja Pusat", unit: "lempit", purchaseUnit: "lempit", purchaseUnitConversion: 1, stock: 0 },
            { id: 93, name: "Sunco", category: "Belanja Pusat", unit: "pouch", purchaseUnit: "dus", purchaseUnitConversion: 6, stock: 0 },
            { id: 94, name: "Bumbu Rendang Indofood", category: "Belanja Pusat", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 24, stock: 0 },
            { id: 95, name: "Jamur Kaleng", category: "Belanja Pusat", unit: "pcs", purchaseUnit: "dus", purchaseUnitConversion: 24, stock: 0 },
            { id: 96, name: "Jamur Putih Kering", category: "Belanja Pusat", unit: "pack", purchaseUnit: "pack", purchaseUnitConversion: 1, stock: 0 },
            { id: 97, name: "Ebi", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 98, name: "Tetelan", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 99, name: "Kikil", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 100, name: "Babat", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 101, name: "Udang Rawakecil", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 102, name: "Bleng", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 103, name: "Gula Aren", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 104, name: "Brambang Goreng", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 105, name: "Iga Sapi Potong", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 106, name: "Kakap Fillet", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 107, name: "Jahe", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 108, name: "Pisang", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 109, name: "Tepung Beras", category: "Keringan", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 20, stock: 0 },
            { id: 110, name: "Adonan Gilingan Bakso", category: "Belanja Pusat", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 111, name: "Gas", category: "Supplier lainnya", unit: "tabung", purchaseUnit: "tabung", purchaseUnitConversion: 1, stock: 0 },
            { id: 112, name: "Beras", category: "Supplier lainnya", unit: "kg", purchaseUnit: "sak", purchaseUnitConversion: 25, stock: 0 }, 
            { id: 113, name: "Es Krim Durian AG26", category: "Supplier lainnya", unit: "pcs", purchaseUnit: "dus", purchaseUnitConversion: 50, stock: 0 },
            { id: 114, name: "Roti Bluder", category: "Supplier Snack dll", unit: "pack", purchaseUnit: "pack", purchaseUnitConversion: 1, stock: 0 },
            { id: 115, name: "Chikuwa", category: "Frozen food", unit: "pack", purchaseUnit: "pack", purchaseUnitConversion: 1, stock: 0 },
            { id: 116, name: "Dumpling", category: "Frozen food", unit: "pack", purchaseUnit: "pack", purchaseUnitConversion: 1, stock: 0 },
            { id: 117, name: "Odeng", category: "Frozen food", unit: "pack", purchaseUnit: "pack", purchaseUnitConversion: 1, stock: 0 },
            { id: 118, name: "Sosis Besar Salam", category: "Frozen food", unit: "pcs", purchaseUnit: "pack", purchaseUnitConversion: 10, stock: 0 },
            { id: 119, name: "Sosis Merah", category: "Frozen food", unit: "pcs", purchaseUnit: "pack", purchaseUnitConversion: 20, stock: 0 },
            { id: 120, name: "Otak-otak Singapore", category: "Frozen food", unit: "pack", purchaseUnit: "pack", purchaseUnitConversion: 1, stock: 0 },
            { id: 121, name: "Salmon Fish Cake", category: "Frozen food", unit: "pack", purchaseUnit: "pack", purchaseUnitConversion: 1, stock: 0 },
            { id: 122, name: "Mazzoni Saus Lada Hitam", category: "Frozen food", unit: "pack", purchaseUnit: "pack", purchaseUnitConversion: 1, stock: 0 },
            { id: 123, name: "Koki Jempol Kuah Suki", category: "Frozen food", unit: "pack", purchaseUnit: "pack", purchaseUnitConversion: 1, stock: 0 },
            { id: 124, name: "Delmonte Saus Tomat", category: "Frozen food", unit: "derigen", purchaseUnit: "derigen", purchaseUnitConversion: 1, stock: 0 },
            { id: 125, name: "Delmonte Saus Cabe", category: "Frozen food", unit: "derigen", purchaseUnit: "derigen", purchaseUnitConversion: 1, stock: 0 },
            { id: 126, name: "Naruna Coffee", category: "Belanja Bar", unit: "botol", purchaseUnit: "botol", purchaseUnitConversion: 1, stock: 0 },
            { id: 127, name: "Galon Java", category: "Belanja Bar", unit: "galon", purchaseUnit: "galon", purchaseUnitConversion: 1, stock: 0 },
            { id: 128, name: "Cleo Botol Tanggung", category: "Belanja Bar", unit: "botol", purchaseUnit: "dus", purchaseUnitConversion: 24, stock: 0 },
            { id: 129, name: "Cleo Cup", category: "Belanja Bar", unit: "cup", purchaseUnit: "box", purchaseUnitConversion: 48, stock: 0 },
            { id: 130, name: "Good Day Cappucino", category: "Belanja Bar", unit: "pcs", purchaseUnit: "pack", purchaseUnitConversion: 30, stock: 0 },
            { id: 131, name: "Kopi Hitam", category: "Belanja Bar", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 132, name: "Diamond Fresh Milk", category: "Belanja Bar", unit: "pack", purchaseUnit: "dus", purchaseUnitConversion: 12, stock: 0 },
            { id: 133, name: "Susu Kental Manis Coklat", category: "Belanja Bar", unit: "pcs", purchaseUnit: "pack", purchaseUnitConversion: 6, stock: 0 },
            { id: 134, name: "Susu Kental Manis Putih", category: "Belanja Bar", unit: "pcs", purchaseUnit: "pack", purchaseUnitConversion: 6, stock: 0 },
            { id: 135, name: "Jeruk", category: "Belanja Bar", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 136, name: "Buah Naga", category: "Belanja Bar", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 137, name: "Alpukat", category: "Belanja Bar", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 138, name: "Lemon", category: "Belanja Bar", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 },
            { id: 139, name: "Mangga", category: "Belanja Bar", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0 }
        ],
        initialRecipes: {
            "Nila": { unit: "pcs", ingredients: [{ itemId: 49, qty: 0.25 }] }, "Lele": { unit: "pcs", ingredients: [{ itemId: 50, qty: 0.16 }] },
            "Belut": { unit: "pcs", ingredients: [{ itemId: 51, qty: 0.2 }] }, "Paha Tepong": { unit: "pcs", ingredients: [{ itemId: 26, qty: 0.25 }] },
            "Paha Bawah": { unit: "pcs", ingredients: [{ itemId: 27, qty: 0.125 }] }, "Paha Atas": { unit: "pcs", ingredients: [{ itemId: 28, qty: 0.167 }] },
            "Ayam Kampung": { unit: "pcs", ingredients: [{ itemId: 31, qty: 1 }] }, "Tahu Kulit": { unit: "pcs", ingredients: [{ itemId: 67, qty: 1 }] },
            "Ayam Geprek": { unit: "pcs", ingredients: [{ itemId: 30, qty: 0.15 }, { itemId: 46, qty: 0.05 }] }, 
            "Telur": { unit: "pcs", ingredients: [{ itemId: 47, qty: 0.06 }] }, "Babat": { unit: "pcs", ingredients: [{ itemId: 100, qty: 0.1 }] }, 
            "Kikil": { unit: "pcs", ingredients: [{ itemId: 99, qty: 0.1 }] }, "Tetelan": { unit: "pcs", ingredients: [{ itemId: 98, qty: 0.1 }] },
            "Sosis Besar": { unit: "pcs", ingredients: [{ itemId: 118, qty: 1 }] }, "Salmon Fish Cake": { unit: "pcs", ingredients: [{ itemId: 121, qty: 0.2 }] },
            "Otak-otak Singapore": { unit: "pcs", ingredients: [{ itemId: 120, qty: 0.2 }] }, "Sosis Merah": { unit: "pcs", ingredients: [{ itemId: 119, qty: 1 }] },
        },
        initialGudangItemIds: [34, 35, 37, 44, 38, 40, 41, 42, 45, 46, 91, 93, 109, 48, 33]
    },
    
    db: {
        get: (key) => JSON.parse(localStorage.getItem(key)),
        set: (key, value) => localStorage.setItem(key, JSON.stringify(value))
    },

    init() {
        if (!this.db.get('masterItems')) this.db.set('masterItems', this.data.initialMasterItems);
        if (!this.db.get('recipes')) this.db.set('recipes', this.data.initialRecipes);
        if (!this.db.get('gudangItemIds')) this.db.set('gudangItemIds', this.data.initialGudangItemIds);
        const recipes = this.db.get('recipes');
        if (!this.db.get('menuKeluarActive')) this.db.set('menuKeluarActive', Object.keys(recipes));
        if (!this.db.get('shoppingLists')) this.db.set('shoppingLists', []);
        if (!this.db.get('stockTransactions')) this.db.set('stockTransactions', []);
        
        document.getElementById('main-content').addEventListener('click', this.handle.click.bind(this));
        
        this.utils.updateTime();
        setInterval(this.utils.updateTime, 1000);
    },

    showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const page = document.getElementById(pageId);
        if (page) page.classList.add('active');
    },
    
    render: {
        page(pageId, data = null) {
            const targetPage = document.getElementById(pageId);
            if (!targetPage) return;
            
            switch (pageId) {
                case 'page-input-belanja': this.shoppingListForm(targetPage); break;
                case 'page-rangkuman-belanja': this.shoppingSummary(targetPage, data); break;
                case 'page-input-belanja-datang': this.stockInForm(targetPage); break;
                case 'page-input-menu-keluar': this.stockOutPage(targetPage, 'menu'); break;
                case 'page-ambil-gudang': this.stockOutPage(targetPage, 'gudang'); break;
                case 'page-manager-area': this.managerArea(targetPage); break;
            }
            App.showPage(pageId);
        },
        
        shoppingListForm(targetPage) {
            targetPage.innerHTML = `
                <div class="page-header"><h2>Buat List Belanja Baru</h2><button class="btn btn-secondary" data-page="page-dashboard">Kembali</button></div>
                <form id="shopping-list-form"></form>
                <button class="btn" style="width: 100%; margin-top: 20px;" data-action="generate-shopping-list">Buat Daftar Belanja</button>`;

            const masterItems = App.db.get('masterItems');
            const formContainer = document.getElementById('shopping-list-form');
            const categories = [...new Set(masterItems.map(item => item.category))].sort();
            
            categories.forEach(category => {
                let itemsHTML = '';
                masterItems.filter(item => item.category === category).forEach(item => {
                    const displayUnit = item.purchaseUnit || item.unit;
                    itemsHTML += `<div class="item-row">
                        <label for="item-${item.id}" title="${item.name}">${item.name}</label>
                        <input type="number" id="item-${item.id}" data-item-id="${item.id}" class="item-input" placeholder="Jumlah" min="0">
                        <span>${displayUnit}</span>
                    </div>`;
                });
                formContainer.innerHTML += `<div class="category-group"><h3 class="category-title">${category}</h3>${itemsHTML}</div>`;
            });
        },

        shoppingSummary(targetPage, shoppingList) {
            targetPage.innerHTML = `
                <div class="page-header"><h2>Rangkuman Belanja Siap Kirim</h2><button class="btn btn-secondary" data-page="page-input-belanja">Kembali</button></div>
                <div id="summary-container"></div>`;
                
            const masterItems = App.db.get('masterItems');
            const summaryContainer = document.getElementById('summary-container');
            
            const listItems = shoppingList.items.map(item => ({...masterItems.find(mi => mi.id === item.id), quantity: item.quantity }));
            const categories = [...new Set(listItems.map(item => item.category))].sort();

            categories.forEach(category => {
                let categoryText = `List Belanja - ${category}:\n`;
                let itemsHTML = '';
                listItems.filter(item => item.category === category).forEach(item => {
                    const displayUnit = item.purchaseUnit || item.unit;
                    const text = `* ${item.name}: ${item.quantity} ${displayUnit}`;
                    itemsHTML += `<li>${text}</li>`;
                    categoryText += `${text}\n`;
                });
                const groupDiv = document.createElement('div');
                groupDiv.className = 'category-group';
                groupDiv.innerHTML = `<h3 class="category-title">${category} <button class="copy-button" data-action="copy-text" data-text-to-copy="${escape(categoryText)}">üìã Salin</button></h3><ul style="list-style-type: none; padding-left: 10px;">${itemsHTML}</ul>`;
                summaryContainer.appendChild(groupDiv);
            });
        },

        stockInForm(targetPage) {
            const allLists = App.db.get('shoppingLists');
            const pendingLists = allLists.filter(list => list.status === 'pending');
            
            let contentHTML = `<div class="page-header"><h2>Pilih List Belanja yang Datang</h2><button class="btn btn-secondary" data-page="page-dashboard">Kembali</button></div>`;

            if (pendingLists.length === 0) {
                contentHTML += `<p>Tidak ada list belanja yang menunggu untuk dimasukkan ke stok.</p>`;
            } else {
                contentHTML += pendingLists.map(list => {
                    const date = new Date(list.date).toLocaleString('id-ID', {day: '2-digit', month: 'long', hour:'2-digit', minute:'2-digit'});
                    return `<a href="#" class="list-item-button" data-action="select-pending-list" data-date="${list.date}">
                        <strong>List Belanja ${date}</strong>
                        <p style="font-size:0.8rem; color:#555;">${list.items.length} jenis barang</p>
                    </a>`;
                }).join('');
            }
            targetPage.innerHTML = contentHTML;
        },
        
        stockInDetail(targetPage, listDate) {
            const selectedList = App.db.get('shoppingLists').find(list => list.date === listDate);
            targetPage.innerHTML = `
                <div class="page-header"><h2>Input Belanja Datang</h2><button class="btn btn-secondary" data-page="page-input-belanja-datang">Kembali</button></div>
                <form id="stock-in-form"></form>
                <button class="btn" style="width: 100%; margin-top: 20px;" data-action="process-stock-in" data-date="${listDate}">Konfirmasi Barang Masuk</button>`;

            const masterItems = App.db.get('masterItems');
            const listItems = selectedList.items.map(item => ({...masterItems.find(mi => mi.id === item.id), quantity: item.quantity }));
            const categories = [...new Set(listItems.map(item => item.category))].sort();
            
            const stockInForm = document.getElementById('stock-in-form');
            let formHTML = '';
            categories.forEach(category => {
                let itemsHTML = '';
                listItems.filter(item => item.category === category).forEach(item => {
                    const displayUnit = item.purchaseUnit || item.unit;
                    itemsHTML += `<div class="item-row">
                        <label for="stockin-${item.id}" title="${item.name}">${item.name}</label>
                        <input type="number" id="stockin-${item.id}" data-item-id="${item.id}" class="item-input" value="${item.quantity}">
                        <span>${displayUnit}</span>
                    </div>`;
                });
                formHTML += `<div class="category-group"><h3 class="category-title">${category}</h3>${itemsHTML}</div>`;
            });
            stockInForm.innerHTML = formHTML;
        },

        stockOutPage(targetPage, type) {
            const masterItems = App.db.get('masterItems');
            let itemsToRender = [];
            let title = "";

            if (type === 'gudang') {
                const gudangItemIds = App.db.get('gudangItemIds');
                title = "Ambil Barang dari Gudang";
                itemsToRender = gudangItemIds.map(id => masterItems.find(item => item.id === id)).filter(Boolean);
            } else {
                const menuKeluarActive = App.db.get('menuKeluarActive');
                const recipes = App.db.get('recipes');
                title = "Input Menu Keluar";
                itemsToRender = menuKeluarActive.map(key => ({ name: key, unit: recipes[key]?.unit || 'pcs' }));
            }

            let formHTML = '';
            itemsToRender.forEach(item => {
                formHTML += `<div class="item-row">
                    <label for="stockout-${item.name.replace(/\s+/g, '-')}" title="${item.name}">${item.name}</label>
                    <input type="number" id="stockout-${item.name.replace(/\s+/g, '-')}" class="item-input" placeholder="Jumlah" min="0">
                    <span>${item.unit}</span>
                </div>`;
            });

            targetPage.innerHTML = `
                <div class="page-header"><h2>${title}</h2><button class="btn btn-secondary" data-page="page-dashboard">Kembali</button></div>
                <div class="category-group">${formHTML}</div>
                <button class="btn" style="width:100%" data-action="process-stock-out" data-type="${type}">Proses Pengeluaran Stok</button>`;
        },

        managerArea(targetPage) {
            targetPage.innerHTML = `
                <div class="page-header"><h2>Manager Area</h2><button class="btn btn-secondary" data-page="page-dashboard">Kembali</button></div>
                <div class="category-group">
                    <h3 class="category-title">Atur Tampilan Menu & Gudang</h3>
                    <div id="menu-config-container"></div>
                </div>
                <div class="category-group">
                    <h3 class="category-title">Manajemen List Belanja</h3>
                    <div id="pending-lists-container"></div>
                </div>
                <div class="category-group">
                    <h3 class="category-title">Manajemen Resep</h3>
                    <div id="recipe-list-container"></div>
                </div>
                <div class="category-group">
                    <h3 class="category-title">Editor Database Barang</h3>
                    <div id="add-item-form"><input type="hidden" id="edit-item-id"><input class="item-input" type="text" id="item-name" placeholder="Nama Barang"><input class="item-input" type="text" id="item-category" placeholder="Kategori"><input class="item-input" type="text" id="item-unit" placeholder="Satuan Stok"><input class="item-input" type="text" id="item-purchase-unit" placeholder="Satuan Beli"><input class="item-input" type="number" id="item-conversion" placeholder="Konversi"><button class="btn" data-action="save-item">Simpan</button></div>
                    <div class="table-container"><table id="db-editor-table"><thead><tr><th>Nama</th><th>Kategori</th><th>Stok</th><th>Aksi</th></tr></thead><tbody id="db-editor-tbody"></tbody></table></div>
                </div>
                <div class="category-group">
                    <h3 class="category-title">Ekspor Data untuk Analisa</h3>
                    <p style="font-size: 0.9rem; margin-bottom: 10px;">Salin teks di bawah ini dan paste ke Gemini untuk analisa lebih lanjut.</p><textarea id="data-export-area" readonly></textarea><button class="btn" data-action="export-data">Generate & Salin Data</button>
                </div>`;
            this.managerSubRenders();
        },

        managerSubRenders() {
            const masterItems = App.db.get('masterItems');
            const recipes = App.db.get('recipes');
            const shoppingLists = App.db.get('shoppingLists');

            const tbody = document.getElementById('db-editor-tbody');
            tbody.innerHTML = '';
            masterItems.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                tbody.innerHTML += `<tr><td>${item.name}</td><td>${item.category}</td><td>${(item.stock || 0).toFixed(2)} ${item.unit}</td><td><button class="action-btn edit-btn" data-action="edit-item" data-id="${item.id}">E</button><button class="action-btn delete-btn" data-action="delete-item" data-id="${item.id}">H</button></td></tr>`;
            });

            const pendingContainer = document.getElementById('pending-lists-container');
            const pendingLists = shoppingLists.filter(l => l.status === 'pending');
            if (pendingLists.length > 0) {
                pendingContainer.innerHTML = pendingLists.map(list => `<div class="list-item-button" style="flex-direction:row; justify-content:space-between; align-items:center;"><span>List Belanja ${new Date(list.date).toLocaleString('id-ID')}</span><button class="btn btn-danger" data-action="cancel-shopping-list" data-date="${list.date}">Batalkan</button></div>`).join('');
            } else {
                pendingContainer.innerHTML = '<p>Tidak ada list belanja yang pending.</p>';
            }

            const recipeContainer = document.getElementById('recipe-list-container');
            recipeContainer.innerHTML = Object.keys(recipes).sort().map(key => `<div class="list-item-button" style="flex-direction:row; justify-content:space-between; align-items:center;"><span>Resep: ${key}</span><button class="btn" data-action="edit-recipe" data-name="${key}">Edit Resep</button></div>`).join('');
            
            const menuConfigContainer = document.getElementById('menu-config-container');
            menuConfigContainer.innerHTML = `<button class="btn" data-action="edit-display-config">Edit Tampilan Menu & Gudang</button>`;
        },

        recipeEditor(targetPage, menuName) {
            const recipes = App.db.get('recipes');
            const masterItems = App.db.get('masterItems');
            const recipe = recipes[menuName];

            let ingredientsHTML = recipe.ingredients.map(ing => {
                const item = masterItems.find(mi => mi.id === ing.itemId);
                return item ? `<li class="item-row" style="grid-template-columns: 1fr 80px 50px;"><span>${item.name}</span><span>${ing.qty} ${item.unit}</span><button class="btn-danger" data-action="delete-ingredient" data-menu-name="${menuName}" data-item-id="${ing.itemId}">X</button></li>` : '';
            }).join('');
            
            let optionsHTML = masterItems.map(item => `<option value="${item.id}">${item.name}</option>`).join('');

            targetPage.innerHTML = `
                <div class="page-header"><h2>Edit Resep: ${menuName}</h2><button class="btn btn-secondary" data-page="page-manager-area">Kembali</button></div>
                <div class="category-group"><h3 class="category-title">Bahan Baku Saat Ini</h3><ul style="list-style:none;">${ingredientsHTML}</ul></div>
                <div class="category-group"><h3 class="category-title">Tambah Bahan Baku</h3><div id="recipe-editor-form"><select id="new-ingredient-item">${optionsHTML}</select><input type="number" id="new-ingredient-qty" placeholder="Jumlah" class="item-input" min="0" step="0.01"><button class="btn" data-action="add-ingredient" data-menu-name="${menuName}">Tambah</button></div></div>`;
        },

        displayConfigEditor(targetPage) {
            const masterItems = App.db.get('masterItems');
            const recipes = App.db.get('recipes');
            const gudangItemIds = App.db.get('gudangItemIds');
            const menuKeluarActive = App.db.get('menuKeluarActive');

            let gudangHTML = masterItems.sort((a,b) => a.name.localeCompare(b.name)).map(item => `
                <label><input type="checkbox" class="gudang-item-check" value="${item.id}" ${gudangItemIds.includes(item.id) ? 'checked' : ''}> ${item.name}</label>
            `).join('');

            let menuHTML = Object.keys(recipes).sort().map(name => `
                <label><input type="checkbox" class="menu-item-check" value="${name}" ${menuKeluarActive.includes(name) ? 'checked' : ''}> ${name}</label>
            `).join('');

            targetPage.innerHTML = `
                <div class="page-header"><h2>Atur Tampilan Menu & Gudang</h2><button class="btn btn-secondary" data-page="page-manager-area">Kembali</button></div>
                <div class="category-group">
                    <h3 class="category-title">Tampilkan di Menu "Ambil dari Gudang"</h3>
                    <div class="menu-list-editor">${gudangHTML}</div>
                </div>
                <div class="category-group">
                    <h3 class="category-title">Tampilkan di Menu "Input Menu Keluar"</h3>
                    <div class="menu-list-editor">${menuHTML}</div>
                </div>
                <button class="btn" style="width:100%" data-action="save-display-config">Simpan Perubahan Tampilan</button>
            `;
        }
    },
    
    actions: {
        generateShoppingList() {
            const inputs = document.querySelectorAll('#shopping-list-form .item-input');
            const shoppingList = { date: new Date().toISOString(), status: 'pending', items: [] };
            inputs.forEach(input => {
                if (input.value && parseFloat(input.value) > 0) {
                    shoppingList.items.push({ id: parseInt(input.dataset.itemId), quantity: parseFloat(input.value) });
                }
            });
            if (shoppingList.items.length === 0) return App.utils.showToast('Mohon isi minimal satu barang belanja.', 'error');
            let allLists = App.db.get('shoppingLists');
            allLists.push(shoppingList);
            App.db.set('shoppingLists', allLists);
            App.render.page('page-rangkuman-belanja', shoppingList);
            App.utils.showToast('List belanja berhasil dibuat!');
        },
        copyText(element) {
            const textToCopy = unescape(element.dataset.textToCopy);
            navigator.clipboard.writeText(textToCopy).then(() => {
                element.textContent = '‚úîÔ∏è Tersalin!';
                setTimeout(() => { element.textContent = 'üìã Salin'; }, 2000);
            }).catch(() => App.utils.showToast('Gagal menyalin.', 'error'));
        },
        processStockIn(listDate) {
            if (!confirm('Anda yakin ingin memasukkan barang-barang ini ke stok?')) return;
            let masterItems = App.db.get('masterItems');
            let allLists = App.db.get('shoppingLists');
            let listIndex = allLists.findIndex(list => list.date === listDate);
            let transactions = App.db.get('stockTransactions');
            if (listIndex === -1) return App.utils.showToast('List belanja tidak ditemukan.', 'error');
            const inputs = document.querySelectorAll('#stock-in-form .item-input');
            inputs.forEach(input => {
                if (input.value && parseFloat(input.value) > 0) {
                    const itemId = parseInt(input.dataset.itemId);
                    const receivedQty = parseFloat(input.value);
                    const itemIndex = masterItems.findIndex(item => item.id === itemId);
                    if (itemIndex > -1) {
                        const item = masterItems[itemIndex];
                        const stockInQty = receivedQty * item.purchaseUnitConversion;
                        const oldStock = item.stock || 0;
                        item.stock = parseFloat((oldStock + stockInQty).toFixed(3));
                        transactions.push({ date: new Date().toISOString(), type: 'IN', itemId: item.id, itemName: item.name, qty: stockInQty, unit: item.unit, fromStock: oldStock, toStock: item.stock, notes: `Belanja datang (${receivedQty} ${item.purchaseUnit || item.unit})`});
                    }
                }
            });
            allLists[listIndex].status = 'completed';
            App.db.set('masterItems', masterItems);
            App.db.set('shoppingLists', allLists);
            App.db.set('stockTransactions', transactions);
            App.utils.showToast('Stok berhasil diperbarui!');
            App.showPage('page-dashboard');
        },
        processStockOut(type) {
            if (!confirm('Anda yakin ingin mengeluarkan barang-barang ini dari stok?')) return;
            let masterItems = App.db.get('masterItems');
            let transactions = App.db.get('stockTransactions');
            const isMenuKeluar = type === 'menu';
            
            const config = isMenuKeluar ? App.db.get('recipes') : App.db.get('gudangItemIds');
            let itemsToProcess = [];
            if(isMenuKeluar) {
                const activeMenus = App.db.get('menuKeluarActive');
                itemsToProcess = activeMenus.map(name => ({name, ...config[name]}));
            } else {
                itemsToProcess = config.map(id => masterItems.find(item => item.id === id));
            }

            try {
                const deductions = [];
                itemsToProcess.forEach(item => {
                    const inputId = `stockout-${item.name.replace(/\s+/g, '-')}`;
                    const input = document.getElementById(inputId);
                    if (input && input.value && parseFloat(input.value) > 0) {
                        const qtyOut = parseFloat(input.value);
                        if (isMenuKeluar) {
                            item.ingredients.forEach(ingredient => {
                                const stockItem = masterItems.find(mi => mi.id === ingredient.itemId);
                                const deduction = qtyOut * ingredient.qty;
                                if ((stockItem.stock || 0) < deduction) throw new Error(`Stok ${stockItem.name} tidak cukup!`);
                                deductions.push({item, stockItem, deduction, qtyOut});
                            });
                        } else {
                            const stockItem = masterItems.find(mi => mi.id === item.id);
                            if ((stockItem.stock || 0) < qtyOut) throw new Error(`Stok ${stockItem.name} tidak cukup!`);
                            deductions.push({stockItem, deduction: qtyOut, from: 'gudang'});
                        }
                    }
                });

                deductions.forEach(d => {
                    const itemIndex = masterItems.findIndex(mi => mi.id === d.stockItem.id);
                    const oldStock = masterItems[itemIndex].stock;
                    masterItems[itemIndex].stock = parseFloat((oldStock - d.deduction).toFixed(3));
                    const notes = d.from === 'gudang' ? `Ambil dari gudang` : `Menu keluar: ${d.qtyOut} pcs ${d.item.name}`;
                    transactions.push({ date: new Date().toISOString(), type: 'OUT', itemId: d.stockItem.id, itemName: d.stockItem.name, qty: d.deduction, unit: d.stockItem.unit, fromStock: oldStock, toStock: masterItems[itemIndex].stock, notes });
                });

                App.db.set('masterItems', masterItems);
                App.db.set('stockTransactions', transactions);
                App.utils.showToast('Stok berhasil dikurangi!');
                App.showPage('page-dashboard');
            } catch (error) { App.utils.showToast(error.message, 'error'); }
        },
        saveItem() {
            const id = document.getElementById('edit-item-id').value;
            const newItemData = {
                name: document.getElementById('item-name').value, category: document.getElementById('item-category').value,
                unit: document.getElementById('item-unit').value, purchaseUnit: document.getElementById('item-purchase-unit').value,
                purchaseUnitConversion: parseFloat(document.getElementById('item-conversion').value) || 1
            };
            if (!newItemData.name || !newItemData.category || !newItemData.unit) return App.utils.showToast('Nama, Kategori, dan Satuan Stok harus diisi!', 'error');
            
            let masterItems = App.db.get('masterItems');
            if (id) {
                const itemIndex = masterItems.findIndex(item => item.id == id);
                masterItems[itemIndex] = { ...masterItems[itemIndex], ...newItemData };
            } else {
                const newId = masterItems.length > 0 ? Math.max(...masterItems.map(item => item.id)) + 1 : 1;
                masterItems.push({ ...newItemData, id: newId, stock: 0 });
            }
            App.db.set('masterItems', masterItems);
            document.getElementById('add-item-form').reset();
            document.getElementById('edit-item-id').value = '';
            App.render.managerSubRenders();
            App.utils.showToast('Barang berhasil disimpan!');
        },
        editItem(id) {
            const item = App.db.get('masterItems').find(item => item.id == id);
            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-category').value = item.category;
            document.getElementById('item-unit').value = item.unit;
            document.getElementById('item-purchase-unit').value = item.purchaseUnit;
            document.getElementById('item-conversion').value = item.purchaseUnitConversion;
            document.getElementById('item-name').focus();
        },
        deleteItem(id) {
            let masterItems = App.db.get('masterItems');
            const item = masterItems.find(item => item.id == id);
            if ((item.stock || 0) > 0) return App.utils.showToast('Tidak dapat menghapus barang karena masih ada sisa stok.', 'error');
            if (!confirm('Apakah Anda yakin ingin menghapus barang ini?')) return;
            masterItems = masterItems.filter(item => item.id != id);
            App.db.set('masterItems', masterItems);
            App.render.managerSubRenders();
            App.utils.showToast('Barang berhasil dihapus.');
        },
        cancelShoppingList(date) {
            if (!confirm('Anda yakin ingin membatalkan list belanja ini?')) return;
            let shoppingLists = App.db.get('shoppingLists').filter(l => l.date !== date);
            App.db.set('shoppingLists', shoppingLists);
            App.render.managerSubRenders();
            App.utils.showToast('List belanja berhasil dibatalkan.');
        },
        addIngredient(menuName) {
            const recipes = App.db.get('recipes');
            const itemId = parseInt(document.getElementById('new-ingredient-item').value);
            const qty = parseFloat(document.getElementById('new-ingredient-qty').value);
            if (!itemId || !qty || qty <= 0) return App.utils.showToast('Pilih barang dan isi jumlah.', 'error');
            if(recipes[menuName].ingredients.some(i => i.itemId === itemId)) return App.utils.showToast('Bahan baku sudah ada di resep.', 'error');
            recipes[menuName].ingredients.push({ itemId, qty });
            App.db.set('recipes', recipes);
            App.render.recipeEditor(document.getElementById('page-manager-area'), menuName);
        },
        deleteIngredient(menuName, itemId) {
            const recipes = App.db.get('recipes');
            recipes[menuName].ingredients = recipes[menuName].ingredients.filter(ing => ing.itemId != itemId);
            App.db.set('recipes', recipes);
            App.render.recipeEditor(document.getElementById('page-manager-area'), menuName);
        },
        saveDisplayConfig() {
            const gudangChecks = document.querySelectorAll('.gudang-item-check:checked');
            const newGudangItemIds = Array.from(gudangChecks).map(cb => parseInt(cb.value));
            App.db.set('gudangItemIds', newGudangItemIds);

            const menuChecks = document.querySelectorAll('.menu-item-check:checked');
            const newMenuKeluarActive = Array.from(menuChecks).map(cb => cb.value);
            App.db.set('menuKeluarActive', newMenuKeluarActive);

            App.utils.showToast('Pengaturan tampilan berhasil disimpan!');
            App.render.page('page-manager-area');
        },
        exportData() {
            const masterItems = App.db.get('masterItems');
            const transactions = App.db.get('stockTransactions');
            let exportText = `DATA RESTORAN PER TANGGAL ${new Date().toLocaleString('id-ID')}\n\n--- DATA STOK SAAT INI ---\n`;
            const categories = [...new Set(masterItems.map(item => item.category))].sort();
            categories.forEach(cat => {
                exportText += `\nKategori: ${cat}\n`;
                masterItems.filter(item => item.category === cat).forEach(item => {
                    exportText += `- ${item.name}: ${(item.stock || 0).toFixed(2)} ${item.unit}\n`;
                });
            });
            exportText += "\n\n--- RIWAYAT TRANSAKSI STOK (50 TERAKHIR) ---\n";
            if (transactions.length > 0) {
                transactions.slice(-50).reverse().forEach(t => {
                    const date = new Date(t.date).toLocaleString('id-ID');
                    const qty = t.type === 'IN' ? `+${t.qty.toFixed(2)}` : `-${t.qty.toFixed(2)}`;
                    exportText += `[${date}] ${t.type} | ${t.itemName} | ${qty} ${t.unit} | Stok: ${t.toStock.toFixed(2)} | Catatan: ${t.notes}\n`;
                });
            } else {
                exportText += "Belum ada transaksi stok.\n";
            }
            const exportArea = document.getElementById('data-export-area');
            exportArea.value = exportText;
            navigator.clipboard.writeText(exportText).then(() => App.utils.showToast('Data untuk analisa berhasil disalin!'))
            .catch(() => App.utils.showToast('Gagal menyalin otomatis.', 'error'));
        }
    },
    
    handle: {
        click(event) {
            const target = event.target.closest('[data-page], [data-action]');
            if (!target) return;
            event.preventDefault();
            const { page, action, message, date, id, name, type, itemId, menuName } = target.dataset;

            if (page) {
                App.render.page(page);
            } else if (action) {
                const actions = App.actions;
                switch(action) {
                    case 'show-alert': App.utils.showToast(message, 'info'); break;
                    case 'generate-shopping-list': actions.generateShoppingList(); break;
                    case 'copy-text': actions.copyText(target); break;
                    case 'select-pending-list': App.render.stockInDetail(document.getElementById('page-input-belanja-datang'), date); break;
                    case 'process-stock-in': actions.processStockIn(date); break;
                    case 'process-stock-out': actions.processStockOut(type); break;
                    case 'save-item': actions.saveItem(); break;
                    case 'edit-item': actions.editItem(id); break;
                    case 'delete-item': actions.deleteItem(id); break;
                    case 'export-data': actions.exportData(); break;
                    case 'cancel-shopping-list': actions.cancelShoppingList(date); break;
                    case 'edit-recipe': App.render.recipeEditor(document.getElementById('page-manager-area'), name); break;
                    case 'add-ingredient': actions.addIngredient(name); break;
                    case 'delete-ingredient': actions.deleteIngredient(menuName, itemId); break;
                    case 'edit-display-config': App.render.displayConfigEditor(document.getElementById('page-manager-area')); break;
                    case 'save-display-config': actions.saveDisplayConfig(); break;
                }
            }
        }
    },

    utils: {
        updateTime() {
            const timeEl = document.getElementById('current-time');
            if (timeEl) {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                timeEl.textContent = now.toLocaleDateString('id-ID', options);
            }
        },
        showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }
    }
};

document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
