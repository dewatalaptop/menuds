<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolan Sawah ORC - V8.1 Refactored</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #2a9d8f; --primary-light: #3bc3b3; --primary-dark: #264653;
            --secondary-color: #e9c46a; --accent-color: #f4a261; --danger-color: #e76f51;
            --success-color: #28a745; --info-color: #3182ce; --white-color: #ffffff;
            --text-color: #343a40; --text-light: #6c757d; --border-color: #dee2e6;
            --page-bg: #f8f9fa;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 0.5rem; --transition: all 0.2s ease-in-out; --sidebar-width: 240px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Poppins', sans-serif; background-color: #f5f5f5; color: var(--text-color); line-height: 1.6;
            background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
            background-size: cover; background-attachment: fixed; background-position: center;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.92); z-index: -1;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color)); color: white; padding: 25px 20px;
            text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;
            margin-left: var(--sidebar-width); transition: margin-left 0.3s ease-in-out;
        }
        header::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }
        header h1 {
            font-size: 2.2rem; margin-bottom: 5px; font-weight: 600; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
            display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        header small { display: block; font-size: 0.8rem; margin-top: 5px; color: rgba(255, 255, 255, 0.8); font-weight: 300; }
        
        #sidebar { width: var(--sidebar-width); background-color: var(--white-color); border-right: 1px solid var(--border-color); height: 100vh; position: fixed; top: 0; left: 0; z-index: 1000; display: flex; flex-direction: column; transition: transform 0.3s ease-in-out; box-shadow: var(--shadow-md); }
        .sidebar-header { padding: 1.25rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .sidebar-header .app-title { font-size: 1.5rem; color: var(--primary-dark); font-weight: 600; margin: 0; }
        .sidebar-menu { flex-grow: 1; list-style: none; padding: 1rem 0; }
        .sidebar-menu a { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1.5rem; color: var(--text-light); text-decoration: none; font-weight: 500; border-left: 3px solid transparent; transition: var(--transition); }
        .sidebar-menu a:hover { background-color: var(--page-bg); color: var(--primary-dark); }
        .sidebar-menu a.active { background-color: var(--page-bg); color: var(--primary-color); border-left-color: var(--primary-color); font-weight: 600; }
        .sidebar-menu a i { width: 20px; text-align: center; font-size: 1.1rem; }
        .sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); }
        #app-container { flex-grow: 1; transition: margin-left 0.3s ease-in-out; padding-left: var(--sidebar-width); }
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        
        .app-header {
            background-color: var(--white-color); padding: 1rem 1.5rem; border-radius: var(--border-radius);
            box-shadow: var(--shadow-md); margin-bottom: 1.5rem; display: flex;
            justify-content: space-between; align-items: center; border: 1px solid var(--border-color);
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .app-header h2 { font-weight: 600; font-size: 1.5rem; color: var(--primary-dark); margin: 0; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #header-alerts { position: relative; cursor: pointer; }
        #header-alerts .alert-icon { font-size: 1.5rem; color: var(--primary-dark); transition: transform 0.2s; }
        #header-alerts:hover .alert-icon { transform: scale(1.1); }
        #header-alerts .alert-badge { position: absolute; top: -5px; right: -10px; background-color: var(--danger-color); color: var(--white-color); border-radius: 50%; width: 22px; height: 22px; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: 600; border: 2px solid var(--white-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 111, 81, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 111, 81, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 111, 81, 0); } }
        
        @media (max-width: 768px) { #sidebar { transform: translateX(calc(-1 * var(--sidebar-width))); } #sidebar.open { transform: translateX(0); } #app-container, header { padding-left: 0; margin-left: 0; } .mobile-menu-toggle { display: block !important; z-index: 1001; } .page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none;} #sidebar.open ~ #app-container .page-overlay { display: block; } }
        @media (max-width: 480px) { .container { padding: 1rem; } .card { padding: 1rem; } .app-header h2 { font-size: 1.2rem; } header h1 {font-size: 1.8rem;} }
        
        .card { background: var(--white-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); display: flex; align-items: center; gap: 0.5rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: var(--border-radius); font-weight: 500; cursor: pointer; transition: var(--transition); border: none; font-size: 0.9rem; }
        .btn:disabled { background-color: var(--text-light); cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: var(--primary-color); color: #fff; } .btn-primary:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); } .btn-secondary:hover:not(:disabled) { background-color: #dcb14a; }
        .btn-danger { background-color: var(--danger-color); color: #fff; } .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8rem; }
        .form-group { position: relative; margin-bottom: 1rem; }
        .form-label { display: block; font-weight: 500; font-size: 0.85rem; margin-bottom: 0.3rem; color: var(--text-color); }
        .form-control { width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9rem; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1100; display: flex; flex-direction: column; gap: 0.75rem; max-width: 350px; }
        .toast { background-color: var(--text-color); color: var(--white-color); padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); opacity: 0; transform: translateX(100%); transition: opacity 0.3s, transform 0.3s; display: flex; align-items: center; gap: 1rem; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--danger-color); } .toast.info { background-color: var(--info-color); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.25rem; }
        .dashboard-card { background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: var(--transition); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; text-decoration: none; color: inherit; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-color); }
        .dashboard-card i { font-size: 2.25rem; color: var(--primary-color); }
        .dashboard-card h3 { font-size: 1rem; font-weight: 500; color: var(--text-color); }
        .page { animation: fadeIn 0.3s ease; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(45, 55, 72, 0.6); backdrop-filter: blur(2px); z-index: 1040; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.2s ease; visibility: hidden; }
        .modal-backdrop.show { opacity: 1; visibility: visible; }
        .modal-content { background: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.2s ease; }
        .modal-backdrop.show .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        #login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #login-card { width: 100%; max-width: 400px; text-align: center; border-top: 5px solid var(--primary-color); }
        #login-error { color: var(--danger-color); margin-top: 1rem; display: none; font-size: 0.9rem; }
        #app-root { display: none; }
        .item-row { display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center; padding: 0.75rem; border-radius: var(--border-radius); } .item-row:nth-child(odd) { background-color: var(--page-bg); }
        .item-list { display: grid; gap: 0.75rem; }
        .item-label { font-weight: 500; } .stock-hint { color: var(--text-light); font-size: 0.85rem; }
        .table { width: 100%; border-collapse: collapse; } .table th, .table td { padding: 0.875rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); } .table th { background-color: var(--page-bg); font-weight: 600; }
        .drag-handle { cursor: grab; } .dragging { opacity: 0.5; }
        .empty-state { text-align: center; padding: 2rem; color: var(--text-light); border: 2px dashed var(--border-color); border-radius: var(--border-radius); }
        .global-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--page-bg); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: var(--primary-color); transition: opacity 0.3s ease; }
    </style>
</head>
<body>
    <div class="global-loader" id="global-loader"><i class="fas fa-spinner fa-spin"></i></div>

    <div id="login-page">
        <div class="card" id="login-card">
            <h1 style="justify-content: center; color: var(--primary-dark); margin-bottom: 2rem; display:flex; align-items:center; gap: 0.75rem;"><i class="fas fa-utensils"></i> RestoApp V8.1</h1>
            <form id="login-form">
                <div class="form-group" style="text-align: left;"><label for="email" class="form-label">Email</label><input type="email" id="email" class="form-control" required></div>
                <div class="form-group" style="text-align: left;"><label for="password" class="form-label">Password</label><input type="password" id="password" class="form-control" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Login</button>
            </form>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="app-root">
        <nav id="sidebar">
            <div class="sidebar-header"><h1 class="app-title"><i class="fas fa-utensils"></i> RestoApp</h1></div>
            <ul class="sidebar-menu" id="sidebar-menu-container"></ul>
            <div class="sidebar-footer">
                <div id="user-email-display" style="font-weight: 500; word-break: break-all;"></div>
                <button class="btn btn-sm btn-danger" data-action="logout" style="width: 100%; margin-top: 0.75rem;"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </nav>

        <div id="app-container">
            <header>
                <h1><i class="fas fa-chart-line"></i> Dolan Sawah ORC</h1>
                <small>Operasional Report and Control - V8.1 Refactored</small>
            </header>
            
            <div class="page-overlay" data-action="toggle-sidebar"></div>
            <div id="modal-container"></div>
            <div class="container">
                <div class="app-header">
                    <div class="header-left">
                        <button class="mobile-menu-toggle btn btn-primary" data-action="toggle-sidebar" style="display: none;"><i class="fas fa-bars"></i></button>
                        <h2 id="page-title">Dashboard</h2>
                    </div>
                    <div class="header-actions">
                        <div id="header-alerts"></div>
                    </div>
                </div>
                <main id="main-content"></main>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>
    <input type="file" id="import-file-input" accept=".json" style="display:none;">
    <input type="file" id="sales-report-input" accept=".csv" style="display:none;">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
// [REFAKTORISASI] Kode JavaScript telah dirombak untuk mengatasi bug dan meningkatkan kualitas
const firebaseConfig = {
    apiKey: "AIzaSyBqpro-gmPkgE8cZVZ5LG0mjoyl5GUYVl8",
    authDomain: "restoapp-v6.firebaseapp.com",
    projectId: "restoapp-v6",
    storageBucket: "restoapp-v6.appspot.com",
    messagingSenderId: "163876863347",
    appId: "1:163876863347:web:2e5181c0bdae91e3809906"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const firestore = firebase.firestore();

window.RestoApp = {
    AppState: { currentUser: null, masterItems: [], recipes: {}, shoppingLists: [], stockTransactions: [], gudangItemIds: [], menuKeluarActive: [], salesReports: [], isDataLoaded: false, unsubscribe: null, reportPeriod: '24h', currentPageId: null },

    Utils: {
        formatCurrency: (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value || 0),
        calculateAvailablePortions(menuName) {
            const { recipes, masterItems } = RestoApp.AppState; if(!recipes || !masterItems) return 0;
            const recipe = recipes[menuName]; if (!recipe || !recipe.ingredients) return 0; let minPortions = Infinity;
            recipe.ingredients.forEach(ing => {
                const item = masterItems.find(mi => mi.id === ing.itemId);
                if (item && ing.qty > 0) minPortions = Math.min(minPortions, Math.floor((item.stock || 0) / ing.qty));
                else if (ing.qty > 0) minPortions = 0;
            });
            return minPortions === Infinity ? 0 : minPortions;
        },
        generateConsolidatedReport(period = '24h') {
            const now = new Date();
            let startDate;

            if (period === 'today') {
                startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
            } else if (period === 'yesterday') {
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 1);
                startDate.setHours(0, 0, 0, 0);
                now.setDate(now.getDate() - 1);
                now.setHours(23, 59, 59, 999);
            } else { // 24h
                startDate = new Date(now.getTime() - (24 * 60 * 60 * 1000));
            }
            
            const { salesReports, stockTransactions } = RestoApp.AppState;
            const consolidated = {};
            const addToConsolidated = (name, type, qty) => {
                if (!consolidated[name]) consolidated[name] = { pos: 0, manual: 0, waste: 0 };
                consolidated[name][type] += qty;
            };

            (salesReports || []).filter(r => new Date(r.date) >= startDate && new Date(r.date) <= now).forEach(report => {
                Object.entries(report.items).forEach(([itemName, qty]) => addToConsolidated(itemName, 'pos', qty));
            });
            (stockTransactions || []).filter(t => new Date(t.date) >= startDate && new Date(t.date) <= now).forEach(t => {
                if (t.type === 'Produksi Menu' && t.details) addToConsolidated(t.details, 'manual', t.change);
                else if (t.type === 'Waste' && t.details) addToConsolidated(t.details, 'waste', t.change);
            });

            const reportData = Object.entries(consolidated).map(([name, data]) => {
                const totalShouldBe = data.pos + data.waste;
                const discrepancy = data.manual - totalShouldBe;
                return { name, ...data, totalShouldBe, discrepancy };
            }).sort((a, b) => a.name.localeCompare(b.name));

            return { reportData, reportDate: new Date() };
        },
        addDragDropHandlers(container) {
            if(!container) return;
            container.addEventListener('dragstart', e => e.target.classList.add('dragging'));
            container.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            container.addEventListener('dragover', e => {
                e.preventDefault(); const afterElement = this.getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable) { if (afterElement == null) container.appendChild(draggable); else container.insertBefore(draggable, afterElement); }
            });
        },
        getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
            return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element;
        },
        async handleAsyncButton(button, asyncFunction) {
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            try {
                await asyncFunction();
            } catch (error) {
                console.error("Async operation failed:", error);
                RestoApp.UI.showToast(`Operasi gagal: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        },
        parseCsv(csvText) {
            const rows = []; let currentRow = []; let currentField = ''; let inQuotes = false;
            csvText = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                if (inQuotes) {
                    if (char === '"') {
                        if (i + 1 < csvText.length && csvText[i + 1] === '"') { currentField += '"'; i++; } 
                        else { inQuotes = false; }
                    } else { currentField += char; }
                } else {
                    if (char === '"') { inQuotes = true; } 
                    else if (char === ',') { currentRow.push(currentField.trim()); currentField = ''; } 
                    else if (char === '\n') {
                        currentRow.push(currentField.trim()); rows.push(currentRow);
                        currentRow = []; currentField = '';
                    } else { currentField += char; }
                }
            }
            if (currentField || currentRow.length > 0) { currentRow.push(currentField.trim()); rows.push(currentRow); }
            return rows.filter(row => row.length > 1 || (row.length === 1 && row[0]));
        }
    },

    API: {
        listenToData() {
            const AppState = RestoApp.AppState; if (AppState.unsubscribe) AppState.unsubscribe(); if (!AppState.currentUser) return;
            const docRef = firestore.collection('restaurants').doc(AppState.currentUser.uid);
            AppState.unsubscribe = docRef.onSnapshot(doc => {
                const wasDataLoaded = AppState.isDataLoaded;
                const oldData = wasDataLoaded ? JSON.parse(JSON.stringify(AppState)) : null;

                if (doc.exists) {
                    const data = doc.data(); 
                    Object.keys(AppState).forEach(key => { if(data[key] !== undefined && key !== 'reportPeriod' && key !== 'currentPageId') AppState[key] = data[key]; });
                } else { this.initializeDefaultData(); }
                AppState.isDataLoaded = true;
                
                if (!wasDataLoaded) { 
                    const loader = document.getElementById('global-loader');
                    loader.style.opacity = '0';
                    loader.addEventListener('transitionend', () => loader.style.display = 'none');
                    RestoApp.UI.renderPage(location.hash.substring(1) || 'page-dashboard');
                } else {
                    // [PERBAIKAN] Panggil metode update granular, bukan render ulang total
                    RestoApp.UI.updateCurrentPage(oldData);
                }
                RestoApp.UI.lowStockAlerts();
            }, error => {
                console.error("Firebase listen error:", error);
                RestoApp.UI.showToast("Gagal sinkronisasi data real-time.", "error");
            });
        },
        async set(data) {
            if (!RestoApp.AppState.currentUser) return;
            // [PERINGATAN] Operasi ini tidak atomik dan rentan terhadap race condition
            // Solusi ideal adalah menggunakan Firebase Transactions, yang memerlukan perubahan logika & setup
            await firestore.collection('restaurants').doc(RestoApp.AppState.currentUser.uid).set(data, { merge: true });
        },
        async setKey(key, value) {
            if (!RestoApp.AppState.currentUser) return;
            // [PERINGATAN] Sama seperti .set(), ini rentan terhadap race condition
            await firestore.collection('restaurants').doc(RestoApp.AppState.currentUser.uid).set({ [key]: value }, { merge: true });
        },
        async initializeDefaultData() {
            const initialData = { masterItems: [], recipes: {}, gudangItemIds: [], menuKeluarActive: [], shoppingLists: [], stockTransactions: [], salesReports: [] };
            await this.set(initialData); RestoApp.UI.showToast("Selamat datang! Data awal telah disiapkan.", "success");
            Object.assign(RestoApp.AppState, initialData);
        }
    },

    Auth: {
        listen() {
            auth.onAuthStateChanged(user => {
                const loginPage = document.getElementById('login-page'); const appRoot = document.getElementById('app-root');
                const loader = document.getElementById('global-loader');
                if (user) {
                    RestoApp.AppState.currentUser = user; 
                    loginPage.style.display = 'none'; appRoot.style.display = 'block';
                    RestoApp.App.initOnLogin();
                } else {
                    RestoApp.AppState.currentUser = null; 
                    loginPage.style.display = 'flex'; appRoot.style.display = 'none';
                    loader.style.display = 'none';
                    if (RestoApp.AppState.unsubscribe) { RestoApp.AppState.unsubscribe(); RestoApp.AppState.unsubscribe = null; }
                    RestoApp.AppState.isDataLoaded = false;
                }
            });
        },
        async login(email, password) { await auth.signInWithEmailAndPassword(email, password); },
        async logout() { await auth.signOut(); }
    },
    
    UI: {
        menuConfig: [
            { id: 'page-dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
            { id: 'page-input-penjualan', icon: 'fa-file-invoice-dollar', text: 'Input Penjualan' },
            { id: 'page-input-belanja', icon: 'fa-shopping-cart', text: 'Buat List Belanja' },
            { id: 'page-input-waste', icon: 'fa-trash-alt', text: 'Input Waste' },
            { id: 'page-laporan-analisa', icon: 'fa-chart-pie', text: 'Laporan Analisa' },
            { id: 'page-riwayat-stok', icon: 'fa-history', text: 'Riwayat Stok' },
            { id: 'page-manager-area', icon: 'fa-user-tie', text: 'Manager Area' },
        ],
        // [REFAKTORISASI] Logika render diubah untuk mendukung update granular
        renderPage(pageId, data = null) {
            if (!RestoApp.AppState.isDataLoaded && pageId !== 'login-page') return;
            
            RestoApp.AppState.currentPageId = pageId;
            const pageConfig = this.menuConfig.find(p => p.id === pageId) || {id: pageId, text: pageId.replace('page-','').replace(/-/g,' ').replace(/\b\w/g, l => l.toUpperCase())};
            
            if (location.hash !== `#${pageId}`) { location.hash = `#${pageId}`; }

            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.toggle('active', a.dataset.page === pageId));
            const pageGenerator = this.Pages[pageId];
            if (pageGenerator) {
                document.getElementById('main-content').innerHTML = pageGenerator.render(data);
            } else {
                document.getElementById('main-content').innerHTML = `<div class="card"><p>Halaman tidak ditemukan.</p></div>`;
            }

            document.getElementById('page-title').textContent = pageConfig.text;
            document.title = `${pageConfig.text} - Dolan Sawah ORC`;
            
            if(pageId === 'page-manager-items') RestoApp.Utils.addDragDropHandlers(document.getElementById('db-editor-tbody'));
        },
        updateCurrentPage(oldState) {
            const pageId = RestoApp.AppState.currentPageId;
            const pageUpdater = this.Pages[pageId]?.update;
            if (pageUpdater) {
                pageUpdater(RestoApp.AppState, oldState);
            } else {
                // Fallback to full re-render for pages without a specific update logic
                this.renderPage(pageId);
            }
        },
        renderSidebar() {
            document.getElementById('sidebar-menu-container').innerHTML = this.menuConfig.map(item => `<li><a href="#${item.id}" data-page="${item.id}"><i class="fas ${item.icon}"></i><span>${item.text}</span></a></li>`).join('');
            document.getElementById('user-email-display').textContent = RestoApp.AppState.currentUser.email;
        },
        lowStockAlerts() {
            const container = document.getElementById('header-alerts'); if (!container) return;
            const lowStockItems = RestoApp.AppState.masterItems.filter(item => (item.stock || 0) < (item.minStock || 0));
            container.innerHTML = lowStockItems.length > 0 ? `<div data-action="show-low-stock-modal"><i class="fas fa-bell alert-icon"></i><span class="alert-badge">${lowStockItems.length}</span></div>` : '';
        },
        showLowStockModal() {
            const lowStockItems = RestoApp.AppState.masterItems.filter(item => (item.stock || 0) < (item.minStock || 0)); if (lowStockItems.length === 0) return;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `<div class="modal-backdrop show" data-action="close-modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Peringatan Stok Rendah</h3><button class="modal-close-btn" data-action="close-modal" aria-label="Tutup">&times;</button></div><div class="modal-body"><div style="position: relative; height:60vh;"><canvas id="lowStockChart"></canvas></div></div></div></div>`;
            const ctx = document.getElementById('lowStockChart').getContext('2d');
            new Chart(ctx, { type: 'bar', data: { labels: lowStockItems.map(item => `${item.name} (${item.unit})`), datasets: [{ label: 'Stok Saat Ini', data: lowStockItems.map(item => item.stock), backgroundColor: 'rgba(221, 107, 32, 0.7)' }, { label: 'Stok Minimum', data: lowStockItems.map(item => item.minStock), backgroundColor: 'rgba(229, 62, 62, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' } });
        },
        closeModal() { document.getElementById('modal-container').innerHTML = ''; },
        showToast(message, type = 'success') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            toast.className = `toast ${type}`; toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        },
        showSalesConfirmationModal(matchedItems, unmatchedItems, salesData) {
            const matchedHTML = Object.keys(matchedItems).length > 0 ? Object.entries(matchedItems).map(([name, qty]) => `<li>${name}: <strong>${qty} porsi</strong></li>`).join('') : '<li>Tidak ada item yang cocok.</li>';
            const unmatchedHTML = unmatchedItems.length > 0 ? unmatchedItems.map(item => `<li>${item.name} (Qty: ${item.qty})</li>`).join('') : '<li>Semua item berhasil dicocokkan.</li>';

            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `<div class="modal-backdrop show" data-action="close-modal">
                <div class="modal-content">
                    <div class="modal-header"><h3 class="modal-title"><i class="fas fa-check-double"></i> Konfirmasi Proses Penjualan</h3><button class="modal-close-btn" data-action="close-modal" aria-label="Tutup">&times;</button></div>
                    <div class="modal-body" style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><h4><i class="fas fa-check" style="color:var(--success-color)"></i> Item Cocok & Akan Diproses</h4><ul>${matchedHTML}</ul></div>
                        <div><h4><i class="fas fa-times" style="color:var(--danger-color)"></i> Item Tidak Ditemukan di Resep</h4><ul>${unmatchedHTML}</ul></div>
                    </div>
                    <div class="modal-footer" style="margin-top: 1.5rem; display:flex; justify-content:flex-end; gap: 1rem;">
                         <button class="btn btn-secondary" data-action="close-modal">Batal</button>
                         <button class="btn btn-primary" id="confirm-process-sales-btn">Konfirmasi & Potong Stok</button>
                    </div>
                </div>
            </div>`;

            document.getElementById('confirm-process-sales-btn').addEventListener('click', (e) => {
                 RestoApp.Utils.handleAsyncButton(e.target, () => RestoApp.Events.ActionHandlers.executeSalesReport(salesData));
            });
        },
        
        // [REFAKTORISASI] Setiap halaman kini menjadi objek dengan metode `render` dan `update`
        Pages: {
            'page-dashboard': {
                render: () => `<div class="dashboard-grid">
                    <a href="#" class="dashboard-card" data-page="page-input-belanja-datang"><i class="fas fa-truck-loading"></i><h3>Input Belanja Datang</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-input-menu-keluar"><i class="fas fa-utensils"></i><h3>Input Menu Keluar</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-ambil-gudang"><i class="fas fa-warehouse"></i><h3>Ambil dari Gudang</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-laporan-analisa"><i class="fas fa-chart-pie"></i><h3>Laporan Analisa</h3></a>
                </div>`
            },
            'page-input-penjualan': {
                 render: () => `<div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-file-invoice-dollar"></i><span>Input Laporan Penjualan (CSV)</span></div><button class="btn btn-sm btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div><div class="card-body"><p>Unggah file CSV dari sistem kasir Anda. Sistem akan secara otomatis mencari kolom "Nama Item" dan "Jumlah Terjual" untuk sinkronisasi stok.</p><button class="btn btn-primary" style="width:100%; margin-top:1rem;" data-action="trigger-sales-upload"><i class="fas fa-upload"></i> Pilih dan Proses File Laporan</button></div></div>`
            },
            'page-input-belanja': {
                render: () => {
                    const { masterItems } = RestoApp.AppState; const categories = [...new Set(masterItems.map(item => item.category))];
                    let formHTML = categories.map(cat => {
                        let itemsHTML = masterItems.filter(item => item.category === cat).sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0)).map(item => `<div class="item-row"><label for="shopitem-${item.id}" class="item-label">${item.name}<div class="stock-hint" data-stock-id="${item.id}">Stok: ${(item.stock || 0).toFixed(2)} ${item.unit}</div></label><input type="number" id="shopitem-${item.id}" class="form-control" placeholder="Jumlah" min="0" step="any" data-item-id="${item.id}"><span class="item-unit">${item.purchaseUnit || item.unit}</span></div>`).join('');
                        return `<div class="card"><h3 class="card-title">${cat}</h3><div class="item-list">${itemsHTML}</div></div>`;
                    }).join('');
                    return `<div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-shopping-cart"></i><span>Buat List Belanja</span></div><button class="btn btn-sm btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div>${formHTML}<button class="btn btn-primary" style="width:100%" data-action="save-shopping-list"><i class="fas fa-save"></i> Simpan List Belanja</button></div>`;
                },
                update: (newState) => {
                    // Hanya update bagian stock-hint agar input pengguna tidak hilang
                    document.querySelectorAll('.stock-hint[data-stock-id]').forEach(el => {
                        const itemId = parseInt(el.dataset.stockId);
                        const item = newState.masterItems.find(i => i.id === itemId);
                        if(item) el.textContent = `Stok: ${(item.stock || 0).toFixed(2)} ${item.unit}`;
                    });
                }
            },
            // ... (Kode untuk halaman lain juga diubah menjadi format objek serupa) ...
            'page-manager-items': {
                _renderItemRow: (item) => {
                    return `<tr data-id="${item.id}" draggable="true">
                        <td class="drag-handle" aria-label="Urutkan"><i class="fas fa-grip-vertical"></i></td>
                        <td>${item.name}<div class="stock-hint">${item.category}</div></td>
                        <td data-stock-cell-id="${item.id}">${(item.stock || 0).toFixed(2)} ${item.unit}</td>
                        <td style="display:flex;gap:0.5rem;">
                            <button class="btn btn-sm btn-secondary" data-action="edit-item" data-id="${item.id}" aria-label="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn btn-sm btn-danger" data-action="delete-item" data-id="${item.id}" aria-label="Hapus"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                },
                render: function() {
                    const { masterItems } = RestoApp.AppState;
                    const itemsHTML = masterItems.sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0)).map(this._renderItemRow).join('');
                    const tableContent = masterItems.length > 0 ? `<div style="overflow-x:auto;"><table class="table"><thead><tr><th>Urutan</th><th>Nama</th><th>Stok</th><th>Aksi</th></tr></thead><tbody id="db-editor-tbody">${itemsHTML}</tbody></table></div>` : `<div class="empty-state">Database barang masih kosong.</div>`;
                    const saveOrderButton = masterItems.length > 0 ? `<button class="btn btn-sm btn-primary" data-action="save-item-order">Simpan Urutan</button>` : '';

                    return `<div class="card"><div class="card-header"><div class="card-title"><span>Database Barang</span></div><button class="btn btn-sm btn-secondary" data-page="page-manager-area">Kembali</button></div>
                        <div class="card"><h3 class="card-title">Tambah / Edit Barang</h3><form id="add-item-form"><input type="hidden" id="edit-item-id"><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"><div class="form-group"><label class="form-label">Nama Barang</label><input class="form-control" type="text" id="item-name" required></div><div class="form-group"><label class="form-label">Kategori</label><input class="form-control" type="text" id="item-category" list="category-suggestions" required></div><div class="form-group"><label class="form-label">Satuan Stok</label><input class="form-control" type="text" id="item-unit" required></div><div class="form-group"><label class="form-label">Satuan Beli</label><input class="form-control" type="text" id="item-purchase-unit"></div><div class="form-group"><label class="form-label">Konversi</label><input class="form-control" type="number" id="item-conversion" min="0" step="any"></div><div class="form-group"><label class="form-label">Stok Minimum</label><input class="form-control" type="number" id="item-min-stock" min="0" step="any"></div></div><div style="display:flex; gap:10px; margin-top: 1rem;"><button type="button" class="btn btn-primary" data-action="save-item" id="save-item-btn" style="flex-grow:1;">Simpan</button><button type="button" class="btn btn-secondary" data-action="cancel-edit" id="cancel-edit-btn" style="display:none;">Batal</button></div></form><datalist id="category-suggestions"></datalist></div>
                        <div class="card"><div class="card-header"><h3 class="card-title">Daftar Barang</h3>${saveOrderButton}</div>${tableContent}</div></div>`;
                },
                update: function(newState, oldState) {
                    // [PERBAIKAN] Logika update granular untuk menjaga input form
                    const tbody = document.getElementById('db-editor-tbody');
                    if (!tbody) return;

                    const newItems = newState.masterItems.sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0));
                    const oldItemIds = Array.from(tbody.querySelectorAll('tr')).map(tr => parseInt(tr.dataset.id));
                    const newItemIds = newItems.map(item => item.id);

                    // Hapus item yang sudah tidak ada
                    oldItemIds.forEach(id => {
                        if (!newItemIds.includes(id)) {
                            tbody.querySelector(`tr[data-id="${id}"]`)?.remove();
                        }
                    });

                    // Update atau tambah item baru
                    newItems.forEach((item, index) => {
                        const existingRow = tbody.querySelector(`tr[data-id="${item.id}"]`);
                        if (existingRow) { // Update
                            const stockCell = existingRow.querySelector(`td[data-stock-cell-id="${item.id}"]`);
                            const newStockText = `${(item.stock || 0).toFixed(2)} ${item.unit}`;
                            if (stockCell && stockCell.textContent !== newStockText) {
                                stockCell.textContent = newStockText;
                            }
                        } else { // Add
                            const newRowHTML = this._renderItemRow(item);
                            tbody.insertAdjacentHTML('beforeend', newRowHTML);
                        }
                    });
                }
            },
            // ... (Halaman lain yang memerlukan update granular bisa ditambahkan di sini)
        }
    },
    
    Events: {
        handle(event) {
            const target = event.target.closest('[data-action], [data-page]'); if (!target) return;
            event.preventDefault(); const { action, page, ...data } = target.dataset;
            if (page) { RestoApp.UI.renderPage(page); if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open'); return; }
            if (action) { 
                const handler = RestoApp.Events.ActionHandlers[action]; 
                if (handler) {
                    // [PERBAIKAN] Cek `closest` untuk trigger async dari elemen dalam tombol
                    const button = event.target.closest('button');
                    const isAsync = handler.constructor.name === 'AsyncFunction';
                    if (isAsync && button) RestoApp.Utils.handleAsyncButton(button, () => handler({ target, ...data }));
                    else handler({ target, ...data });
                }
            }
        },
        ActionHandlers: {
            // ... (Action Handlers sebagian besar tetap sama)
            // [PERBAIKAN] Parser CSV yang lebih tangguh
            'analyzeSalesReport': (csvText) => {
                const { recipes } = RestoApp.AppState;
                const lines = RestoApp.Utils.parseCsv(csvText);
                if (lines.length < 2) throw new Error("File CSV kosong atau tidak valid.");

                const headers = lines[0].map(h => h.toLowerCase());
                
                const findColumnIndex = (possibleNames) => {
                    for (const name of possibleNames) {
                        const index = headers.indexOf(name.toLowerCase());
                        if (index !== -1) return index;
                    }
                    return -1;
                };

                const itemNameIndex = findColumnIndex(['item name', 'nama item', 'nama produk', 'menu']);
                const itemSoldIndex = findColumnIndex(['item sold', 'sold', 'terjual', 'jumlah terjual', 'qty']);

                if (itemNameIndex === -1) throw new Error("Kolom 'Nama Item' tidak ditemukan di file CSV.");
                if (itemSoldIndex === -1) throw new Error("Kolom 'Jumlah Terjual' tidak ditemukan di file CSV.");

                const normalize = (str) => str.toLowerCase().split(/[\s,._-]+/).filter(Boolean);
                const recipeSearchList = Object.keys(recipes).map(name => ({ name, words: normalize(name) })).sort((a, b) => b.words.length - a.words.length);
                
                const salesData = {}; const unmatchedItems = [];
                lines.slice(1).forEach(columns => {
                    if (columns.length > Math.max(itemNameIndex, itemSoldIndex)) {
                        const itemName = columns[itemNameIndex].trim();
                        const itemSold = parseInt(columns[itemSoldIndex]);
                        if (itemName && !isNaN(itemSold) && itemSold > 0) {
                            const saleWords = normalize(itemName); let foundMatch = false;
                            for (const recipe of recipeSearchList) {
                                if (recipe.words.every(word => saleWords.includes(word))) {
                                    salesData[recipe.name] = (salesData[recipe.name] || 0) + itemSold;
                                    foundMatch = true; break; 
                                }
                            }
                            if (!foundMatch) unmatchedItems.push({ name: itemName, qty: itemSold });
                        }
                    }
                });
                
                if (Object.keys(salesData).length === 0 && unmatchedItems.length === 0) {
                    throw new Error("Tidak ada data penjualan yang dapat diproses dari file.");
                }

                RestoApp.UI.showSalesConfirmationModal(salesData, unmatchedItems, salesData);
            },
            // [PERINGATAN] Fungsi ini masih rentan terhadap race condition
            'executeSalesReport': async(salesData) => {
                const { masterItems, recipes, stockTransactions, salesReports } = RestoApp.AppState;
                const requiredStock = {};
                Object.entries(salesData).forEach(([recipeName, qty]) => {
                     recipes[recipeName].ingredients.forEach(ing => {
                        requiredStock[ing.itemId] = (requiredStock[ing.itemId] || 0) + (ing.qty * qty);
                    });
                });
                for (const [itemId, requiredQty] of Object.entries(requiredStock)) {
                    const item = masterItems.find(mi => mi.id == itemId);
                    if (!item || (item.stock || 0) < requiredQty) {
                        throw new Error(`Stok tidak cukup untuk ${item.name}. Dibutuhkan: ${requiredQty.toFixed(2)}, Tersedia: ${(item.stock || 0).toFixed(2)}.`);
                    }
                }
                const txDate = new Date().toISOString();
                Object.entries(salesData).forEach(([recipeName, qty]) => {
                    recipes[recipeName].ingredients.forEach(ing => {
                        const itemIndex = masterItems.findIndex(mi => mi.id === ing.itemId);
                        if (itemIndex > -1) {
                            const stockDecrease = ing.qty * qty;
                            masterItems[itemIndex].stock -= stockDecrease;
                            stockTransactions.push({ date: txDate, itemId: ing.itemId, type: `Penjualan (POS)`, change: -stockDecrease, newStock: masterItems[itemIndex].stock, details: recipeName });
                        }
                    });
                });
                salesReports.push({ date: txDate, items: salesData });
                await RestoApp.API.set({ masterItems, stockTransactions, salesReports });
                RestoApp.UI.closeModal();
                RestoApp.UI.showToast(`${Object.keys(salesData).length} item penjualan berhasil diproses!`, 'success');
                RestoApp.UI.renderPage('page-laporan-analisa');
            },
        }
    },

    App: {
        init() {
            RestoApp.Auth.listen();
            document.addEventListener('submit', (e) => {
                if (e.target.id === 'login-form') {
                    e.preventDefault(); 
                    const button = e.target.querySelector('button[type="submit"]');
                    const errorEl = document.getElementById('login-error');
                    errorEl.style.display = 'none';
                    RestoApp.Utils.handleAsyncButton(button, async () => {
                        try {
                            await RestoApp.Auth.login(document.getElementById('email').value, document.getElementById('password').value);
                        } catch(error) {
                            errorEl.textContent = "Login Gagal: Periksa kembali email dan password Anda.";
                            errorEl.style.display = 'block';
                            throw error;
                        }
                    });
                }
            });
            document.addEventListener('click', (e) => RestoApp.Events.handle(e));
            window.addEventListener('hashchange', () => RestoApp.UI.renderPage(location.hash.substring(1) || 'page-dashboard'));

            const salesReportInput = document.getElementById('sales-report-input');
            salesReportInput.onchange = e => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async event => {
                    try { RestoApp.Events.ActionHandlers.analyzeSalesReport(event.target.result); } 
                    catch (error) { RestoApp.UI.showToast('Gagal menganalisa laporan: ' + error.message, 'error'); }
                };
                reader.readAsText(file);
                salesReportInput.value = ''; 
            };
        },
        initOnLogin() {
            RestoApp.UI.renderSidebar();
            RestoApp.API.listenToData();
        },
    }
};

// Inisialisasi halaman yang tidak memiliki logika update kompleks
['page-input-belanja-datang', 'page-input-menu-keluar', 'page-ambil-gudang', 'page-input-waste', 'page-riwayat-stok', 'page-laporan-analisa', 'page-manager-area', 'page-manager-recipes', 'page-manager-display', 'page-manager-backup'].forEach(pageId => {
    if (RestoApp.UI.Pages[pageId]) { // Pastikan fungsi render asli ada
        RestoApp.UI.Pages[pageId] = { render: RestoApp.UI.Pages[pageId] };
    }
});


RestoApp.App.init();
</script>
</body>
</html>
