<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoApp - V5.0 (Fully Functional)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Import Font --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        /* --- Color Variables --- */
        :root {
            --primary-color: #4a7c59;
            --primary-light: #6b9d7a;
            --secondary-color: #f8f9fa;
            --text-color: #2d3748;
            --text-light: #718096;
            --white-color: #ffffff;
            --border-color: #e2e8f0;
            --danger-color: #e53e3e;
            --danger-light: #fed7d7;
            --warning-color: #dd6b20;
            --warning-light: #feebc8;
            --success-color: #38a169;
            --success-light: #c6f6d5;
            --info-color: #3182ce;
            --info-light: #bee3f8;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --transition: all 0.2s ease-in-out;
        }

        /* --- Reset & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--secondary-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

        /* --- Header Styles --- */
        header { background-color: var(--primary-color); color: var(--white-color); padding: 1.25rem 1.5rem; border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; box-shadow: var(--shadow-md); position: relative; z-index: 10; }
        header h1 { font-weight: 600; font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        header h1 i { font-size: 1.75rem; }

        /* --- Main Content Styles --- */
        main { background-color: var(--white-color); border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg); box-shadow: var(--shadow-md); overflow: hidden; position: relative; }

        /* --- Page Styles --- */
        .page { display: none; padding: 1.5rem; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page.active { display: block; }

        /* --- Card Styles --- */
        .card { background: var(--white-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); transition: var(--transition); }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; }

        /* --- Button Styles --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: var(--border-radius); font-weight: 500; cursor: pointer; transition: var(--transition); border: none; font-size: 0.9rem; }
        .btn i { font-size: 1rem; }
        .btn-primary { background-color: var(--primary-color); color: var(--white-color); }
        .btn-primary:hover { background-color: var(--primary-light); }
        .btn-secondary { background-color: #6c757d; color: var(--white-color); }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: var(--danger-color); color: var(--white-color); }
        .btn-danger:hover { background-color: #c53030; }
        .btn-warning { background-color: var(--warning-color); color: var(--white-color); }
        .btn-warning:hover { background-color: #c05621; }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-success:hover { background-color: #2f855a; }
        .btn-info { background-color: var(--info-color); color: var(--white-color); }
        .btn-info:hover { background-color: #2c5282; }
        .btn-outline { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
        .btn-outline:hover { background-color: var(--secondary-color); }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8rem; }

        /* --- Form Styles --- */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); }
        .form-control { width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9rem; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.2); }

        /* --- Alert Styles --- */
        .alert { padding: 0.875rem 1.25rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .alert-warning { background-color: var(--warning-light); color: var(--warning-color); border-left: 4px solid var(--warning-color); }
        .alert-danger { background-color: var(--danger-light); color: var(--danger-color); border-left: 4px solid var(--danger-color); }
        .alert-info { background-color: var(--info-light); color: var(--info-color); border-left: 4px solid var(--info-color); }

        /* --- Toast Notification --- */
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1100; display: flex; flex-direction: column; gap: 0.75rem; max-width: 350px; }
        .toast { background-color: var(--text-color); color: var(--white-color); padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); opacity: 0; transform: translateX(100%); transition: opacity 0.3s, transform 0.3s; display: flex; align-items: center; gap: 0.75rem; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--info-color); }
        .toast i { font-size: 1.25rem; }

        /* --- Dashboard & Item List Styles --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.25rem; }
        .dashboard-card { background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: var(--transition); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; text-decoration: none; color: inherit; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-color); }
        .dashboard-card i { font-size: 2.25rem; color: var(--primary-color); }
        .dashboard-card h3 { font-size: 1rem; font-weight: 500; color: var(--text-color); }
        .item-list { display: grid; gap: 0.75rem; }
        .item-row { display: grid; grid-template-columns: minmax(0, 2fr) 120px 100px; gap: 0.75rem; align-items: center; padding: 0.75rem; border-radius: var(--border-radius); background-color: var(--secondary-color); }
        .item-row:hover { background-color: #edf2f7; }
        .item-label { font-weight: 500; word-break: break-word; }
        .item-unit, .stock-hint { color: var(--text-light); font-size: 0.85rem; }
        .editable-item-row { display: grid; grid-template-columns: 30px 1fr 100px 40px; gap: 0.75rem; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); transition: var(--transition); }
        .editable-item-row:last-child { border-bottom: none; }
        .editable-item-row.dragging { opacity: 0.5; background-color: #ebf8ff; }
        .drag-handle { cursor: grab; text-align: center; color: var(--text-light); font-size: 1.25rem; }
        .drag-handle:active { cursor: grabbing; }

        /* --- Category & Table Styles --- */
        .category-group { margin-bottom: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1.25rem; background-color: var(--white-color); }
        .category-title { font-weight: 600; color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.5rem; }
        .table-container { overflow-x: auto; margin-bottom: 1.5rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .table th, .table td { padding: 0.875rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .table th { background-color: #f7fafc; font-weight: 600; color: var(--text-color); }
        .table tr:last-child td { border-bottom: none; }
        .table tr:hover td { background-color: var(--secondary-color); }
        .time-display { text-align: center; margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-light); }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .item-row, .editable-item-row { grid-template-columns: 1fr 80px 60px; }
            .editable-item-row { grid-template-columns: 30px 1fr 60px 30px; }
        }
        @media (max-width: 576px) {
            .container { padding: 0.5rem; }
            .page { padding: 1rem; }
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="toast-container"></div>
        
        <header>
            <h1><i class="fas fa-utensils"></i> RestoApp V5.0</h1>
        </header>
        
        <main id="main-content">
            <div id="page-dashboard" class="page active"></div>
            <div id="page-input-belanja" class="page"></div>
            <div id="page-edit-belanja" class="page"></div>
            <div id="page-input-belanja-datang" class="page"></div>
            <div id="page-input-menu-keluar" class="page"></div>
            <div id="page-ambil-gudang" class="page"></div>
            <div id="page-manager-area" class="page"></div>
            <div id="page-riwayat-stok" class="page"></div>
        </main>
    </div>

<script>
const App = {
    data: {
        initialMasterItems: [
            { id: 1, name: "Bawang Merah", category: "Bumbu", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 0.5 },
            { id: 2, name: "Bawang Putih", category: "Bumbu", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 0.5 },
            { id: 3, name: "Cabai Merah", category: "Sayuran", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 0.2 },
            { id: 4, name: "Ayam Paha", category: "Daging", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 2 },
            { id: 5, name: "Beras", category: "Pokok", unit: "kg", purchaseUnit: "karung", purchaseUnitConversion: 25, stock: 0, minStock: 5 },
            { id: 6, name: "Minyak Goreng", category: "Pokok", unit: "liter", purchaseUnit: "jerigen", purchaseUnitConversion: 5, stock: 0, minStock: 1 },
            { id: 7, name: "Kecap Manis", category: "Bumbu", unit: "ml", purchaseUnit: "botol", purchaseUnitConversion: 600, stock: 0, minStock: 300 },
            { id: 8, name: "Garam", category: "Bumbu", unit: "gram", purchaseUnit: "bks", purchaseUnitConversion: 250, stock: 0, minStock: 250 },
            { id: 9, name: "Telur Ayam", category: "Daging", unit: "butir", purchaseUnit: "kg", purchaseUnitConversion: 16, stock: 0, minStock: 10 },
            { id: 10, name: "Teh Celup", category: "Minuman", unit: "pcs", purchaseUnit: "box", purchaseUnitConversion: 25, stock: 0, minStock: 25 },
            { id: 11, name: "Gula Pasir", category: "Pokok", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 1 },
            { id: 13, name: "Saus Sambal", category: "Gudang", unit: "ml", purchaseUnit: "botol", purchaseUnitConversion: 600, stock: 0, minStock: 600 },
            { id: 14, name: "Gas LPG 12kg", category: "Operasional", unit: "tabung", purchaseUnit: "tabung", purchaseUnitConversion: 1, stock: 0, minStock: 1 },
        ],
        initialRecipes: {
            "Nasi Goreng Spesial": { unit: "porsi", ingredients: [ { itemId: 5, qty: 0.15 }, { itemId: 9, qty: 1 }, { itemId: 1, qty: 0.02 }, { itemId: 2, qty: 0.01 }, { itemId: 7, qty: 15 }, { itemId: 8, qty: 2 }, { itemId: 6, qty: 0.02 } ] },
            "Ayam Bakar Madu": { unit: "porsi", ingredients: [ { itemId: 4, qty: 0.25 }, { itemId: 7, qty: 20 }, { itemId: 2, qty: 0.015}, { itemId: 11, qty: 0.01} ] },
            "Es Teh Manis": { unit: "gelas", ingredients: [ { itemId: 10, qty: 1 }, { itemId: 11, qty: 0.02 } ] }
        },
        initialGudangItemIds: [13, 14]
    },
    
    db: {
        get: (key) => JSON.parse(localStorage.getItem(key)) || null,
        set: (key, value) => localStorage.setItem(key, JSON.stringify(value))
    },

    init() {
        const initialDataMap = {
            masterItems: this.data.initialMasterItems.map((item, index) => ({...item, sortOrder: index})),
            recipes: this.data.initialRecipes,
            gudangItemIds: this.data.initialGudangItemIds,
            menuKeluarActive: Object.keys(this.data.initialRecipes),
            shoppingLists: [],
            stockTransactions: []
        };
        
        Object.keys(initialDataMap).forEach(key => {
            if (this.db.get(key) === null) {
                this.db.set(key, initialDataMap[key]);
            }
        });
        
        document.getElementById('main-content').addEventListener('click', this.handle.click.bind(this));
        
        this.utils.updateTime();
        setInterval(this.utils.updateTime, 1000);
        this.render.page('page-dashboard');
    },

    showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const page = document.getElementById(pageId);
        if (page) {
            page.classList.add('active');
            window.scrollTo(0, 0);
        }
    },
    
    render: {
        page(pageId, data = null) {
            const targetPage = document.getElementById(pageId);
            if (!targetPage) return;
            
            targetPage.innerHTML = '';

            const renderMap = {
                'page-dashboard': this.dashboardPage,
                'page-input-belanja': this.shoppingListForm,
                'page-input-belanja-datang': this.stockInForm,
                'page-input-menu-keluar': (page) => this.stockOutPage(page, 'menu'),
                'page-ambil-gudang': (page) => this.stockOutPage(page, 'gudang'),
                'page-manager-area': this.managerArea,
                'page-riwayat-stok': this.transactionHistoryPage,
            };

            if (renderMap[pageId]) {
                renderMap[pageId].call(this, targetPage, data);
            }
            App.showPage(pageId);
        },
        
        dashboardPage(targetPage) {
            targetPage.innerHTML = `
                <div id="dashboard-alerts"></div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div><strong>Peringatan:</strong> Aplikasi ini menyimpan data di browser Anda. Gunakan fitur Export Data secara berkala.</div>
                </div>
                <div class="dashboard-grid">
                    <a href="#" class="dashboard-card" data-page="page-input-belanja-datang"><i class="fas fa-truck-loading"></i><h3>Input Belanja Datang</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-input-menu-keluar"><i class="fas fa-utensils"></i><h3>Input Menu Keluar</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-ambil-gudang"><i class="fas fa-warehouse"></i><h3>Ambil dari Gudang</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-input-belanja"><i class="fas fa-shopping-cart"></i><h3>Input List Belanja</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-riwayat-stok"><i class="fas fa-history"></i><h3>Riwayat Stok</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-manager-area"><i class="fas fa-user-tie"></i><h3>Manager Area</h3></a>
                </div>
                <div class="time-display"><i class="far fa-clock"></i> <span id="current-time"></span></div>`;
            App.utils.updateTime();
            this.lowStockAlerts();
        },
        
        lowStockAlerts() {
            const container = document.getElementById('dashboard-alerts');
            if (!container) return;
            const masterItems = App.db.get('masterItems');
            const lowStockItems = masterItems.filter(item => (item.stock || 0) < (item.minStock || 0));
            if (lowStockItems.length > 0) {
                const itemsList = lowStockItems.map(item => `<li><strong>${item.name}</strong> (Sisa: ${item.stock} ${item.unit}, Min: ${item.minStock} ${item.unit})</li>`).join('');
                container.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i><div><strong>Peringatan Stok Rendah:</strong><ul style="margin-left: 20px; margin-top: 5px;">${itemsList}</ul></div></div>`;
            } else {
                container.innerHTML = '';
            }
        },
        
        shoppingListForm(targetPage) {
            const masterItems = App.db.get('masterItems').sort((a, b) => a.sortOrder - b.sortOrder);
            const categories = [...new Set(masterItems.map(item => item.category))];
            
            let formHTML = categories.map(cat => {
                let itemsHTML = masterItems.filter(item => item.category === cat).map(item => `
                    <div class="item-row">
                        <label for="shopitem-${item.id}" class="item-label">${item.name}<div class="stock-hint">Stok: ${item.stock.toFixed(2)} ${item.unit}</div></label>
                        <input type="number" id="shopitem-${item.id}" class="form-control" placeholder="Jumlah" min="0" step="any" data-item-id="${item.id}">
                        <span class="item-unit">${item.purchaseUnit}</span>
                    </div>
                `).join('');
                return `<div class="category-group"><h3 class="category-title"><i class="fas fa-tags"></i> ${cat}</h3><div class="item-list">${itemsHTML}</div></div>`;
            }).join('');

            targetPage.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-shopping-cart"></i><span>Buat List Belanja</span></div>
                        <button class="btn btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button>
                    </div>
                    ${formHTML}
                    <button class="btn btn-primary" style="width:100%" data-action="save-shopping-list"><i class="fas fa-save"></i> Simpan List Belanja</button>
                </div>`;
        },

        stockInForm(targetPage) {
            const shoppingLists = App.db.get('shoppingLists') || [];
            let content;

            if (shoppingLists.length === 0) {
                content = `<div class="alert alert-info"><i class="fas fa-info-circle"></i> Tidak ada list belanja yang pending.</div>`;
            } else {
                content = shoppingLists.map(list => `
                    <div class="card" style="cursor:pointer;" data-action="select-pending-list" data-date="${list.date}">
                        <strong>List Belanja - ${new Date(list.date).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</strong>
                        <div>${list.items.length} item</div>
                    </div>
                `).join('');
            }
            
            targetPage.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-truck-loading"></i><span>Pilih List Belanja untuk Diproses</span></div>
                        <button class="btn btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button>
                    </div>
                    ${content}
                </div>`;
        },

        stockInDetail(targetPage, listDate) {
            const shoppingList = App.db.get('shoppingLists').find(l => l.date === listDate);
            if (!shoppingList) return App.utils.showToast('List belanja tidak ditemukan', 'error');
            const masterItems = App.db.get('masterItems');

            const itemsHTML = shoppingList.items.map(item => {
                const masterItem = masterItems.find(mi => mi.id === item.id);
                if (!masterItem) return '';
                return `
                    <div class="item-row">
                        <label for="stockin-${item.id}" class="item-label">${masterItem.name}</label>
                        <input type="number" id="stockin-${item.id}" class="form-control" value="${item.qty}" min="0" step="any">
                        <span class="item-unit">${masterItem.purchaseUnit}</span>
                    </div>`;
            }).join('');

            targetPage.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-clipboard-check"></i><span>Konfirmasi Barang Datang</span></div>
                        <button class="btn btn-secondary" data-page="page-input-belanja-datang"><i class="fas fa-arrow-left"></i> Kembali</button>
                    </div>
                    <div class="category-group"><div class="item-list">${itemsHTML}</div></div>
                    <div style="display:flex; gap: 10px;">
                        <button class="btn btn-primary" style="flex-grow:1;" data-action="process-stock-in" data-date="${listDate}"><i class="fas fa-check"></i> Proses & Tambah Stok</button>
                        <button class="btn btn-danger" data-action="cancel-shopping-list" data-date="${listDate}"><i class="fas fa-trash"></i> Batalkan List</button>
                    </div>
                </div>`;
        },

        stockOutPage(targetPage, type) {
            const masterItems = App.db.get('masterItems');
            const recipes = App.db.get('recipes');
            let itemsToRender, title, icon;

            if (type === 'gudang') {
                title = "Ambil Barang dari Gudang"; icon = "fa-warehouse";
                const gudangItemIds = App.db.get('gudangItemIds');
                itemsToRender = masterItems.filter(item => gudangItemIds.includes(item.id)).sort((a,b) => a.sortOrder - b.sortOrder);
            } else {
                title = "Input Menu Keluar"; icon = "fa-utensils";
                const menuKeluarActive = App.db.get('menuKeluarActive');
                itemsToRender = menuKeluarActive.map(key => ({ name: key, ...recipes[key] })).sort((a,b) => a.name.localeCompare(b.name));
            }

            let formHTML = itemsToRender.map(item => {
                let stockHint = '';
                if (type === 'gudang') {
                    stockHint = `Stok: ${(item.stock || 0).toFixed(2)} ${item.unit}`;
                } else {
                    const availablePortions = App.utils.calculateAvailablePortions(item.name);
                    stockHint = `Stok cukup untuk: ${availablePortions} ${item.unit}`;
                }
                const itemNameId = item.name.replace(/\s+/g, '-');
                return `<div class="item-row">
                    <label for="stockout-${itemNameId}" class="item-label"><i class="fas fa-cube"></i> ${item.name}<div class="stock-hint">${stockHint}</div></label>
                    <input type="number" id="stockout-${itemNameId}" class="form-control" data-name="${item.name}" placeholder="Jumlah" min="0" step="any">
                    <span class="item-unit">${item.unit}</span>
                </div>`;
            }).join('');

            targetPage.innerHTML = `
                <div class="card">
                    <div class="card-header"><div class="card-title"><i class="fas ${icon}"></i><span>${title}</span></div><button class="btn btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div>
                    <div class="category-group"><div class="item-list" id="stockout-list">${formHTML}</div></div>
                    <button class="btn btn-primary" style="width:100%" data-action="process-stock-out" data-type="${type}"><i class="fas fa-check"></i> Proses Pengeluaran Stok</button>
                </div>`;
        },

        managerArea(targetPage) {
            targetPage.innerHTML = `
                <div class="card">
                    <div class="card-header"><div class="card-title"><i class="fas fa-user-tie"></i><span>Manager Area</span></div><button class="btn btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div>
                    <div class="category-group">
                        <h3 class="category-title"><i class="fas fa-save"></i> Cadangkan & Pulihkan Data</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" data-action="export-data"><i class="fas fa-download"></i> Export Data</button>
                            <button class="btn btn-warning" data-action="import-data"><i class="fas fa-upload"></i> Import Data</button>
                            <input type="file" id="import-file-input" accept=".json" style="display: none;">
                        </div>
                    </div>
                    <div class="category-group"><h3 class="category-title"><i class="fas fa-sliders-h"></i> Atur Tampilan Menu & Gudang</h3><div id="display-config-container"></div></div>
                    <div class="category-group"><h3 class="category-title"><i class="fas fa-book"></i> Manajemen Resep</h3><div id="recipe-list-container"></div></div>
                    <div class="category-group" id="db-editor">
                        <h3 class="category-title"><i class="fas fa-database"></i> Editor Database Barang</h3>
                        <div style="display:flex; justify-content:flex-end; margin-bottom:10px;"><button class="btn btn-success" data-action="save-item-order"><i class="fas fa-save"></i> Simpan Urutan</button></div>
                        <div id="add-item-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                            <input type="hidden" id="edit-item-id">
                            <input class="form-control" type="text" id="item-name" placeholder="Nama Barang">
                            <input class="form-control" type="text" id="item-category" placeholder="Kategori" list="category-suggestions"><datalist id="category-suggestions"></datalist>
                            <input class="form-control" type="text" id="item-unit" placeholder="Satuan Stok">
                            <input class="form-control" type="text" id="item-purchase-unit" placeholder="Satuan Beli">
                            <input class="form-control" type="number" id="item-conversion" placeholder="Konversi" min="0">
                            <input class="form-control" type="number" id="item-min-stock" placeholder="Stok Minimum" min="0">
                            <div id="form-buttons" style="display:flex; gap: 10px; grid-column: 1 / -1;"><button class="btn btn-primary" data-action="save-item" id="save-item-btn" style="flex-grow: 1;"><i class="fas fa-save"></i> Simpan Barang</button><button class="btn btn-secondary" data-action="cancel-edit" id="cancel-edit-btn" style="display: none;"><i class="fas fa-times"></i> Batal</button></div>
                        </div>
                        <div class="table-container"><table class="table" id="db-editor-table"><thead><tr><th style="width: 50px;">Urutan</th><th>Nama</th><th>Kategori</th><th>Stok</th><th>Stok Min</th><th style="width: 150px;">Aksi</th></tr></thead><tbody id="db-editor-tbody"></tbody></table></div>
                    </div>
                </div>`;
            this.managerSubRenders();
        },
        
        managerSubRenders() {
            // Render DB Editor Table
            const masterItems = App.db.get('masterItems').sort((a, b) => a.sortOrder - b.sortOrder);
            const tbody = document.getElementById('db-editor-tbody');
            tbody.innerHTML = masterItems.map(item => `
                <tr class="editable-item-row" draggable="true" data-id="${item.id}">
                    <td class="drag-handle" style="text-align:center; vertical-align:middle; cursor:grab;"><i class="fas fa-grip-vertical"></i></td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.stock.toFixed(2)} ${item.unit}</td>
                    <td>${item.minStock} ${item.unit}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" data-action="edit-item" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn btn-sm btn-danger" data-action="delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
            App.utils.addDragDropHandlers(tbody);
            this.populateCategoryDatalist();

            // Render Recipe List
            const recipes = App.db.get('recipes');
            const recipeContainer = document.getElementById('recipe-list-container');
            recipeContainer.innerHTML = Object.keys(recipes).map(name => `<div class="item-row"><div>${name}</div><div>${recipes[name].unit}</div><button class="btn btn-sm btn-warning" data-action="edit-recipe" data-name="${name}">Edit</button></div>`).join('') || 'Belum ada resep.';

            // Render Display Config
            this.displayConfigEditor(document.getElementById('display-config-container'));
        },

        displayConfigEditor(targetContainer) {
            const recipes = App.db.get('recipes');
            const masterItems = App.db.get('masterItems');
            const menuKeluarActive = App.db.get('menuKeluarActive');
            const gudangItemIds = App.db.get('gudangItemIds');

            const menuCheckboxes = Object.keys(recipes).sort().map(name => `
                <label><input type="checkbox" data-type="menu" value="${name}" ${menuKeluarActive.includes(name) ? 'checked' : ''}> ${name}</label>
            `).join('');

            const gudangCheckboxes = masterItems.filter(item => item.category === 'Gudang' || item.category === 'Operasional').sort((a,b)=>a.name.localeCompare(b.name)).map(item => `
                <label><input type="checkbox" data-type="gudang" value="${item.id}" ${gudangItemIds.includes(item.id) ? 'checked' : ''}> ${item.name}</label>
            `).join('');
            
            targetContainer.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;" id="display-config-form">
                    <div><h4>Tampilan Menu Keluar</h4><div style="display:flex; flex-direction:column;">${menuCheckboxes}</div></div>
                    <div><h4>Tampilan Ambil Gudang</h4><div style="display:flex; flex-direction:column;">${gudangCheckboxes}</div></div>
                </div>
                <button class="btn btn-primary" style="margin-top:1rem;" data-action="save-display-config">Simpan Pengaturan Tampilan</button>
            `;
        },
        
        transactionHistoryPage(targetPage) {
            const transactions = App.db.get('stockTransactions') || [];
            const masterItems = App.db.get('masterItems');
            let content = '';
            if (transactions.length === 0) {
                content = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Belum ada riwayat transaksi.</div>';
            } else {
                const rows = [...transactions].reverse().map(t => {
                    const item = masterItems.find(i => i.id === t.itemId);
                    const changeClass = t.change > 0 ? 'color: var(--success-color);' : 'color: var(--danger-color);';
                    const changeSign = t.change > 0 ? '+' : '';
                    return `
                        <tr>
                            <td>${new Date(t.date).toLocaleString('id-ID')}</td>
                            <td>${item ? item.name : 'Barang Dihapus'}</td>
                            <td>${t.type}</td>
                            <td style="${changeClass} font-weight: 500;">${changeSign}${t.change.toFixed(2)} ${item ? item.unit : ''}</td>
                            <td>${t.newStock.toFixed(2)} ${item ? item.unit : ''}</td>
                        </tr>`;
                }).join('');
                content = `<div class="table-container"><table class="table"><thead><tr><th>Waktu</th><th>Barang</th><th>Jenis</th><th>Perubahan</th><th>Sisa Stok</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            }
            targetPage.innerHTML = `<div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-history"></i><span>Riwayat Transaksi Stok</span></div><button class="btn btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div>${content}</div>`;
        },

        populateCategoryDatalist() {
            const masterItems = App.db.get('masterItems');
            const categories = [...new Set(masterItems.map(item => item.category))];
            const datalist = document.getElementById('category-suggestions');
            if(datalist) datalist.innerHTML = categories.map(cat => `<option value="${cat}">`).join('');
        }
    },
    
    actions: {
        saveShoppingList() {
            const inputs = document.querySelectorAll('#page-input-belanja input[data-item-id]');
            const items = [];
            inputs.forEach(input => {
                const qty = parseFloat(input.value);
                if (qty > 0) {
                    items.push({ id: parseInt(input.dataset.itemId), qty: qty });
                }
            });

            if (items.length === 0) {
                return App.utils.showToast('List belanja kosong, tidak ada yang disimpan.', 'info');
            }
            const shoppingLists = App.db.get('shoppingLists') || [];
            shoppingLists.push({ date: new Date().toISOString(), items: items });
            App.db.set('shoppingLists', shoppingLists);
            App.utils.showToast('List belanja berhasil disimpan!', 'success');
            App.render.page('page-dashboard');
        },
        
        processStockIn(listDate) {
            const shoppingList = App.db.get('shoppingLists').find(l => l.date === listDate);
            let masterItems = App.db.get('masterItems');
            let transactions = App.db.get('stockTransactions');

            shoppingList.items.forEach(item => {
                const qtyReceived = parseFloat(document.getElementById(`stockin-${item.id}`).value);
                if (qtyReceived > 0) {
                    const itemIndex = masterItems.findIndex(mi => mi.id === item.id);
                    if (itemIndex > -1) {
                        const masterItem = masterItems[itemIndex];
                        const stockIncrease = qtyReceived * masterItem.purchaseUnitConversion;
                        const oldStock = masterItem.stock;
                        masterItem.stock += stockIncrease;

                        transactions.push({
                            date: new Date().toISOString(),
                            itemId: masterItem.id,
                            type: 'Stok Masuk',
                            change: stockIncrease,
                            newStock: masterItem.stock
                        });
                    }
                }
            });

            const updatedShoppingLists = App.db.get('shoppingLists').filter(l => l.date !== listDate);
            App.db.set('shoppingLists', updatedShoppingLists);
            App.db.set('masterItems', masterItems);
            App.db.set('stockTransactions', transactions);
            App.utils.showToast('Stok berhasil diperbarui!', 'success');
            App.render.page('page-dashboard');
        },
        
        cancelShoppingList(date) {
            if (!confirm('Apakah Anda yakin ingin membatalkan list belanja ini?')) return;
            let shoppingLists = App.db.get('shoppingLists');
            shoppingLists = shoppingLists.filter(l => l.date !== date);
            App.db.set('shoppingLists', shoppingLists);
            App.utils.showToast('List belanja dibatalkan.', 'success');
            App.render.page('page-input-belanja-datang');
        },

        processStockOut(type) {
            const inputs = document.querySelectorAll('#stockout-list input[type="number"]');
            let masterItems = App.db.get('masterItems');
            let recipes = App.db.get('recipes');
            let transactions = App.db.get('stockTransactions');
            let changesMade = false;

            inputs.forEach(input => {
                const qty = parseFloat(input.value);
                if (qty > 0) {
                    changesMade = true;
                    const itemName = input.dataset.name;
                    if (type === 'menu') {
                        const recipe = recipes[itemName];
                        recipe.ingredients.forEach(ing => {
                            const itemIndex = masterItems.findIndex(mi => mi.id === ing.itemId);
                            if (itemIndex > -1) {
                                const stockDecrease = ing.qty * qty;
                                masterItems[itemIndex].stock -= stockDecrease;
                                transactions.push({ date: new Date().toISOString(), itemId: ing.itemId, type: `Keluar Menu: ${itemName}`, change: -stockDecrease, newStock: masterItems[itemIndex].stock });
                            }
                        });
                    } else { // type === 'gudang'
                        const itemIndex = masterItems.findIndex(mi => mi.name === itemName);
                        if (itemIndex > -1) {
                            masterItems[itemIndex].stock -= qty;
                            transactions.push({ date: new Date().toISOString(), itemId: masterItems[itemIndex].id, type: 'Ambil Gudang', change: -qty, newStock: masterItems[itemIndex].stock });
                        }
                    }
                }
            });

            if (!changesMade) {
                return App.utils.showToast('Tidak ada jumlah yang diinput.', 'info');
            }

            App.db.set('masterItems', masterItems);
            App.db.set('stockTransactions', transactions);
            App.utils.showToast('Stok berhasil dikeluarkan!', 'success');
            App.render.page(type === 'menu' ? 'page-input-menu-keluar' : 'page-ambil-gudang');
        },

        saveItem() {
            const id = document.getElementById('edit-item-id').value;
            const newItemData = {
                name: document.getElementById('item-name').value.trim(),
                category: document.getElementById('item-category').value.trim(),
                unit: document.getElementById('item-unit').value.trim(),
                purchaseUnit: document.getElementById('item-purchase-unit').value.trim() || document.getElementById('item-unit').value.trim(),
                purchaseUnitConversion: parseFloat(document.getElementById('item-conversion').value) || 1,
                minStock: parseFloat(document.getElementById('item-min-stock').value) || 0
            };
            
            if (!newItemData.name || !newItemData.category || !newItemData.unit) return App.utils.showToast('Nama, Kategori, dan Satuan Stok harus diisi!', 'error');
            
            let masterItems = App.db.get('masterItems');
            if (id) {
                const itemIndex = masterItems.findIndex(item => item.id == id);
                masterItems[itemIndex] = { ...masterItems[itemIndex], ...newItemData };
                App.utils.showToast('Barang berhasil diperbarui!', 'success');
            } else {
                const newId = masterItems.length > 0 ? Math.max(...masterItems.map(item => item.id)) + 1 : 1;
                const newSortOrder = masterItems.length > 0 ? Math.max(...masterItems.map(item => item.sortOrder)) + 1 : 0;
                masterItems.push({ ...newItemData, id: newId, stock: 0, sortOrder: newSortOrder });
                App.utils.showToast('Barang baru berhasil ditambahkan!', 'success');
            }
            
            App.db.set('masterItems', masterItems);
            this.cancelEdit();
            App.render.managerSubRenders();
        },

        editItem(id) {
            const item = App.db.get('masterItems').find(item => item.id == id);
            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-category').value = item.category;
            document.getElementById('item-unit').value = item.unit;
            document.getElementById('item-purchase-unit').value = item.purchaseUnit || '';
            document.getElementById('item-conversion').value = item.purchaseUnitConversion || '';
            document.getElementById('item-min-stock').value = item.minStock || 0;
            document.getElementById('save-item-btn').innerHTML = '<i class="fas fa-check"></i> Update Barang';
            document.getElementById('cancel-edit-btn').style.display = 'inline-flex';
            document.getElementById('add-item-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
        },

        cancelEdit() {
            document.getElementById('add-item-form').reset();
            document.getElementById('edit-item-id').value = '';
            document.getElementById('save-item-btn').innerHTML = '<i class="fas fa-save"></i> Simpan Barang';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        },
        
        deleteItem(id) {
            let masterItems = App.db.get('masterItems');
            const item = masterItems.find(item => item.id == id);
            if ((item.stock || 0) > 0) return App.utils.showToast('Tidak dapat menghapus, barang masih ada sisa stok.', 'error');
            const recipes = App.db.get('recipes');
            for (const menuName in recipes) {
                if (recipes[menuName].ingredients.some(ing => ing.itemId == id)) {
                    return App.utils.showToast(`Gagal! "${item.name}" masih digunakan di resep "${menuName}".`, 'error');
                }
            }
            if (!confirm(`Apakah Anda yakin ingin menghapus "${item.name}"?`)) return;
            masterItems = masterItems.filter(item => item.id != id);
            App.db.set('masterItems', masterItems);
            App.render.managerSubRenders();
            App.utils.showToast('Barang berhasil dihapus.', 'success');
        },
        
        saveItemOrder() {
            const masterItems = App.db.get('masterItems');
            const rows = document.querySelectorAll('#db-editor-tbody tr');
            const newOrderMap = new Map();
            rows.forEach((row, index) => {
                newOrderMap.set(parseInt(row.dataset.id), index);
            });
            masterItems.forEach(item => {
                item.sortOrder = newOrderMap.get(item.id);
            });
            App.db.set('masterItems', masterItems);
            App.utils.showToast('Urutan barang berhasil disimpan!', 'success');
            App.render.managerSubRenders();
        },

        saveDisplayConfig() {
            const checkboxes = document.querySelectorAll('#display-config-form input[type="checkbox"]');
            const menuKeluarActive = [];
            const gudangItemIds = [];

            checkboxes.forEach(cb => {
                if(cb.checked) {
                    if(cb.dataset.type === 'menu') {
                        menuKeluarActive.push(cb.value);
                    } else {
                        gudangItemIds.push(parseInt(cb.value));
                    }
                }
            });
            App.db.set('menuKeluarActive', menuKeluarActive);
            App.db.set('gudangItemIds', gudangItemIds);
            App.utils.showToast('Pengaturan tampilan berhasil disimpan!', 'success');
        },

        exportData() { /* Omitted, same as before */ },
        importData() { /* Omitted, same as before */ }
    },
    
    handle: {
        click(event) {
            const target = event.target.closest('[data-page], [data-action]');
            if (!target) return;
            event.preventDefault();
            const { page, action, date, id, name, type, message } = target.dataset;

            if (page) App.render.page(page);
            else if (action) {
                const actionMap = {
                    'save-shopping-list': () => App.actions.saveShoppingList(),
                    'select-pending-list': () => App.render.stockInDetail(document.getElementById('page-input-belanja-datang'), date),
                    'process-stock-in': () => App.actions.processStockIn(date),
                    'cancel-shopping-list': () => App.actions.cancelShoppingList(date),
                    'process-stock-out': () => App.actions.processStockOut(type),
                    'save-item': () => App.actions.saveItem(),
                    'edit-item': () => App.actions.editItem(id),
                    'cancel-edit': () => App.actions.cancelEdit(),
                    'delete-item': () => App.actions.deleteItem(id),
                    'save-item-order': () => App.actions.saveItemOrder(),
                    'edit-recipe': () => App.render.recipeEditor(document.getElementById('manager-area-container'), name),
                    'save-display-config': () => App.actions.saveDisplayConfig(),
                    'export-data': () => App.actions.exportData(),
                    'import-data': () => App.actions.importData(),
                    'show-alert': () => App.utils.showToast(message, 'info'),
                };
                if(actionMap[action]) actionMap[action]();
            }
        }
    },

    utils: {
        updateTime() {
            const timeEl = document.getElementById('current-time');
            if (timeEl) timeEl.textContent = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'medium' });
        },

        showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const iconClass = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' }[type];
            toast.innerHTML = `<i class="fas ${iconClass}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        },

        addDragDropHandlers(container) {
            container.addEventListener('dragstart', e => {
                if (e.target.classList.contains('editable-item-row')) {
                    e.target.classList.add('dragging');
                }
            });
            container.addEventListener('dragend', e => {
                if (e.target.classList.contains('editable-item-row')) {
                    e.target.classList.remove('dragging');
                }
            });
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = this.getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            });
        },
        
        getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.editable-item-row:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        },
        
        calculateAvailablePortions(menuName) {
            const recipes = App.db.get('recipes');
            const masterItems = App.db.get('masterItems');
            const recipe = recipes[menuName];
            if (!recipe || !recipe.ingredients) return 0;
            let minPortions = Infinity;
            recipe.ingredients.forEach(ing => {
                const item = masterItems.find(mi => mi.id === ing.itemId);
                if (item && ing.qty > 0) {
                    const portionsForItem = Math.floor((item.stock || 0) / ing.qty);
                    minPortions = Math.min(minPortions, portionsForItem);
                } else {
                    minPortions = 0;
                }
            });
            return minPortions === Infinity ? 0 : minPortions;
        }
    }
};

document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
