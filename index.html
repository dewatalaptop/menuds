<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoApp - V5.1 (Recipe Editor)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Import Font --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        /* --- Color Variables --- */
        :root {
            --primary-color: #4a7c59;
            --primary-light: #6b9d7a;
            --secondary-color: #f8f9fa;
            --text-color: #2d3748;
            --text-light: #718096;
            --white-color: #ffffff;
            --border-color: #e2e8f0;
            --danger-color: #e53e3e;
            --danger-light: #fed7d7;
            --warning-color: #dd6b20;
            --warning-light: #feebc8;
            --success-color: #38a169;
            --success-light: #c6f6d5;
            --info-color: #3182ce;
            --info-light: #bee3f8;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --transition: all 0.2s ease-in-out;
        }

        /* --- Reset & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--secondary-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

        /* --- Header Styles --- */
        header { background-color: var(--primary-color); color: var(--white-color); padding: 1.25rem 1.5rem; border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; box-shadow: var(--shadow-md); position: relative; z-index: 10; }
        header h1 { font-weight: 600; font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        header h1 i { font-size: 1.75rem; }

        /* --- Main Content Styles --- */
        main { background-color: var(--white-color); border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg); box-shadow: var(--shadow-md); overflow: hidden; position: relative; }

        /* --- Page Styles --- */
        .page { display: none; padding: 1.5rem; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page.active { display: block; }

        /* --- Card Styles --- */
        .card { background: var(--white-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); transition: var(--transition); }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; }

        /* --- Button Styles --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: var(--border-radius); font-weight: 500; cursor: pointer; transition: var(--transition); border: none; font-size: 0.9rem; }
        .btn i { font-size: 1rem; }
        .btn-primary { background-color: var(--primary-color); color: var(--white-color); }
        .btn-primary:hover { background-color: var(--primary-light); }
        .btn-secondary { background-color: #6c757d; color: var(--white-color); }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: var(--danger-color); color: var(--white-color); }
        .btn-danger:hover { background-color: #c53030; }
        .btn-warning { background-color: var(--warning-color); color: var(--white-color); }
        .btn-warning:hover { background-color: #c05621; }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-success:hover { background-color: #2f855a; }
        .btn-info { background-color: var(--info-color); color: var(--white-color); }
        .btn-info:hover { background-color: #2c5282; }
        .btn-outline { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
        .btn-outline:hover { background-color: var(--secondary-color); }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8rem; }

        /* --- Form Styles --- */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); }
        .form-control { width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9rem; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.2); }

        /* --- Alert Styles --- */
        .alert { padding: 0.875rem 1.25rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .alert-warning { background-color: var(--warning-light); color: var(--warning-color); border-left: 4px solid var(--warning-color); }
        .alert-danger { background-color: var(--danger-light); color: var(--danger-color); border-left: 4px solid var(--danger-color); }
        .alert-info { background-color: var(--info-light); color: var(--info-color); border-left: 4px solid var(--info-color); }

        /* --- Toast Notification --- */
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1100; display: flex; flex-direction: column; gap: 0.75rem; max-width: 350px; }
        .toast { background-color: var(--text-color); color: var(--white-color); padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); opacity: 0; transform: translateX(100%); transition: opacity 0.3s, transform 0.3s; display: flex; align-items: center; gap: 0.75rem; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--info-color); }
        .toast i { font-size: 1.25rem; }

        /* --- Dashboard & Item List Styles --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.25rem; }
        .dashboard-card { background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: var(--transition); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; text-decoration: none; color: inherit; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-color); }
        .dashboard-card i { font-size: 2.25rem; color: var(--primary-color); }
        .dashboard-card h3 { font-size: 1rem; font-weight: 500; color: var(--text-color); }
        .item-list { display: grid; gap: 0.75rem; }
        .item-row { display: grid; grid-template-columns: minmax(0, 2fr) 120px 100px; gap: 0.75rem; align-items: center; padding: 0.75rem; border-radius: var(--border-radius); background-color: var(--secondary-color); }
        .item-row:hover { background-color: #edf2f7; }
        .item-label { font-weight: 500; word-break: break-word; }
        .item-unit, .stock-hint { color: var(--text-light); font-size: 0.85rem; }
        .editable-item-row { display: grid; grid-template-columns: 30px 1fr 100px 40px; gap: 0.75rem; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); transition: var(--transition); }
        .editable-item-row:last-child { border-bottom: none; }
        .editable-item-row.dragging { opacity: 0.5; background-color: #ebf8ff; }
        .drag-handle { cursor: grab; text-align: center; color: var(--text-light); font-size: 1.25rem; }
        .drag-handle:active { cursor: grabbing; }

        /* --- Category & Table Styles --- */
        .category-group { margin-bottom: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1.25rem; background-color: var(--white-color); }
        .category-title { font-weight: 600; color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
        .table-container { overflow-x: auto; margin-bottom: 1.5rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .table th, .table td { padding: 0.875rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .table th { background-color: #f7fafc; font-weight: 600; color: var(--text-color); }
        .table tr:last-child td { border-bottom: none; }
        .table tr:hover td { background-color: var(--secondary-color); }
        .time-display { text-align: center; margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-light); }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .item-row, .editable-item-row { grid-template-columns: 1fr 80px 60px; }
            .editable-item-row { grid-template-columns: 30px 1fr 60px 30px; }
        }
        @media (max-width: 576px) {
            .container { padding: 0.5rem; }
            .page { padding: 1rem; }
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="toast-container"></div>
        
        <header>
            <h1><i class="fas fa-utensils"></i> RestoApp V5.1</h1>
        </header>
        
        <main id="main-content">
            <div id="page-dashboard" class="page active"></div>
            <div id="page-input-belanja" class="page"></div>
            <div id="page-edit-belanja" class="page"></div>
            <div id="page-input-belanja-datang" class="page"></div>
            <div id="page-input-menu-keluar" class="page"></div>
            <div id="page-ambil-gudang" class="page"></div>
            <div id="page-manager-area" class="page"></div>
            <div id="page-riwayat-stok" class="page"></div>
        </main>
    </div>

<script>
const App = {
    data: {
        initialMasterItems: [
            { id: 1, name: "Bawang Merah", category: "Bumbu", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 0.5 },
            { id: 2, name: "Bawang Putih", category: "Bumbu", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 0.5 },
            { id: 3, name: "Cabai Merah", category: "Sayuran", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 0.2 },
            { id: 4, name: "Ayam Paha", category: "Daging", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 2 },
            { id: 5, name: "Beras", category: "Pokok", unit: "kg", purchaseUnit: "karung", purchaseUnitConversion: 25, stock: 0, minStock: 5 },
            { id: 6, name: "Minyak Goreng", category: "Pokok", unit: "liter", purchaseUnit: "jerigen", purchaseUnitConversion: 5, stock: 0, minStock: 1 },
            { id: 7, name: "Kecap Manis", category: "Bumbu", unit: "ml", purchaseUnit: "botol", purchaseUnitConversion: 600, stock: 0, minStock: 300 },
            { id: 8, name: "Garam", category: "Bumbu", unit: "gram", purchaseUnit: "bks", purchaseUnitConversion: 250, stock: 0, minStock: 250 },
            { id: 9, name: "Telur Ayam", category: "Daging", unit: "butir", purchaseUnit: "kg", purchaseUnitConversion: 16, stock: 0, minStock: 10 },
            { id: 10, name: "Teh Celup", category: "Minuman", unit: "pcs", purchaseUnit: "box", purchaseUnitConversion: 25, stock: 0, minStock: 25 },
            { id: 11, name: "Gula Pasir", category: "Pokok", unit: "kg", purchaseUnit: "kg", purchaseUnitConversion: 1, stock: 0, minStock: 1 },
            { id: 13, name: "Saus Sambal", category: "Gudang", unit: "ml", purchaseUnit: "botol", purchaseUnitConversion: 600, stock: 0, minStock: 600 },
            { id: 14, name: "Gas LPG 12kg", category: "Operasional", unit: "tabung", purchaseUnit: "tabung", purchaseUnitConversion: 1, stock: 0, minStock: 1 },
        ],
        initialRecipes: {
            "Nasi Goreng Spesial": { unit: "porsi", ingredients: [ { itemId: 5, qty: 0.15 }, { itemId: 9, qty: 1 }, { itemId: 1, qty: 0.02 }, { itemId: 2, qty: 0.01 }, { itemId: 7, qty: 15 }, { itemId: 8, qty: 2 }, { itemId: 6, qty: 0.02 } ] },
            "Ayam Bakar Madu": { unit: "porsi", ingredients: [ { itemId: 4, qty: 0.25 }, { itemId: 7, qty: 20 }, { itemId: 2, qty: 0.015}, { itemId: 11, qty: 0.01} ] },
            "Es Teh Manis": { unit: "gelas", ingredients: [ { itemId: 10, qty: 1 }, { itemId: 11, qty: 0.02 } ] }
        },
        initialGudangItemIds: [13, 14]
    },
    
    db: {
        get: (key) => JSON.parse(localStorage.getItem(key)) || null,
        set: (key, value) => localStorage.setItem(key, JSON.stringify(value))
    },

    init() {
        const initialDataMap = {
            masterItems: this.data.initialMasterItems.map((item, index) => ({...item, sortOrder: index})),
            recipes: this.data.initialRecipes,
            gudangItemIds: this.data.initialGudangItemIds,
            menuKeluarActive: Object.keys(this.data.initialRecipes),
            shoppingLists: [],
            stockTransactions: []
        };
        
        Object.keys(initialDataMap).forEach(key => {
            if (this.db.get(key) === null) {
                this.db.set(key, initialDataMap[key]);
            }
        });
        
        document.getElementById('main-content').addEventListener('click', this.handle.click.bind(this));
        
        this.utils.updateTime();
        setInterval(this.utils.updateTime, 1000);
        this.render.page('page-dashboard');
    },

    showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const page = document.getElementById(pageId);
        if (page) {
            page.classList.add('active');
            window.scrollTo(0, 0);
        }
    },
    
    render: {
        page(pageId, data = null) {
            const targetPage = document.getElementById(pageId);
            if (!targetPage) return;
            
            targetPage.innerHTML = '';

            const renderMap = {
                'page-dashboard': this.dashboardPage,
                'page-input-belanja': this.shoppingListForm,
                'page-input-belanja-datang': this.stockInForm,
                'page-input-menu-keluar': (page) => this.stockOutPage(page, 'menu'),
                'page-ambil-gudang': (page) => this.stockOutPage(page, 'gudang'),
                'page-manager-area': this.managerArea,
                'page-riwayat-stok': this.transactionHistoryPage,
            };

            if (renderMap[pageId]) {
                renderMap[pageId].call(this, targetPage, data);
            }
            App.showPage(pageId);
        },
        
        dashboardPage(targetPage) {
            targetPage.innerHTML = `
                <div id="dashboard-alerts"></div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div><strong>Peringatan:</strong> Aplikasi ini menyimpan data di browser Anda. Gunakan fitur Export Data secara berkala.</div>
                </div>
                <div class="dashboard-grid">
                    <a href="#" class="dashboard-card" data-page="page-input-belanja-datang"><i class="fas fa-truck-loading"></i><h3>Input Belanja Datang</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-input-menu-keluar"><i class="fas fa-utensils"></i><h3>Input Menu Keluar</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-ambil-gudang"><i class="fas fa-warehouse"></i><h3>Ambil dari Gudang</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-input-belanja"><i class="fas fa-shopping-cart"></i><h3>Input List Belanja</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-riwayat-stok"><i class="fas fa-history"></i><h3>Riwayat Stok</h3></a>
                    <a href="#" class="dashboard-card" data-page="page-manager-area"><i class="fas fa-user-tie"></i><h3>Manager Area</h3></a>
                </div>
                <div class="time-display"><i class="far fa-clock"></i> <span id="current-time"></span></div>`;
            App.utils.updateTime();
            this.lowStockAlerts();
        },
        
        lowStockAlerts() {
            const container = document.getElementById('dashboard-alerts');
            if (!container) return;
            const masterItems = App.db.get('masterItems');
            const lowStockItems = masterItems.filter(item => (item.stock || 0) < (item.minStock || 0));
            if (lowStockItems.length > 0) {
                const itemsList = lowStockItems.map(item => `<li><strong>${item.name}</strong> (Sisa: ${item.stock} ${item.unit}, Min: ${item.minStock} ${item.unit})</li>`).join('');
                container.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i><div><strong>Peringatan Stok Rendah:</strong><ul style="margin-left: 20px; margin-top: 5px;">${itemsList}</ul></div></div>`;
            } else {
                container.innerHTML = '';
            }
        },
        
        shoppingListForm(targetPage) { /* Omitted for brevity, no changes */ },

        stockInForm(targetPage) { /* Omitted for brevity, no changes */ },

        stockInDetail(targetPage, listDate) { /* Omitted for brevity, no changes */ },

        stockOutPage(targetPage, type) { /* Omitted for brevity, no changes */ },

        managerArea(targetPage) {
            targetPage.innerHTML = `
                <div class="card">
                    <div class="card-header"><div class="card-title"><i class="fas fa-user-tie"></i><span>Manager Area</span></div><button class="btn btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div>
                    <div class="category-group">
                        <h3 class="category-title"><i class="fas fa-save"></i> Cadangkan & Pulihkan Data</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" data-action="export-data"><i class="fas fa-download"></i> Export Data</button>
                            <button class="btn btn-warning" data-action="import-data"><i class="fas fa-upload"></i> Import Data</button>
                            <input type="file" id="import-file-input" accept=".json" style="display: none;">
                        </div>
                    </div>
                    <div class="category-group"><h3 class="category-title"><i class="fas fa-sliders-h"></i> Atur Tampilan Menu & Gudang</h3><div id="display-config-container"></div></div>
                    <div class="category-group">
                        <h3 class="category-title">
                            <span><i class="fas fa-book"></i> Manajemen Resep</span>
                            <button class="btn btn-sm btn-success" data-action="add-recipe"><i class="fas fa-plus"></i> Tambah Resep</button>
                        </h3>
                        <div id="recipe-list-container"></div>
                    </div>
                    <div class="category-group" id="db-editor">
                        <h3 class="category-title">
                            <span><i class="fas fa-database"></i> Editor Database Barang</span>
                            <button class="btn btn-sm btn-primary" data-action="save-item-order"><i class="fas fa-save"></i> Simpan Urutan</button>
                        </h3>
                        <div id="add-item-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                            <input type="hidden" id="edit-item-id">
                            <input class="form-control" type="text" id="item-name" placeholder="Nama Barang">
                            <input class="form-control" type="text" id="item-category" placeholder="Kategori" list="category-suggestions"><datalist id="category-suggestions"></datalist>
                            <input class="form-control" type="text" id="item-unit" placeholder="Satuan Stok">
                            <input class="form-control" type="text" id="item-purchase-unit" placeholder="Satuan Beli">
                            <input class="form-control" type="number" id="item-conversion" placeholder="Konversi" min="0">
                            <input class="form-control" type="number" id="item-min-stock" placeholder="Stok Minimum" min="0">
                            <div id="form-buttons" style="display:flex; gap: 10px; grid-column: 1 / -1;"><button class="btn btn-primary" data-action="save-item" id="save-item-btn" style="flex-grow: 1;"><i class="fas fa-save"></i> Simpan Barang</button><button class="btn btn-secondary" data-action="cancel-edit" id="cancel-edit-btn" style="display: none;"><i class="fas fa-times"></i> Batal</button></div>
                        </div>
                        <div class="table-container"><table class="table" id="db-editor-table"><thead><tr><th style="width: 50px;">Urutan</th><th>Nama</th><th>Kategori</th><th>Stok</th><th>Stok Min</th><th style="width: 150px;">Aksi</th></tr></thead><tbody id="db-editor-tbody"></tbody></table></div>
                    </div>
                </div>`;
            this.managerSubRenders();
        },
        
        managerSubRenders() {
            // Render DB Editor Table
            const masterItems = App.db.get('masterItems').sort((a, b) => a.sortOrder - b.sortOrder);
            const tbody = document.getElementById('db-editor-tbody');
            tbody.innerHTML = masterItems.map(item => `
                <tr class="editable-item-row" draggable="true" data-id="${item.id}">
                    <td class="drag-handle" style="text-align:center; vertical-align:middle; cursor:grab;"><i class="fas fa-grip-vertical"></i></td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${(item.stock || 0).toFixed(2)} ${item.unit}</td>
                    <td>${item.minStock || 0} ${item.unit}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" data-action="edit-item" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn btn-sm btn-danger" data-action="delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
            App.utils.addDragDropHandlers(tbody);
            this.populateCategoryDatalist();

            // Render Recipe List
            const recipes = App.db.get('recipes');
            const recipeContainer = document.getElementById('recipe-list-container');
            let recipeHTML = Object.keys(recipes).sort().map(name => `
                <div class="item-row">
                    <span class="item-label">${name}</span>
                    <span class="item-unit">${recipes[name].unit}</span>
                    <div>
                        <button class="btn btn-sm btn-warning" data-action="edit-recipe" data-name="${name}"><i class="fas fa-pencil-alt"></i> Edit</button>
                        <button class="btn btn-sm btn-danger" data-action="delete-recipe" data-name="${name}"><i class="fas fa-trash"></i> Hapus</button>
                    </div>
                </div>`).join('');
            recipeContainer.innerHTML = recipeHTML || '<div class="alert alert-info" style="margin:0;">Belum ada resep.</div>';

            // Render Display Config
            this.displayConfigEditor(document.getElementById('display-config-container'));
        },
        
        recipeEditor(targetPage, recipeName = null) {
            const isEditing = recipeName !== null;
            const recipes = App.db.get('recipes');
            const recipe = isEditing ? recipes[recipeName] : { unit: '', ingredients: [] };
            const masterItems = App.db.get('masterItems').sort((a, b) => a.name.localeCompare(b.name));

            const itemOptions = masterItems.map(item => `<option value="${item.id}">${item.name} (${item.unit})</option>`).join('');

            let ingredientsHTML = recipe.ingredients.map(ing => {
                const item = masterItems.find(mi => mi.id === ing.itemId);
                return `
                <div class="item-row ingredient-item" data-item-id="${ing.itemId}">
                    <span class="item-label">${item ? item.name : 'Barang tidak ditemukan'}</span>
                    <input type="number" class="form-control" value="${ing.qty}" step="any" min="0">
                    <div>
                        <span class="item-unit">${item ? item.unit : ''}</span>
                        <button class="btn btn-sm btn-danger" data-action="remove-ingredient"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');

            targetPage.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-edit"></i> ${isEditing ? 'Edit Resep' : 'Tambah Resep Baru'}</h2>
                        <button class="btn btn-secondary" data-page="page-manager-area"><i class="fas fa-times"></i> Batal</button>
                    </div>
                    <div class="form-group">
                        <label for="recipe-name" class="form-label">Nama Menu / Resep</label>
                        <input type="text" id="recipe-name" class="form-control" value="${isEditing ? recipeName : ''}" ${isEditing ? 'disabled' : ''}>
                    </div>
                    <div class="form-group">
                        <label for="recipe-unit" class="form-label">Satuan Hasil (Contoh: porsi, gelas)</label>
                        <input type="text" id="recipe-unit" class="form-control" value="${recipe.unit}">
                    </div>
                    <div class="category-group">
                        <h3 class="category-title">Bahan-Bahan</h3>
                        <div id="ingredients-list">${ingredientsHTML}</div>
                        <div style="margin-top: 1rem; padding: 1rem; border: 1px dashed var(--border-color); border-radius: var(--border-radius); display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: center;">
                            <select id="new-ingredient-item" class="form-control">${itemOptions}</select>
                            <input type="number" id="new-ingredient-qty" class="form-control" placeholder="Jumlah" step="any" min="0">
                            <button class="btn btn-primary" data-action="add-ingredient"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <button class="btn btn-success" style="width: 100%;" data-action="save-recipe" data-original-name="${isEditing ? recipeName : ''}"><i class="fas fa-save"></i> Simpan Resep</button>
                </div>`;
        },

        displayConfigEditor(targetContainer) { /* Omitted for brevity, no changes */ },
        
        transactionHistoryPage(targetPage) { /* Omitted for brevity, no changes */ },

        populateCategoryDatalist() { /* Omitted for brevity, no changes */ }
    },
    
    actions: {
        saveShoppingList() { /* Omitted for brevity, no changes */ },
        
        processStockIn(listDate) { /* Omitted for brevity, no changes */ },
        
        cancelShoppingList(date) { /* Omitted for brevity, no changes */ },

        processStockOut(type) { /* Omitted for brevity, no changes */ },

        saveItem() { /* Omitted for brevity, no changes */ },

        editItem(id) { /* Omitted for brevity, no changes */ },

        cancelEdit() { /* Omitted for brevity, no changes */ },
        
        deleteItem(id) { /* Omitted for brevity, no changes */ },
        
        saveItemOrder() { /* Omitted for brevity, no changes */ },

        saveDisplayConfig() { /* Omitted for brevity, no changes */ },
        
        addIngredient() {
            const list = document.getElementById('ingredients-list');
            const itemId = document.getElementById('new-ingredient-item').value;
            const qty = parseFloat(document.getElementById('new-ingredient-qty').value);
            
            if (!itemId || !(qty > 0)) {
                return App.utils.showToast('Pilih barang dan isi jumlahnya.', 'error');
            }
            if (list.querySelector(`[data-item-id="${itemId}"]`)) {
                return App.utils.showToast('Barang ini sudah ada di dalam resep.', 'warning');
            }
            
            const masterItems = App.db.get('masterItems');
            const item = masterItems.find(mi => mi.id == itemId);

            const newIngredientHTML = `
                <div class="item-row ingredient-item" data-item-id="${item.id}">
                    <span class="item-label">${item.name}</span>
                    <input type="number" class="form-control" value="${qty}" step="any" min="0">
                    <div>
                        <span class="item-unit">${item.unit}</span>
                        <button class="btn btn-sm btn-danger" data-action="remove-ingredient"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            list.insertAdjacentHTML('beforeend', newIngredientHTML);
            document.getElementById('new-ingredient-qty').value = '';
        },
        
        removeIngredient(button) {
            button.closest('.ingredient-item').remove();
        },
        
        saveRecipe(button) {
            const originalName = button.dataset.originalName;
            const isEditing = originalName !== '';

            const newName = document.getElementById('recipe-name').value.trim();
            const newUnit = document.getElementById('recipe-unit').value.trim();

            if (!newName || !newUnit) {
                return App.utils.showToast('Nama menu dan satuan harus diisi.', 'error');
            }

            const ingredients = [];
            document.querySelectorAll('.ingredient-item').forEach(el => {
                const itemId = parseInt(el.dataset.itemId);
                const qty = parseFloat(el.querySelector('input').value);
                if (itemId && qty > 0) {
                    ingredients.push({ itemId, qty });
                }
            });

            if (ingredients.length === 0) {
                return App.utils.showToast('Resep harus memiliki minimal 1 bahan.', 'error');
            }

            let recipes = App.db.get('recipes');
            if (!isEditing && recipes[newName]) {
                return App.utils.showToast('Nama menu sudah ada, gunakan nama lain.', 'error');
            }

            if (isEditing && newName !== originalName) {
                delete recipes[originalName];
            }
            
            recipes[newName] = { unit: newUnit, ingredients: ingredients };
            
            App.db.set('recipes', recipes);

            // Update menu aktif jika resep baru ditambahkan
            if (!isEditing) {
                let menuKeluarActive = App.db.get('menuKeluarActive');
                if (!menuKeluarActive.includes(newName)) {
                    menuKeluarActive.push(newName);
                    App.db.set('menuKeluarActive', menuKeluarActive);
                }
            }

            App.utils.showToast(`Resep "${newName}" berhasil disimpan.`, 'success');
            App.render.page('page-manager-area');
        },

        deleteRecipe(name) {
            if (!confirm(`Apakah Anda yakin ingin menghapus resep "${name}"? Ini tidak bisa dibatalkan.`)) return;

            let recipes = App.db.get('recipes');
            delete recipes[name];
            App.db.set('recipes', recipes);

            let menuKeluarActive = App.db.get('menuKeluarActive');
            const index = menuKeluarActive.indexOf(name);
            if (index > -1) {
                menuKeluarActive.splice(index, 1);
                App.db.set('menuKeluarActive', menuKeluarActive);
            }
            
            App.utils.showToast('Resep berhasil dihapus.', 'success');
            App.render.managerSubRenders();
        },

        exportData() { /* Omitted, same as before */ },
        importData() { /* Omitted, same as before */ }
    },
    
    handle: {
        click(event) {
            const target = event.target.closest('[data-action], [data-page]');
            if (!target) return;
            event.preventDefault();
            const { page, action, date, id, name, type, message, originalName } = target.dataset;

            if (page) App.render.page(page);
            else if (action) {
                const actionMap = {
                    'save-shopping-list': () => App.actions.saveShoppingList(),
                    'select-pending-list': () => App.render.stockInDetail(document.getElementById('page-input-belanja-datang'), date),
                    'process-stock-in': () => App.actions.processStockIn(date),
                    'cancel-shopping-list': () => App.actions.cancelShoppingList(date),
                    'process-stock-out': () => App.actions.processStockOut(type),
                    'save-item': () => App.actions.saveItem(),
                    'edit-item': () => App.actions.editItem(id),
                    'cancel-edit': () => App.actions.cancelEdit(),
                    'delete-item': () => App.actions.deleteItem(id),
                    'save-item-order': () => App.actions.saveItemOrder(),
                    'add-recipe': () => App.render.recipeEditor(document.getElementById('page-manager-area')),
                    'edit-recipe': () => App.render.recipeEditor(document.getElementById('page-manager-area'), name),
                    'delete-recipe': () => App.actions.deleteRecipe(name),
                    'save-recipe': () => App.actions.saveRecipe(target),
                    'add-ingredient': () => App.actions.addIngredient(),
                    'remove-ingredient': () => App.actions.removeIngredient(target),
                    'save-display-config': () => App.actions.saveDisplayConfig(),
                    'export-data': () => App.actions.exportData(),
                    'import-data': () => App.actions.importData(),
                    'show-alert': () => App.utils.showToast(message, 'info'),
                };
                if(actionMap[action]) actionMap[action]();
            }
        }
    },

    utils: { /* Omitted for brevity, no changes */ }
};

document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
