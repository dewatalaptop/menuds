<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolan Sawah ORC - V8.0 Stable</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        /* [DIUBAH] Skema Warna Baru */
        :root {
            --primary-color: #2a9d8f;      /* Teal Utama */
            --primary-light: #3bc3b3;      /* Teal Lebih Terang (Penyesuaian) */
            --primary-dark: #264653;       /* Biru Tua Gelap */
            --secondary-color: #e9c46a;    /* Kuning Pasir */
            --accent-color: #f4a261;       /* Oranye */
            --danger-color: #e76f51;       /* Oranye Kemerahan */
            --success-color: #28a745;      /* Hijau Sukses */
            --info-color: #3182ce;         /* Biru Info */
            --white-color: #ffffff;
            --text-color: #343a40;         /* Abu-abu Gelap untuk Teks */
            --text-light: #6c757d;         /* Abu-abu Lebih Terang */
            --border-color: #dee2e6;
            --page-bg: #f8f9fa;            /* Latar belakang halaman/kartu */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 0.5rem;
            --transition: all 0.2s ease-in-out;
            --sidebar-width: 240px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* [DIUBAH] Body dengan Background Image dan Overlay */
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f5f5f5; 
            color: var(--text-color); 
            line-height: 1.6;
            background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.92); z-index: -1;
        }
        
        /* [BARU] Header Utama */
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: white; padding: 25px 20px; text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative; overflow: hidden;
            transition: margin-left 0.3s ease-in-out;
        }
        header::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }
        header h1 {
            font-size: 2.2rem; margin-bottom: 5px; font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
            display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        header small {
            display: block; font-size: 0.8rem; margin-top: 5px;
            color: rgba(255, 255, 255, 0.8); font-weight: 300;
        }
        
        #sidebar { width: var(--sidebar-width); background-color: var(--white-color); border-right: 1px solid var(--border-color); height: 100vh; position: fixed; top: 0; left: 0; z-index: 1000; display: flex; flex-direction: column; transition: transform 0.3s ease-in-out; box-shadow: var(--shadow-md); }
        .sidebar-header { padding: 1.25rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .sidebar-header .app-title { font-size: 1.5rem; color: var(--primary-dark); font-weight: 600; margin: 0; }
        .sidebar-menu { flex-grow: 1; list-style: none; padding: 1rem 0; }
        .sidebar-menu a { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1.5rem; color: var(--text-light); text-decoration: none; font-weight: 500; border-left: 3px solid transparent; transition: var(--transition); }
        .sidebar-menu a:hover { background-color: var(--page-bg); color: var(--primary-dark); }
        .sidebar-menu a.active { background-color: var(--page-bg); color: var(--primary-color); border-left-color: var(--primary-color); font-weight: 600; }
        .sidebar-menu a i { width: 20px; text-align: center; font-size: 1.1rem; }
        .sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); }
        
        #main-wrapper { padding-left: var(--sidebar-width); transition: margin-left 0.3s ease-in-out; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        
        /* Sub-header untuk judul halaman dinamis */
        .app-header {
            background-color: var(--white-color); padding: 1rem 1.5rem; border-radius: var(--border-radius);
            box-shadow: var(--shadow-md); margin-bottom: 1.5rem; display: flex;
            justify-content: space-between; align-items: center; border: 1px solid var(--border-color);
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .app-header h2 { font-weight: 600; font-size: 1.5rem; color: var(--primary-dark); margin: 0; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #header-alerts { position: relative; cursor: pointer; }
        #header-alerts .alert-icon { font-size: 1.5rem; color: var(--primary-dark); transition: transform 0.2s; }
        #header-alerts:hover .alert-icon { transform: scale(1.1); }
        #header-alerts .alert-badge { position: absolute; top: -5px; right: -10px; background-color: var(--danger-color); color: var(--white-color); border-radius: 50%; width: 22px; height: 22px; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: 600; border: 2px solid var(--white-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 111, 81, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 111, 81, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 111, 81, 0); } }
        
        @media (max-width: 768px) { #sidebar { transform: translateX(calc(-1 * var(--sidebar-width))); } #sidebar.open { transform: translateX(0); } #main-wrapper { padding-left: 0; } .mobile-menu-toggle { display: block !important; z-index: 1001; } .page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none;} #sidebar.open ~ #app-container .page-overlay { display: block; } }
        @media (max-width: 480px) { .container { padding: 1rem; } .card { padding: 1rem; } .app-header h2 { font-size: 1.2rem; } header h1 {font-size: 1.8rem;} }
        
        .card { background: var(--white-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); display: flex; align-items: center; gap: 0.5rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: var(--border-radius); font-weight: 500; cursor: pointer; transition: var(--transition); border: none; font-size: 0.9rem; }
        .btn:disabled { background-color: var(--text-light); cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: var(--primary-color); color: #fff; } .btn-primary:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); } .btn-secondary:hover:not(:disabled) { background-color: #dcb14a; }
        .btn-danger { background-color: var(--danger-color); color: #fff; } .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8rem; }
        .form-group { position: relative; margin-bottom: 1rem; }
        .form-label { display: block; font-weight: 500; font-size: 0.85rem; margin-bottom: 0.3rem; color: var(--text-color); }
        .form-control { width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9rem; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1100; display: flex; flex-direction: column; gap: 0.75rem; max-width: 350px; }
        .toast { background-color: var(--text-color); color: var(--white-color); padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); opacity: 0; transform: translateX(100%); transition: opacity 0.3s, transform 0.3s; display: flex; align-items: center; gap: 1rem; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--danger-color); } .toast.info { background-color: var(--info-color); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.25rem; }
        .dashboard-card { background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: var(--transition); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; text-decoration: none; color: inherit; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-color); }
        .dashboard-card i { font-size: 2.25rem; color: var(--primary-color); }
        .dashboard-card h3 { font-size: 1rem; font-weight: 500; color: var(--text-color); }
        .page { animation: fadeIn 0.3s ease; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(45, 55, 72, 0.6); backdrop-filter: blur(2px); z-index: 1040; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.2s ease; visibility: hidden; }
        .modal-backdrop.show { opacity: 1; visibility: visible; }
        .modal-content { background: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.2s ease; }
        .modal-backdrop.show .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        #login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #login-card { width: 100%; max-width: 400px; text-align: center; border-top: 5px solid var(--primary-color); }
        #login-error { color: var(--danger-color); margin-top: 1rem; display: none; font-size: 0.9rem; }
        #app-root { display: none; }
        .item-row { display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center; padding: 0.75rem; border-radius: var(--border-radius); } .item-row:nth-child(odd) { background-color: var(--page-bg); }
        .item-list { display: grid; gap: 0.75rem; }
        .item-label { font-weight: 500; } .stock-hint { color: var(--text-light); font-size: 0.85rem; }
        .table { width: 100%; border-collapse: collapse; } .table th, .table td { padding: 0.875rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); } .table th { background-color: var(--page-bg); font-weight: 600; }
        .drag-handle { cursor: grab; } .dragging { opacity: 0.5; }
        .empty-state { text-align: center; padding: 2rem; color: var(--text-light); border: 2px dashed var(--border-color); border-radius: var(--border-radius); }
        .global-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--page-bg); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: var(--primary-color); transition: opacity 0.3s ease; }
    </style>
</head>
<body>
    <div class="global-loader" id="global-loader"><i class="fas fa-spinner fa-spin"></i></div>

    <div id="login-page">
        <div class="card" id="login-card">
            <h1 style="justify-content: center; color: var(--primary-dark); margin-bottom: 2rem; display:flex; align-items:center; gap: 0.75rem;"><i class="fas fa-utensils"></i> RestoApp</h1>
            <form id="login-form">
                <div class="form-group" style="text-align: left;"><label for="email" class="form-label">Email</label><input type="email" id="email" class="form-control" required></div>
                <div class="form-group" style="text-align: left;"><label for="password" class="form-label">Password</label><input type="password" id="password" class="form-control" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Login</button>
            </form>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="app-container">
        <nav id="sidebar">
            <div class="sidebar-header"><h1 class="app-title"><i class="fas fa-utensils"></i> RestoApp</h1></div>
            <ul class="sidebar-menu" id="sidebar-menu-container"></ul>
            <div class="sidebar-footer">
                <div id="user-email-display" style="font-weight: 500; word-break: break-all;"></div>
                <button class="btn btn-sm btn-danger" data-action="logout" style="width: 100%; margin-top: 0.75rem;"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </nav>

        <div id="main-wrapper">
            <header>
                <h1><i class="fas fa-chart-line"></i> Dolan Sawah ORC</h1>
                <small>Operasional Report and Control</small>
            </header>
            
            <div class="page-overlay" data-action="toggle-sidebar"></div>
            <div id="modal-container"></div>
            <div class="container">
                <div class="app-header">
                    <div class="header-left">
                        <button class="mobile-menu-toggle btn btn-primary" data-action="toggle-sidebar" style="display: none;"><i class="fas fa-bars"></i></button>
                        <h2 id="page-title">Dashboard</h2>
                    </div>
                    <div class="header-actions">
                        <div id="header-alerts"></div>
                    </div>
                </div>
                <main id="main-content"></main>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>
    <input type="file" id="import-file-input" accept=".json" style="display:none;">
    <input type="file" id="sales-report-input" accept=".csv" style="display:none;">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
// [DIKEMBALIKAN] Menggunakan logika JavaScript dari kode lama yang stabil.
const firebaseConfig = {
    apiKey: "AIzaSyBqpro-gmPkgE8cZVZ5LG0mjoyl5GUYVl8",
    authDomain: "restoapp-v6.firebaseapp.com",
    projectId: "restoapp-v6",
    storageBucket: "restoapp-v6.appspot.com",
    messagingSenderId: "163876863347",
    appId: "1:163876863347:web:2e5181c0bdae91e3809906"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const firestore = firebase.firestore();

window.RestoApp = {
    AppState: { currentUser: null, masterItems: [], recipes: {}, shoppingLists: [], stockTransactions: [], gudangItemIds: [], menuKeluarActive: [], salesReports: [], isDataLoaded: false, unsubscribe: null, reportPeriod: '24h' },

    Utils: {
        formatCurrency: (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value || 0),
        calculateAvailablePortions(menuName) {
            const { recipes, masterItems } = RestoApp.AppState; if(!recipes || !masterItems) return 0;
            const recipe = recipes[menuName]; if (!recipe || !recipe.ingredients) return 0; let minPortions = Infinity;
            recipe.ingredients.forEach(ing => {
                const item = masterItems.find(mi => mi.id === ing.itemId);
                if (item && ing.qty > 0) minPortions = Math.min(minPortions, Math.floor((item.stock || 0) / ing.qty));
                else if (ing.qty > 0) minPortions = 0;
            });
            return minPortions === Infinity ? 0 : minPortions;
        },
        // [DIUBAH] Fungsi laporan diperbarui untuk menyertakan data Stok Opname
        generateConsolidatedReport(period = '24h') {
            const now = new Date();
            let startDate;

            if (period === 'today') {
                startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
            } else if (period === 'yesterday') {
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 1);
                startDate.setHours(0, 0, 0, 0);
                now.setDate(now.getDate() - 1);
                now.setHours(23, 59, 59, 999);
            } else { // 24h
                startDate = new Date(now.getTime() - (24 * 60 * 60 * 1000));
            }
            
            const { salesReports, stockTransactions, masterItems, recipes } = RestoApp.AppState;
            const consolidated = {};

            // Inisialisasi item menu dari resep
            Object.keys(recipes).forEach(name => {
                if (!consolidated[name]) consolidated[name] = { pos: 0, manual: 0, waste: 0, opname: 0 };
            });
            
            const addToConsolidated = (name, type, qty) => {
                if (!consolidated[name]) consolidated[name] = { pos: 0, manual: 0, waste: 0, opname: 0 };
                consolidated[name][type] += qty;
            };

            (salesReports || []).filter(r => new Date(r.date) >= startDate && new Date(r.date) <= now).forEach(report => {
                Object.entries(report.items).forEach(([itemName, qty]) => addToConsolidated(itemName, 'pos', qty));
            });
            (stockTransactions || []).filter(t => new Date(t.date) >= startDate && new Date(t.date) <= now).forEach(t => {
                if (t.type === 'Produksi Menu' && t.details) addToConsolidated(t.details, 'manual', t.change);
                else if (t.type === 'Waste' && t.details) addToConsolidated(t.details, 'waste', t.change);
                else if (t.type === 'Stok Opname') {
                    const item = masterItems.find(mi => mi.id === t.itemId);
                    if (item) {
                         // Cari resep mana yang menggunakan item ini dan distribusikan nilai opname
                        Object.keys(recipes).forEach(recipeName => {
                            if (recipes[recipeName].ingredients.some(ing => ing.itemId === item.id)) {
                                // Ini adalah simplifikasi; untuk akurasi penuh memerlukan logika distribusi yang kompleks.
                                // Untuk saat ini, kita akan menambahkan penyesuaian opname ke setiap menu yang relevan.
                                // CATATAN: Ini akan menampilkan nilai opname penuh di setiap menu yang terpengaruh.
                                addToConsolidated(recipeName, 'opname', t.change);
                            }
                        });
                    }
                }
            });

            const reportData = Object.entries(consolidated).map(([name, data]) => {
                const totalShouldBe = data.pos + data.waste;
                const discrepancy = (data.manual + data.opname) - totalShouldBe; // Rumus selisih diperbarui
                return { name, ...data, totalShouldBe, discrepancy };
            }).filter(item => item.pos > 0 || item.manual > 0 || item.waste > 0 || item.opname !== 0)
              .sort((a, b) => a.name.localeCompare(b.name));

            return { reportData, reportDate: new Date() };
        },
        addDragDropHandlers(container) {
            container.addEventListener('dragstart', e => e.target.classList.add('dragging'));
            container.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            container.addEventListener('dragover', e => {
                e.preventDefault(); const afterElement = this.getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable) { if (afterElement == null) container.appendChild(draggable); else container.insertBefore(draggable, afterElement); }
            });
        },
        getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
            return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element;
        },
        async handleAsyncButton(button, asyncFunction) {
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            try {
                await asyncFunction();
            } catch (error) {
                console.error("Async operation failed:", error);
                RestoApp.UI.showToast(`Operasi gagal: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        },
        parseCsv(csvText) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                if (inQuotes) {
                    if (char === '"') {
                        if (i + 1 < csvText.length && csvText[i + 1] === '"') {
                            currentField += '"'; i++;
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        currentField += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentRow.push(currentField);
                        currentField = '';
                    } else if (char === '\n' || char === '\r') {
                        if (i > 0 && csvText[i-1] !== '\n' && csvText[i-1] !== '\r') {
                             currentRow.push(currentField);
                             rows.push(currentRow);
                             currentRow = [];
                             currentField = '';
                        }
                    } else {
                        currentField += char;
                    }
                }
            }
            if(currentField) currentRow.push(currentField);
            if(currentRow.length > 0) rows.push(currentRow);
            return rows;
        }
    },

    API: {
        listenToData() {
            const AppState = RestoApp.AppState; if (AppState.unsubscribe) AppState.unsubscribe(); if (!AppState.currentUser) return;
            const docRef = firestore.collection('restaurants').doc(AppState.currentUser.uid);
            AppState.unsubscribe = docRef.onSnapshot(doc => {
                const wasDataLoaded = AppState.isDataLoaded;
                if (doc.exists) {
                    const data = doc.data(); 
                    Object.keys(AppState).forEach(key => { if(data[key] !== undefined && key !== 'reportPeriod') AppState[key] = data[key]; });
                } else {
                    this.initializeDefaultData();
                }
                AppState.isDataLoaded = true;
                
                if (!wasDataLoaded) { 
                    const loader = document.getElementById('global-loader');
                    loader.style.opacity = '0';
                    loader.addEventListener('transitionend', () => loader.style.display = 'none');
                    RestoApp.UI.renderPage(location.hash.substring(1) || 'page-dashboard');
                } else {
                    const currentPage = location.hash.substring(1) || 'page-dashboard';
                    RestoApp.UI.renderPage(currentPage, null, true);
                }
                RestoApp.UI.lowStockAlerts();
            }, error => {
                console.error("Firebase listen error:", error);
                RestoApp.UI.showToast("Gagal sinkronisasi data real-time.", "error");
            });
        },
        async set(data) { if (!RestoApp.AppState.currentUser) return; await firestore.collection('restaurants').doc(RestoApp.AppState.currentUser.uid).set(data, { merge: true }); },
        async setKey(key, value) { if (!RestoApp.AppState.currentUser) return; await firestore.collection('restaurants').doc(RestoApp.AppState.currentUser.uid).set({ [key]: value }, { merge: true }); },
        async initializeDefaultData() {
            const initialData = { masterItems: [], recipes: {}, gudangItemIds: [], menuKeluarActive: [], shoppingLists: [], stockTransactions: [], salesReports: [] };
            await this.set(initialData); RestoApp.UI.showToast("Selamat datang! Data awal telah disiapkan.", "success");
            Object.assign(RestoApp.AppState, initialData);
        }
    },

    Auth: {
        listen() {
            auth.onAuthStateChanged(user => {
                const loginPage = document.getElementById('login-page'); const appContainer = document.getElementById('app-container');
                const loader = document.getElementById('global-loader');
                if (user) {
                    RestoApp.AppState.currentUser = user; 
                    loginPage.style.display = 'none'; appContainer.style.display = 'block';
                    RestoApp.App.initOnLogin();
                } else {
                    RestoApp.AppState.currentUser = null; 
                    loginPage.style.display = 'flex'; appContainer.style.display = 'none';
                    loader.style.display = 'none';
                    if (RestoApp.AppState.unsubscribe) { RestoApp.AppState.unsubscribe(); RestoApp.AppState.unsubscribe = null; }
                    RestoApp.AppState.isDataLoaded = false;
                }
            });
        },
        async login(email, password) { await auth.signInWithEmailAndPassword(email, password); },
        async logout() { await auth.signOut(); }
    },
    
    UI: {
        menuConfig: [
            { id: 'page-dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
            { id: 'page-input-penjualan', icon: 'fa-file-invoice-dollar', text: 'Input Penjualan' },
            { id: 'page-input-belanja', icon: 'fa-shopping-cart', text: 'Buat List Belanja' },
            { id: 'page-input-waste', icon: 'fa-trash-alt', text: 'Input Waste' },
            { id: 'page-laporan-analisa', icon: 'fa-chart-pie', text: 'Laporan Analisa' },
            { id: 'page-riwayat-stok', icon: 'fa-history', text: 'Riwayat Stok' },
            { id: 'page-manager-area', icon: 'fa-user-tie', text: 'Manager Area' },
        ],
        renderPage(pageId, data = null, isUpdate = false) {
            if (!RestoApp.AppState.isDataLoaded && pageId !== 'login-page') return;
            const pageConfig = this.menuConfig.find(p => p.id === pageId) || {id: pageId, text: pageId.replace('page-','').replace(/-/g,' ').replace(/\b\w/g, l => l.toUpperCase())};
            
            if (location.hash !== `#${pageId}` && !isUpdate) { location.hash = `#${pageId}`; }

            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.toggle('active', a.dataset.page === pageId));
            const pageContent = this.Pages[pageId] ? this.Pages[pageId](data) : `<div class="card"><p>Halaman tidak ditemukan.</p></div>`;
            document.getElementById('main-content').innerHTML = pageContent;
            document.getElementById('page-title').textContent = pageConfig.text;
            document.title = `${pageConfig.text} - Dolan Sawah ORC`;
            
            if(pageId === 'page-manager-items') RestoApp.Utils.addDragDropHandlers(document.getElementById('db-editor-tbody'));
        },
        renderSidebar() {
            document.getElementById('sidebar-menu-container').innerHTML = this.menuConfig.map(item => `<li><a href="#${item.id}" data-page="${item.id}"><i class="fas ${item.icon}"></i><span>${item.text}</span></a></li>`).join('');
            document.getElementById('user-email-display').textContent = RestoApp.AppState.currentUser.email;
        },
        lowStockAlerts() {
            const container = document.getElementById('header-alerts'); if (!container) return;
            const lowStockItems = RestoApp.AppState.masterItems.filter(item => (item.stock || 0) < (item.minStock || 0));
            container.innerHTML = lowStockItems.length > 0 ? `<div data-action="show-low-stock-modal"><i class="fas fa-bell alert-icon"></i><span class="alert-badge">${lowStockItems.length}</span></div>` : '';
        },
        showLowStockModal() {
            const lowStockItems = RestoApp.AppState.masterItems.filter(item => (item.stock || 0) < (item.minStock || 0)); if (lowStockItems.length === 0) return;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `<div class="modal-backdrop show" data-action="close-modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Peringatan Stok Rendah</h3><button class="modal-close-btn" data-action="close-modal" aria-label="Tutup">&times;</button></div><div class="modal-body"><div style="position: relative; height:60vh;"><canvas id="lowStockChart"></canvas></div></div></div></div>`;
            const ctx = document.getElementById('lowStockChart').getContext('2d');
            new Chart(ctx, { type: 'bar', data: { labels: lowStockItems.map(item => `${item.name} (${item.unit})`), datasets: [{ label: 'Stok Saat Ini', data: lowStockItems.map(item => item.stock), backgroundColor: 'rgba(221, 107, 32, 0.7)' }, { label: 'Stok Minimum', data: lowStockItems.map(item => item.minStock), backgroundColor: 'rgba(229, 62, 62, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' } });
        },
        closeModal() { document.getElementById('modal-container').innerHTML = ''; },
        showToast(message, type = 'success') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            toast.className = `toast ${type}`; toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        },
        showSalesConfirmationModal(matchedItems, unmatchedItems, salesData) {
            const matchedHTML = Object.keys(matchedItems).length > 0 ? Object.entries(matchedItems).map(([name, qty]) => `<li>${name}: <strong>${qty} porsi</strong></li>`).join('') : '<li>Tidak ada item yang cocok.</li>';
            const unmatchedHTML = unmatchedItems.length > 0 ? unmatchedItems.map(item => `<li>${item.name} (Qty: ${item.qty})</li>`).join('') : '<li>Semua item berhasil dicocokkan.</li>';

            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `<div class="modal-backdrop show" data-action="close-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-check-double"></i> Konfirmasi Proses Penjualan</h3>
                        <button class="modal-close-btn" data-action="close-modal" aria-label="Tutup">&times;</button>
                    </div>
                    <div class="modal-body" style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><h4><i class="fas fa-check" style="color:var(--success-color)"></i> Item Cocok & Akan Diproses</h4><ul>${matchedHTML}</ul></div>
                        <div><h4><i class="fas fa-times" style="color:var(--danger-color)"></i> Item Tidak Ditemukan di Resep</h4><ul>${unmatchedHTML}</ul></div>
                    </div>
                    <div class="modal-footer" style="margin-top: 1.5rem; display:flex; justify-content:flex-end; gap: 1rem;">
                         <button class="btn btn-secondary" data-action="close-modal">Batal</button>
                         <button class="btn btn-primary" id="confirm-process-sales-btn">Konfirmasi & Potong Stok</button>
                    </div>
                </div>
            </div>`;

            document.getElementById('confirm-process-sales-btn').addEventListener('click', (e) => {
                 RestoApp.Utils.handleAsyncButton(e.target, () => RestoApp.Events.ActionHandlers.executeSalesReport(salesData));
            });
        },
        // [BARU] Fungsi helper untuk mengupdate tampilan selisih di halaman opname secara real-time
        updateOpnameDifference(inputElement) {
            const row = inputElement.closest('tr');
            const systemStock = parseFloat(row.dataset.systemStock);
            const physicalStock = parseFloat(inputElement.value);
            const differenceCell = row.querySelector('.opname-difference');
            
            if (isNaN(physicalStock)) {
                differenceCell.textContent = '-';
                differenceCell.style.color = 'inherit';
                return;
            }

            const difference = physicalStock - systemStock;
            differenceCell.textContent = difference.toFixed(2);
            if (difference < 0) {
                differenceCell.style.color = 'var(--danger-color)';
                differenceCell.style.fontWeight = 'bold';
            } else if (difference > 0) {
                differenceCell.style.color = 'var(--success-color)';
                differenceCell.style.fontWeight = 'bold';
            } else {
                differenceCell.style.color = 'inherit';
                differenceCell.style.fontWeight = 'normal';
            }
        },
        
        Pages: {
            'page-dashboard': () => `<div class="dashboard-grid">
                <a href="#" class="dashboard-card" data-page="page-input-belanja-datang"><i class="fas fa-truck-loading"></i><h3>Input Belanja Datang</h3></a>
                <a href="#" class="dashboard-card" data-page="page-input-menu-keluar"><i class="fas fa-utensils"></i><h3>Input Menu Keluar</h3></a>
                <a href="#" class="dashboard-card" data-page="page-ambil-gudang"><i class="fas fa-warehouse"></i><h3>Ambil dari Gudang</h3></a>
                <a href="#" class="dashboard-card" data-page="page-laporan-analisa"><i class="fas fa-chart-pie"></i><h3>Laporan Analisa</h3></a>
            </div>`,
             'page-input-penjualan': () => `<div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-file-invoice-dollar"></i><span>Input Laporan Penjualan (CSV)</span></div><button class="btn btn-sm btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div><div class="card-body"><p>Unggah file CSV dari sistem kasir Anda untuk sinkronisasi data penjualan dan pemotongan stok otomatis. Pastikan format file memiliki kolom 'Item Name' dan 'Item Sold'.</p><button class="btn btn-primary" style="width:100%; margin-top:1rem;" data-action="trigger-sales-upload"><i class="fas fa-upload"></i> Pilih dan Proses File Laporan</button></div></div>`,
            'page-input-belanja': () => {
                const { masterItems } = RestoApp.AppState; const categories = [...new Set(masterItems.map(item => item.category))];
                let formHTML = categories.map(cat => {
                    let itemsHTML = masterItems.filter(item => item.category === cat).sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0)).map(item => `<div class="item-row"><label for="shopitem-${item.id}" class="item-label">${item.name}<div class="stock-hint">Stok: ${(item.stock || 0).toFixed(2)} ${item.unit}</div></label><input type="number" id="shopitem-${item.id}" class="form-control" placeholder="Jumlah" min="0" step="any" data-item-id="${item.id}"><span class="item-unit">${item.purchaseUnit || item.unit}</span></div>`).join('');
                    return `<div class="card"><h3 class="card-title">${cat}</h3><div class="item-list">${itemsHTML}</div></div>`;
                }).join('');
                return `<div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-shopping-cart"></i><span>Buat List Belanja</span></div><button class="btn btn-sm btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div>${formHTML}<button class="btn btn-primary" style="width:100%" data-action="save-shopping-list"><i class="fas fa-save"></i> Simpan List Belanja</button></div>`;
            },
            'page-input-belanja-datang': (data) => {
                if(data) return RestoApp.UI.Pages.stockInDetail(data);
                const { shoppingLists } = RestoApp.AppState;
                let content = (shoppingLists.length === 0) ? `<div class="empty-state">Tidak ada list belanja yang menunggu.</div>` : shoppingLists.map(list => `<div class="card" style="cursor:pointer;" data-action="select-pending-list" data-date="${list.date}"><strong>List Belanja - ${new Date(list.date).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}</strong></div>`).join('');
                return `<div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-truck-loading"></i><span>Pilih List Belanja</span></div><button class="btn btn-sm btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div>${content}</div>`;
            },
            'stockInDetail': (listDate) => {
                const shoppingList = RestoApp.AppState.shoppingLists.find(l => l.date === listDate); if (!shoppingList) return `Error: List not found.`;
                const itemsHTML = shoppingList.items.map(item => { const masterItem = RestoApp.AppState.masterItems.find(mi => mi.id === item.id); if (!masterItem) return '';
                    return `<div class="item-row"><label for="stockin-${item.id}" class="item-label">${masterItem.name}</label><input type="number" id="stockin-${item.id}" class="form-control" value="${item.qty}" min="0" step="any"><span class="item-unit">${masterItem.purchaseUnit || masterItem.unit}</span></div>`; }).join('');
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Konfirmasi Barang Datang</span></div><button class="btn btn-sm btn-secondary" data-page="page-input-belanja-datang"><i class="fas fa-arrow-left"></i> Kembali</button></div><div class="item-list">${itemsHTML}</div><div style="display:flex; gap: 10px; margin-top:1rem;"><button class="btn btn-primary" style="flex-grow:1;" data-action="process-stock-in" data-date="${listDate}">Proses</button><button class="btn btn-danger" data-action="cancel-shopping-list" data-date="${listDate}">Batalkan</button></div></div>`;
            },
            'page-input-menu-keluar': () => RestoApp.UI.Pages.stockOutPage('menu'),
            'page-ambil-gudang': () => RestoApp.UI.Pages.stockOutPage('gudang'),
            'page-input-waste': () => RestoApp.UI.Pages.stockOutPage('waste'),
            'stockOutPage': (type) => {
                const { masterItems, recipes, gudangItemIds, menuKeluarActive } = RestoApp.AppState;
                const pageConfigs = {
                    gudang: { title: "Ambil dari Gudang", icon: "fa-warehouse", action: "process-consumption", items: masterItems.filter(item => gudangItemIds.includes(item.id)).sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0)) },
                    menu: { title: "Input Menu Keluar", icon: "fa-utensils", action: "process-consumption", items: menuKeluarActive.map(key => ({ name: key, ...recipes[key] })).sort((a,b) => a.name.localeCompare(b.name)) },
                    waste: { title: "Input Waste", icon: "fa-trash-alt", action: "process-consumption", items: Object.keys(recipes).map(key => ({ name: key, ...recipes[key] })).sort((a,b) => a.name.localeCompare(b.name)) }
                };
                const config = pageConfigs[type];

                let formHTML = config.items.map(item => {
                    let stockHint = `Stok cukup untuk: ${RestoApp.Utils.calculateAvailablePortions(item.name)} ${item.unit}`;
                    if(type === 'gudang') stockHint = `Stok: ${(item.stock || 0).toFixed(2)} ${item.unit}`;

                    return `<div class="item-row"><label class="item-label">${item.name}<div class="stock-hint">${stockHint}</div></label><input type="number" class="form-control" data-name="${item.name}" placeholder="Jumlah" min="0" step="any"><span class="item-unit">${item.unit}</span></div>`;
                }).join('');
                if (config.items.length === 0) formHTML = `<div class="empty-state">Tidak ada item untuk ditampilkan.</div>`;
                return `<div class="card"><div class="card-header"><div class="card-title"><i class="fas ${config.icon}"></i><span>${config.title}</span></div><button class="btn btn-sm btn-secondary" data-page="page-dashboard"><i class="fas fa-arrow-left"></i> Kembali</button></div><div class="item-list" id="stockout-list" data-type="${type}">${formHTML}</div><button class="btn btn-primary" style="width:100%; margin-top:1rem;" data-action="${config.action}"><i class="fas fa-check"></i> Proses</button></div>`;
            },
            'page-riwayat-stok': () => {
                const { stockTransactions, masterItems } = RestoApp.AppState;
                const rows = [...(stockTransactions || [])].reverse().map(t => { const item = masterItems.find(i => i.id === t.itemId); const changeClass = t.change > 0 ? 'color: var(--success-color);' : 'color: var(--danger-color);';
                    let itemName = item ? item.name : (t.details || 'Item Dihapus');
                    return `<tr><td>${new Date(t.date).toLocaleString('id-ID', {dateStyle: 'short', timeStyle: 'short'})}</td><td>${itemName}</td><td>${t.type}</td><td style="${changeClass}">${t.change > 0 ? '+' : ''}${t.change.toFixed(2)}</td><td>${(t.newStock !== null && t.newStock !== undefined ? t.newStock.toFixed(2) : '-')}</td></tr>`; }).join('');
                const tableContent = rows.length > 0 ? `<div style="overflow-x:auto;"><table class="table"><thead><tr><th>Waktu</th><th>Item/Menu</th><th>Jenis</th><th>+/-</th><th>Sisa</th></tr></thead><tbody>${rows}</tbody></table></div>` : `<div class="empty-state">Belum ada riwayat transaksi stok.</div>`;
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Riwayat Stok</span></div><button class="btn btn-sm btn-secondary" data-page="page-dashboard">Kembali</button></div>${tableContent}</div>`;
            },
            // [DIUBAH] Halaman Laporan Analisa diperbarui
            'page-laporan-analisa': () => {
                const report = RestoApp.Utils.generateConsolidatedReport(RestoApp.AppState.reportPeriod);
                const getDiscrepancyClass = (d) => d < 0 ? 'color: var(--danger-color); font-weight: bold;' : (d > 0 ? `color: var(--accent-color); font-weight: bold;` : '');
                
                const rows = report.reportData.map(item => `<tr><td>${item.name}</td><td>${item.pos.toFixed(1)}</td><td>${item.waste.toFixed(1)}</td><td><strong>${item.totalShouldBe.toFixed(1)}</strong></td><td>${item.manual.toFixed(1)}</td><td>${item.opname.toFixed(1)}</td><td style="${getDiscrepancyClass(item.discrepancy)}">${item.discrepancy.toFixed(1)}</td></tr>`).join('');
                
                const tableContent = report.reportData.length > 0 ? `<div style="overflow-x:auto;"><table class="table"><thead><tr><th>Menu</th><th>Terjual (POS)</th><th>Waste</th><th>Total Seharusnya</th><th>Dicatat Manual</th><th>Penyesuaian (Opname)</th><th>Selisih</th></tr></thead><tbody>${rows}</tbody></table></div>` : `<div class="empty-state">Tidak ada data untuk dianalisa.</div>`;
                const period = RestoApp.AppState.reportPeriod;

                return `<div class="card">
                    <div class="card-header"><div class="card-title"><i class="fas fa-chart-pie"></i><span>Laporan Analisa Stok</span></div><button class="btn btn-sm btn-secondary" data-page="page-dashboard">Kembali</button></div>
                    <div class="card-body">
                         <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-sm ${period === '24h' ? 'btn-primary' : 'btn-secondary'}" data-action="set-report-period" data-period="24h">24 Jam Terakhir</button>
                            <button class="btn btn-sm ${period === 'today' ? 'btn-primary' : 'btn-secondary'}" data-action="set-report-period" data-period="today">Hari Ini</button>
                            <button class="btn btn-sm ${period === 'yesterday' ? 'btn-primary' : 'btn-secondary'}" data-action="set-report-period" data-period="yesterday">Kemarin</button>
                         </div>
                        <p>Laporan ini membandingkan data sesuai periode yang dipilih. <strong>Selisih</strong> dihitung dari <code>(Dicatat Manual + Penyesuaian Opname) - Total Seharusnya</code>.</p>
                        <ul style="font-size: 0.9rem;">
                            <li><strong>Selisih Negatif (Merah):</strong> Total yang tercatat (manual + opname) lebih sedikit dari yang seharusnya. Indikasi ada penjualan/waste yang tidak tercatat.</li>
                            <li><strong>Selisih Positif (Oranye):</strong> Total yang tercatat (manual + opname) lebih banyak dari yang seharusnya. Indikasi kesalahan input atau over-produksi.</li>
                        </ul>
                    </div>
                    ${tableContent}
                </div>`;
            },
            // [DIUBAH] Halaman Manager Area diperbarui dengan tombol Stok Opname
            'page-manager-area': () => `<div class="card"><div class="card-header"><div class="card-title"><span>Manager Area</span></div><button class="btn btn-sm btn-secondary" data-page="page-dashboard">Kembali</button></div><div class="dashboard-grid">
                <a href="#" class="dashboard-card" data-page="page-manager-items"><i class="fas fa-database"></i><h3>Database Barang</h3></a>
                <a href="#" class="dashboard-card" data-page="page-manager-recipes"><i class="fas fa-book-open"></i><h3>Manajemen Resep</h3></a>
                <a href="#" class="dashboard-card" data-page="page-manager-opname"><i class="fas fa-clipboard-check"></i><h3>Stok Opname</h3></a>
                <a href="#" class="dashboard-card" data-page="page-manager-display"><i class="fas fa-desktop"></i><h3>Atur Tampilan</h3></a>
                <a href="#" class="dashboard-card" data-page="page-manager-backup"><i class="fas fa-cloud-upload-alt"></i><h3>Cadangkan Data</h3></a>
            </div></div>`,
            // [BARU] Halaman baru untuk melakukan Stok Opname
            'page-manager-opname': () => {
                const { masterItems } = RestoApp.AppState;
                const sortedItems = [...masterItems].sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0));

                const rowsHTML = sortedItems.map(item => `
                    <tr data-item-id="${item.id}" data-system-stock="${item.stock || 0}">
                        <td>${item.name}<div class="stock-hint">${item.category}</div></td>
                        <td>${(item.stock || 0).toFixed(2)} ${item.unit}</td>
                        <td style="width: 150px;"><input type="number" class="form-control form-control-sm" placeholder="Stok Fisik" oninput="RestoApp.UI.updateOpnameDifference(this)" min="0" step="any"></td>
                        <td class="opname-difference" style="width: 100px; text-align:right;">-</td>
                    </tr>
                `).join('');

                const tableContent = sortedItems.length > 0 ? `
                    <div style="overflow-x:auto;">
                        <table class="table">
                            <thead><tr><th>Nama Barang</th><th>Stok Sistem</th><th>Stok Fisik</th><th style="text-align:right;">Selisih</th></tr></thead>
                            <tbody id="opname-list-tbody">${rowsHTML}</tbody>
                        </table>
                    </div>
                ` : `<div class="empty-state">Tidak ada barang di database untuk dilakukan opname.</div>`;

                return `<div class="card">
                    <div class="card-header"><div class="card-title"><i class="fas fa-clipboard-check"></i><span>Stok Opname</span></div><button class="btn btn-sm btn-secondary" data-page="page-manager-area">Kembali</button></div>
                    <div class="card-body">
                        <p>Masukkan jumlah stok fisik (hasil hitungan nyata) pada kolom yang tersedia. Biarkan kosong jika tidak ada perubahan atau tidak dihitung. Sistem akan otomatis membuat transaksi penyesuaian untuk setiap selisih yang ada.</p>
                    </div>
                    ${tableContent}
                    <div class="card-footer" style="margin-top: 1.5rem; text-align: right;">
                         <button class="btn btn-primary" data-action="process-stock-opname" ${sortedItems.length === 0 ? 'disabled' : ''}>
                            <i class="fas fa-save"></i> Simpan Hasil Opname & Sesuaikan Stok
                         </button>
                    </div>
                </div>`;
            },
            'page-manager-items': () => {
                const { masterItems } = RestoApp.AppState;
                const itemsHTML = masterItems.sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0)).map(item => `<tr data-id="${item.id}" draggable="true"><td class="drag-handle" aria-label="Urutkan"><i class="fas fa-grip-vertical"></i></td><td>${item.name}<div class="stock-hint">${item.category}</div></td><td>${(item.stock || 0).toFixed(2)} ${item.unit}</td><td style="display:flex;gap:0.5rem;"><button class="btn btn-sm btn-secondary" data-action="edit-item" data-id="${item.id}" aria-label="Edit"><i class="fas fa-pencil-alt"></i></button><button class="btn btn-sm btn-danger" data-action="delete-item" data-id="${item.id}" aria-label="Hapus"><i class="fas fa-trash"></i></button></td></tr>`).join('');
                const tableContent = masterItems.length > 0 ? `<div style="overflow-x:auto;"><table class="table"><thead><tr><th>Urutan</th><th>Nama</th><th>Stok</th><th>Aksi</th></tr></thead><tbody id="db-editor-tbody">${itemsHTML}</tbody></table></div>` : `<div class="empty-state">Database barang masih kosong. Silakan tambahkan barang baru.</div>`;
                const saveOrderButton = masterItems.length > 0 ? `<button class="btn btn-sm btn-primary" data-action="save-item-order">Simpan Urutan</button>` : '';

                return `<div class="card"><div class="card-header"><div class="card-title"><span>Database Barang</span></div><button class="btn btn-sm btn-secondary" data-page="page-manager-area">Kembali</button></div>
                <div class="card"><h3 class="card-title">Tambah / Edit Barang</h3><form id="add-item-form"><input type="hidden" id="edit-item-id"><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"><div class="form-group"><label class="form-label">Nama Barang</label><input class="form-control" type="text" id="item-name" required></div><div class="form-group"><label class="form-label">Kategori</label><input class="form-control" type="text" id="item-category" list="category-suggestions" required></div><div class="form-group"><label class="form-label">Satuan Stok</label><input class="form-control" type="text" id="item-unit" required></div><div class="form-group"><label class="form-label">Satuan Beli</label><input class="form-control" type="text" id="item-purchase-unit"></div><div class="form-group"><label class="form-label">Konversi</label><input class="form-control" type="number" id="item-conversion" min="0" step="any"></div><div class="form-group"><label class="form-label">Stok Minimum</label><input class="form-control" type="number" id="item-min-stock" min="0" step="any"></div></div><div style="display:flex; gap:10px; margin-top: 1rem;"><button type="button" class="btn btn-primary" data-action="save-item" id="save-item-btn" style="flex-grow:1;">Simpan</button><button type="button" class="btn btn-secondary" data-action="cancel-edit" id="cancel-edit-btn" style="display:none;">Batal</button></div></form><datalist id="category-suggestions"></datalist></div>
                <div class="card"><div class="card-header"><h3 class="card-title">Daftar Barang</h3>${saveOrderButton}</div>${tableContent}</div></div>`;
            },
            'page-manager-recipes': (data) => {
                if(data) return RestoApp.UI.Pages.recipeEditor(data);
                const { recipes } = RestoApp.AppState;
                const listHTML = Object.keys(recipes).sort().map(name => `<div class="item-row"><span>${name}</span><span>${recipes[name].unit}</span><div style="display:flex;gap:0.5rem;"><button class="btn btn-sm btn-secondary" data-action="edit-recipe" data-name="${name}" aria-label="Edit Resep">Edit</button><button class="btn btn-sm btn-danger" data-action="delete-recipe" data-name="${name}" aria-label="Hapus Resep">Hapus</button></div></div>`).join('') || `<div class="empty-state">Belum ada resep yang dibuat.</div>`;
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Manajemen Resep</span></div><button class="btn btn-sm btn-secondary" data-page="page-manager-area">Kembali</button></div><div class="card-header"><h3>Daftar Resep</h3><button class="btn btn-sm btn-primary" data-action="add-recipe"><i class="fas fa-plus"></i> Tambah</button></div><div class="item-list">${listHTML}</div></div>`;
            },
            'recipeEditor': (recipeName = null) => {
                const isEditing = recipeName != null; const { recipes, masterItems } = RestoApp.AppState; const recipe = isEditing ? recipes[recipeName] : { unit: '', ingredients: [] };
                const itemOptions = masterItems.sort((a, b) => a.name.localeCompare(b.name)).map(item => `<option value="${item.id}">${item.name} (${item.unit})</option>`).join('');
                let ingredientsHTML = recipe.ingredients.map(ing => { const item = masterItems.find(mi => mi.id === ing.itemId); return `<div class="item-row ingredient-item" data-item-id="${ing.itemId}"><span>${item ? item.name : 'N/A'}</span><input type="number" class="form-control" value="${ing.qty}" step="any" min="0"><div><span>${item ? item.unit : ''}</span><button class="btn btn-sm btn-danger" data-action="remove-ingredient" aria-label="Hapus Bahan"><i class="fas fa-trash"></i></button></div></div>`; }).join('');
                return `<div class="card"><div class="card-header"><h2 class="card-title">${isEditing ? 'Edit' : 'Tambah'} Resep</h2><button class="btn btn-sm btn-secondary" data-action="cancel-recipe-edit">Kembali</button></div>
                    <div class="form-group"><label class="form-label">Nama Menu</label><input type="text" id="recipe-name" class="form-control" value="${isEditing ? recipeName : ''}" ${isEditing ? 'readonly' : ''}></div>
                    <div class="form-group"><label class="form-label">Satuan Hasil</label><input type="text" id="recipe-unit" class="form-control" value="${recipe.unit}"></div>
                    <div class="card"><h3 class="card-title">Bahan</h3><div id="ingredients-list">${ingredientsHTML}</div><div style="margin-top:1rem;padding-top:1rem;border-top:1px dashed #ccc;display:grid;grid-template-columns:2fr 1fr auto;gap:10px;align-items:center;"><select id="new-ingredient-item" class="form-control">${itemOptions}</select><input type="number" id="new-ingredient-qty" class="form-control" placeholder="Jumlah"><button class="btn btn-primary" data-action="add-ingredient">+</button></div></div>
                    <div style="display:flex; gap:10px; margin-top: 1rem;">
                        <button class="btn btn-secondary" data-action="cancel-recipe-edit" style="flex-grow:1;">Batal</button>
                        <button class="btn btn-primary" style="flex-grow:2;" data-action="save-recipe" data-original-name="${isEditing ? recipeName : ''}">Simpan Resep</button>
                    </div></div>`;
            },
            'page-manager-display': () => {
                const { masterItems, recipes, menuKeluarActive, gudangItemIds } = RestoApp.AppState;
                const menuCheckboxes = Object.keys(recipes).sort().map(name => `<label><input type="checkbox" data-type="menu" value="${name}" ${menuKeluarActive.includes(name) ? 'checked' : ''}> ${name}</label>`).join('');
                const gudangCheckboxes = masterItems.filter(item => item.category === 'Gudang' || item.category === 'Operasional').sort((a,b)=>a.name.localeCompare(b.name)).map(item => `<label><input type="checkbox" data-type="gudang" value="${item.id}" ${gudangItemIds.includes(item.id) ? 'checked' : ''}> ${item.name}</label>`).join('');
                return `<div class="card"><div class="card-header"><div class="card-title"><span>Atur Tampilan</span></div><button class="btn btn-sm btn-secondary" data-page="page-manager-area">Kembali</button></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div style="display:flex;flex-direction:column;gap:0.5rem;"><h4>Menu Keluar</h4>${menuCheckboxes || 'Tidak ada resep.'}</div>
                    <div style="display:flex;flex-direction:column;gap:0.5rem;"><h4>Ambil Gudang</h4>${gudangCheckboxes || 'Tidak ada item gudang.'}</div>
                </div>
                <button class="btn btn-primary" style="margin-top:1rem;" data-action="save-display-config">Simpan</button></div>`;
            },
            'page-manager-backup': () => `<div class="card"><div class="card-header"><div class="card-title"><span>Cadangkan Data</span></div><button class="btn btn-sm btn-secondary" data-page="page-manager-area">Kembali</button></div><p>Simpan atau muat semua data dari file JSON. Import akan menimpa data saat ini.</p><div style="display:flex; gap:10px;"><button class="btn btn-primary" data-action="export-data">Export</button><button class="btn btn-secondary" data-action="import-data">Import</button></div></div>`,
        }
    },
    
    Events: {
        handle(event) {
            const target = event.target.closest('[data-action], [data-page]'); if (!target) return;
            event.preventDefault(); const { action, page, ...data } = target.dataset;
            if (page) {
                RestoApp.UI.renderPage(page);
                if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
                return;
            }
            if (action) { 
                const handler = RestoApp.Events.ActionHandlers[action]; 
                if (handler) {
                    const button = event.target.closest('button');
                    const isAsync = handler.constructor.name === 'AsyncFunction';
                    if (isAsync && button) RestoApp.Utils.handleAsyncButton(button, () => handler({ target, ...data }));
                    else handler({ target, ...data });
                }
            }
        },
        ActionHandlers: {
            'logout': () => RestoApp.Auth.logout(),
            'toggle-sidebar': () => document.getElementById('sidebar').classList.toggle('open'),
            'show-low-stock-modal': () => RestoApp.UI.showLowStockModal(),
            'close-modal': ({target}) => { if (target.classList.contains('modal-backdrop') || target.closest('.modal-close-btn')) RestoApp.UI.closeModal(); },
            'save-shopping-list': async () => {
                const items = Array.from(document.querySelectorAll('#page-input-belanja input[data-item-id]')).map(input => ({ id: parseInt(input.dataset.itemId), qty: parseFloat(input.value) })).filter(item => item.qty > 0);
                if (items.length === 0) return RestoApp.UI.showToast('List belanja kosong.', 'info');
                const shoppingLists = RestoApp.AppState.shoppingLists || []; shoppingLists.push({ date: new Date().toISOString(), items });
                await RestoApp.API.setKey('shoppingLists', shoppingLists); RestoApp.UI.showToast('List belanja disimpan!', 'success'); RestoApp.UI.renderPage('page-dashboard');
            },
            'select-pending-list': ({date}) => RestoApp.UI.renderPage('page-input-belanja-datang', date),
            'process-stock-in': async ({date}) => {
                const shoppingList = RestoApp.AppState.shoppingLists.find(l => l.date === date); let { masterItems, stockTransactions } = RestoApp.AppState;
                shoppingList.items.forEach(item => {
                    const qtyReceived = parseFloat(document.getElementById(`stockin-${item.id}`).value);
                    if (!isNaN(qtyReceived) && qtyReceived > 0) {
                        const itemIndex = masterItems.findIndex(mi => mi.id === item.id);
                        if (itemIndex > -1) {
                            const stockIncrease = qtyReceived * (masterItems[itemIndex].purchaseUnitConversion || 1);
                            masterItems[itemIndex].stock = (masterItems[itemIndex].stock || 0) + stockIncrease;
                            stockTransactions.push({ date: new Date().toISOString(), itemId: item.id, type: 'Stok Masuk', change: stockIncrease, newStock: masterItems[itemIndex].stock, details: masterItems[itemIndex].name });
                        }
                    }
                });
                await RestoApp.API.set({ shoppingLists: RestoApp.AppState.shoppingLists.filter(l => l.date !== date), masterItems, stockTransactions });
                RestoApp.UI.showToast('Stok diperbarui!', 'success');
                RestoApp.UI.renderPage('page-dashboard');
            },
            'cancel-shopping-list': async ({date}) => {
                if (!confirm('Anda yakin ingin membatalkan list belanja ini? Aksi ini tidak dapat diurungkan.')) return; 
                await RestoApp.API.setKey('shoppingLists', RestoApp.AppState.shoppingLists.filter(l => l.date !== date)); 
                RestoApp.UI.showToast('List belanja dibatalkan.', 'success');
                RestoApp.UI.renderPage('page-input-belanja-datang');
            },
            'process-consumption': async () => {
                const type = document.getElementById('stockout-list').dataset.type;
                const transactionTypes = { menu: 'Produksi Menu', waste: 'Waste', gudang: 'Gudang' };
                let { masterItems, recipes, stockTransactions } = RestoApp.AppState;
                const itemsToProcess = Array.from(document.querySelectorAll('#stockout-list input[data-name]')).map(input => ({ name: input.dataset.name, qty: parseFloat(input.value) || 0 })).filter(item => item.qty > 0);

                if (itemsToProcess.length === 0) return RestoApp.UI.showToast('Tidak ada jumlah yang diinput.', 'info');
                
                const requiredStock = {};
                for (const item of itemsToProcess) {
                    if (type === 'menu' || type === 'waste') {
                        recipes[item.name].ingredients.forEach(ing => {
                            requiredStock[ing.itemId] = (requiredStock[ing.itemId] || 0) + (ing.qty * item.qty);
                        });
                    } else if (type === 'gudang') {
                        const masterItem = masterItems.find(mi => mi.name === item.name);
                        if (masterItem) requiredStock[masterItem.id] = (requiredStock[masterItem.id] || 0) + item.qty;
                    }
                }

                for (const [itemId, requiredQty] of Object.entries(requiredStock)) {
                    const item = masterItems.find(mi => mi.id == itemId);
                    if (!item || (item.stock || 0) < requiredQty) {
                        throw new Error(`Stok tidak cukup untuk ${item.name}. Dibutuhkan: ${requiredQty.toFixed(2)}, Tersedia: ${(item.stock || 0).toFixed(2)}.`);
                    }
                }

                const txDate = new Date().toISOString();
                itemsToProcess.forEach(item => {
                    const mainTransactionType = transactionTypes[type];
                    stockTransactions.push({ date: txDate, itemId: null, type: mainTransactionType, change: item.qty, newStock: null, details: item.name });

                    if (type === 'menu' || type === 'waste') {
                        recipes[item.name].ingredients.forEach(ing => {
                            const itemIndex = masterItems.findIndex(mi => mi.id === ing.itemId);
                            if (itemIndex > -1) {
                                const stockDecrease = ing.qty * item.qty;
                                masterItems[itemIndex].stock -= stockDecrease;
                                stockTransactions.push({ date: txDate, itemId: ing.itemId, type: `${mainTransactionType}: ${item.name}`, change: -stockDecrease, newStock: masterItems[itemIndex].stock, details: item.name });
                            }
                        });
                    } else if (type === 'gudang') {
                        const itemIndex = masterItems.findIndex(mi => mi.name === item.name);
                        if (itemIndex > -1) {
                            masterItems[itemIndex].stock -= item.qty;
                            stockTransactions.push({ date: txDate, itemId: masterItems[itemIndex].id, type: 'Gudang', change: -item.qty, newStock: masterItems[itemIndex].stock, details: item.name });
                        }
                    }
                });

                await RestoApp.API.set({ masterItems, stockTransactions });
                RestoApp.UI.showToast('Stok berhasil diproses!', 'success');
                RestoApp.UI.renderPage(document.location.hash.substring(1));
            },
            // [BARU] Aksi untuk memproses hasil stok opname
            'process-stock-opname': async () => {
                if (!confirm("Anda yakin ingin menyimpan hasil opname? Ini akan memperbarui stok sistem dan membuat transaksi penyesuaian.")) return;

                let { masterItems, stockTransactions } = RestoApp.AppState;
                const updatedMasterItems = JSON.parse(JSON.stringify(masterItems)); // Deep copy
                const newTransactions = [];
                const txDate = new Date().toISOString();
                let changesMade = 0;

                document.querySelectorAll('#opname-list-tbody tr').forEach(row => {
                    const itemId = parseInt(row.dataset.itemId);
                    const input = row.querySelector('input');
                    const physicalStockStr = input.value;

                    if (physicalStockStr !== '') {
                        const physicalStock = parseFloat(physicalStockStr);
                        const itemIndex = updatedMasterItems.findIndex(item => item.id === itemId);

                        if (itemIndex !== -1 && !isNaN(physicalStock)) {
                            const systemStock = updatedMasterItems[itemIndex].stock || 0;
                            const adjustment = physicalStock - systemStock;

                            if (adjustment !== 0) {
                                changesMade++;
                                updatedMasterItems[itemIndex].stock = physicalStock;
                                newTransactions.push({
                                    date: txDate,
                                    itemId: itemId,
                                    type: 'Stok Opname',
                                    change: adjustment,
                                    newStock: physicalStock,
                                    details: 'Penyesuaian stok'
                                });
                            }
                        }
                    }
                });
                
                if (changesMade === 0) {
                    return RestoApp.UI.showToast("Tidak ada perubahan stok yang diinput.", "info");
                }
                
                const allTransactions = [...stockTransactions, ...newTransactions];
                await RestoApp.API.set({ masterItems: updatedMasterItems, stockTransactions: allTransactions });
                RestoApp.UI.showToast(`Stok opname berhasil disimpan! ${changesMade} barang disesuaikan.`, 'success');
                RestoApp.UI.renderPage('page-manager-area');
            },
            'trigger-sales-upload': () => document.getElementById('sales-report-input').click(),
            'analyzeSalesReport': (csvText) => {
                const { recipes } = RestoApp.AppState;
                const lines = RestoApp.Utils.parseCsv(csvText);
                if (lines.length < 2) throw new Error("File CSV kosong atau tidak valid.");

                const headers = lines[0].map(h => h.toLowerCase());
                const findColumnIndex = (possibleNames) => {
                    for (const name of possibleNames) {
                        const index = headers.indexOf(name.toLowerCase());
                        if (index !== -1) return index;
                    }
                    return -1;
                };

                const itemNameIndex = findColumnIndex(['item name', 'nama item', 'nama produk', 'menu']);
                const itemSoldIndex = findColumnIndex(['item sold', 'sold', 'terjual', 'jumlah terjual', 'qty']);

                if (itemNameIndex === -1) throw new Error("Kolom 'Nama Item' tidak ditemukan di file CSV.");
                if (itemSoldIndex === -1) throw new Error("Kolom 'Jumlah Terjual' tidak ditemukan di file CSV.");

                const normalize = (str) => str.toLowerCase().split(/[\s,._-]+/).filter(Boolean);
                const recipeSearchList = Object.keys(recipes).map(name => ({ name, words: normalize(name) })).sort((a, b) => b.words.length - a.words.length);
                
                const salesData = {}; const unmatchedItems = [];
                lines.slice(1).forEach(columns => {
                    if (columns.length > Math.max(itemNameIndex, itemSoldIndex)) {
                        const itemName = columns[itemNameIndex].trim();
                        const itemSold = parseInt(columns[itemSoldIndex]);
                        if (itemName && !isNaN(itemSold) && itemSold > 0) {
                            const saleWords = normalize(itemName); let foundMatch = false;
                            for (const recipe of recipeSearchList) {
                                if (recipe.words.every(word => saleWords.includes(word))) {
                                    salesData[recipe.name] = (salesData[recipe.name] || 0) + itemSold;
                                    foundMatch = true; break; 
                                }
                            }
                            if (!foundMatch) unmatchedItems.push({ name: itemName, qty: itemSold });
                        }
                    }
                });
                
                if (Object.keys(salesData).length === 0 && unmatchedItems.length === 0) {
                    throw new Error("Tidak ada data penjualan yang dapat diproses dari file.");
                }
                RestoApp.UI.showSalesConfirmationModal(salesData, unmatchedItems, salesData);
            },
            'executeSalesReport': async(salesData) => {
                const { masterItems, recipes, stockTransactions, salesReports } = RestoApp.AppState;
                const requiredStock = {};
                Object.entries(salesData).forEach(([recipeName, qty]) => {
                     recipes[recipeName].ingredients.forEach(ing => {
                        requiredStock[ing.itemId] = (requiredStock[ing.itemId] || 0) + (ing.qty * qty);
                    });
                });
                for (const [itemId, requiredQty] of Object.entries(requiredStock)) {
                    const item = masterItems.find(mi => mi.id == itemId);
                    if (!item || (item.stock || 0) < requiredQty) {
                        throw new Error(`Stok tidak cukup untuk ${item.name}. Dibutuhkan: ${requiredQty.toFixed(2)}, Tersedia: ${(item.stock || 0).toFixed(2)}.`);
                    }
                }
                const txDate = new Date().toISOString();
                Object.entries(salesData).forEach(([recipeName, qty]) => {
                    recipes[recipeName].ingredients.forEach(ing => {
                        const itemIndex = masterItems.findIndex(mi => mi.id === ing.itemId);
                        if (itemIndex > -1) {
                            const stockDecrease = ing.qty * qty;
                            masterItems[itemIndex].stock -= stockDecrease;
                            stockTransactions.push({ date: txDate, itemId: ing.itemId, type: `Penjualan (POS)`, change: -stockDecrease, newStock: masterItems[itemIndex].stock, details: recipeName });
                        }
                    });
                });
                salesReports.push({ date: txDate, items: salesData });
                await RestoApp.API.set({ masterItems, stockTransactions, salesReports });
                RestoApp.UI.closeModal();
                RestoApp.UI.showToast(`${Object.keys(salesData).length} item penjualan berhasil diproses!`, 'success');
                RestoApp.UI.renderPage('page-laporan-analisa');
            },
            'save-item': async () => {
                const newName = document.getElementById('item-name').value.trim(); const id = document.getElementById('edit-item-id').value;
                if (!newName) return RestoApp.UI.showToast('Nama harus diisi!', 'error');
                const isNameDuplicate = RestoApp.AppState.masterItems.some(item => item.name.toLowerCase() === newName.toLowerCase() && item.id != id);
                if (isNameDuplicate) return RestoApp.UI.showToast(`Nama barang "${newName}" sudah ada.`, 'error');

                const newItemData = {
                    name: newName, category: document.getElementById('item-category').value.trim() || 'Lainnya', unit: document.getElementById('item-unit').value.trim(), 
                    purchaseUnit: document.getElementById('item-purchase-unit').value.trim() || document.getElementById('item-unit').value.trim(), 
                    purchaseUnitConversion: parseFloat(document.getElementById('item-conversion').value) || 1, minStock: parseFloat(document.getElementById('item-min-stock').value) || 0
                };
                let masterItems = RestoApp.AppState.masterItems;
                if (id) {
                    const index = masterItems.findIndex(i => i.id == id); masterItems[index] = { ...masterItems[index], ...newItemData };
                } else {
                    const newId = masterItems.length > 0 ? Math.max(...masterItems.map(i => i.id)) + 1 : 1;
                    masterItems.push({ ...newItemData, id: newId, stock: 0, sortOrder: masterItems.length });
                }
                await RestoApp.API.setKey('masterItems', masterItems); 
                RestoApp.UI.showToast('Barang disimpan!', 'success'); 
                RestoApp.Events.ActionHandlers['cancel-edit']();
            },
            'edit-item': ({id}) => {
                const item = RestoApp.AppState.masterItems.find(i => i.id == id); if(!item) return;
                document.getElementById('edit-item-id').value = item.id; document.getElementById('item-name').value = item.name; document.getElementById('item-category').value = item.category; document.getElementById('item-unit').value = item.unit; document.getElementById('item-purchase-unit').value = item.purchaseUnit; document.getElementById('item-conversion').value = item.purchaseUnitConversion; document.getElementById('item-min-stock').value = item.minStock;
                document.getElementById('save-item-btn').innerHTML = 'Update'; document.getElementById('cancel-edit-btn').style.display = 'inline-flex';
                document.getElementById('item-name').focus();
            },
            'cancel-edit': () => { document.getElementById('add-item-form').reset(); document.getElementById('edit-item-id').value = ''; document.getElementById('save-item-btn').innerHTML = 'Simpan'; document.getElementById('cancel-edit-btn').style.display = 'none'; },
            'delete-item': async ({id}) => {
                const item = RestoApp.AppState.masterItems.find(i => i.id == id);
                if ((item.stock || 0) > 0) return RestoApp.UI.showToast('Tidak bisa hapus, barang masih ada stok.', 'error');
                if (Object.values(RestoApp.AppState.recipes).some(r => r.ingredients.some(i => i.itemId == id))) return RestoApp.UI.showToast(`Gagal! "${item.name}" masih digunakan di resep.`, 'error');
                if (!confirm(`Hapus "${item.name}"?`)) return; 
                await RestoApp.API.setKey('masterItems', RestoApp.AppState.masterItems.filter(i => i.id != id)); RestoApp.UI.showToast('Barang dihapus.', 'success');
            },
            'save-item-order': async () => {
                const masterItems = [...RestoApp.AppState.masterItems]; document.querySelectorAll('#db-editor-tbody tr').forEach((row, index) => { const item = masterItems.find(i => i.id == row.dataset.id); if (item) item.sortOrder = index; });
                await RestoApp.API.setKey('masterItems', masterItems); RestoApp.UI.showToast('Urutan disimpan!', 'success');
            },
            'add-recipe': () => RestoApp.UI.renderPage('page-manager-recipes', 'new'),
            'edit-recipe': ({name}) => RestoApp.UI.renderPage('page-manager-recipes', name),
            'cancel-recipe-edit': () => RestoApp.UI.renderPage('page-manager-recipes'),
            'delete-recipe': async ({name}) => {
                if (!confirm(`Hapus resep "${name}"?`)) return; let { recipes, menuKeluarActive } = RestoApp.AppState;
                delete recipes[name]; menuKeluarActive = menuKeluarActive.filter(menu => menu !== name);
                await RestoApp.API.set({ recipes, menuKeluarActive }); RestoApp.UI.showToast('Resep dihapus.', 'success');
            },
            'add-ingredient': () => {
                const list = document.getElementById('ingredients-list'); const itemId = document.getElementById('new-ingredient-item').value; const qty = parseFloat(document.getElementById('new-ingredient-qty').value);
                if (!itemId || !(qty > 0)) return RestoApp.UI.showToast('Pilih barang dan isi jumlah.', 'error');
                const item = RestoApp.AppState.masterItems.find(mi => mi.id == itemId); const newIngredientHTML = document.createElement('div');
                newIngredientHTML.className = 'item-row ingredient-item'; newIngredientHTML.dataset.itemId = item.id;
                newIngredientHTML.innerHTML = `<span>${item.name}</span><input type="number" class="form-control" value="${qty}" step="any" min="0"><div><span>${item.unit}</span><button class="btn btn-sm btn-danger" data-action="remove-ingredient"><i class="fas fa-trash"></i></button></div>`;
                list.appendChild(newIngredientHTML); document.getElementById('new-ingredient-qty').value = '';
            },
            'remove-ingredient': ({target}) => target.closest('.ingredient-item').remove(),
            'save-recipe': async ({target}) => {
                const originalName = target.dataset.originalName; const newName = document.getElementById('recipe-name').value.trim(); const unit = document.getElementById('recipe-unit').value.trim();
                if (!newName || !unit) throw new Error('Nama dan satuan resep harus diisi.');
                const ingredients = Array.from(document.querySelectorAll('.ingredient-item')).map(el => ({ itemId: parseInt(el.dataset.itemId), qty: parseFloat(el.querySelector('input').value) }));
                if (ingredients.length === 0) throw new Error('Resep harus memiliki minimal 1 bahan.');
                
                let { recipes, menuKeluarActive } = RestoApp.AppState;
                if ((originalName !== newName) && recipes[newName]) throw new Error('Nama menu sudah ada.');
                
                if (originalName && originalName !== 'new' && originalName !== newName) { delete recipes[originalName]; menuKeluarActive = menuKeluarActive.map(m => m === originalName ? newName : m); }
                recipes[newName] = { unit, ingredients }; if (originalName === 'new' && !menuKeluarActive.includes(newName)) menuKeluarActive.push(newName);
                await RestoApp.API.set({ recipes, menuKeluarActive }); 
                RestoApp.UI.showToast(`Resep "${newName}" disimpan.`, 'success'); 
                RestoApp.UI.renderPage('page-manager-recipes');
            },
            'save-display-config': async () => {
                const container = document.querySelector('.card > div[style*="grid-template-columns:1fr 1fr"]');
                const menuKeluarActive = Array.from(container.querySelectorAll('input[data-type="menu"]:checked')).map(cb => cb.value); const gudangItemIds = Array.from(container.querySelectorAll('input[data-type="gudang"]:checked')).map(cb => parseInt(cb.value));
                await RestoApp.API.set({ menuKeluarActive, gudangItemIds }); RestoApp.UI.showToast('Tampilan disimpan!', 'success');
            },
            'export-data': () => {
                const dataToExport = { ...RestoApp.AppState };
                ['currentUser', 'isDataLoaded', 'unsubscribe', 'reportPeriod'].forEach(key => delete dataToExport[key]);
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                a.download = `restoapp_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
            },
            'import-data': () => {
                const fileInput = document.getElementById('import-file-input');
                fileInput.onchange = e => { const file = e.target.files[0]; if (!file || !confirm("PERINGATAN: Ini akan menimpa semua data Anda saat ini. Lanjutkan?")) return;
                    const reader = new FileReader();
                    reader.onload = async event => {
                        try {
                            const data = JSON.parse(event.target.result); await RestoApp.API.set(data);
                            RestoApp.UI.showToast('Impor berhasil! Memuat ulang...', 'success'); setTimeout(() => window.location.reload(), 1500);
                        } catch (error) { RestoApp.UI.showToast('Gagal impor: ' + error.message, 'error'); }
                    };
                    reader.readAsText(file);
                };
                fileInput.click();
            },
            'set-report-period': ({period}) => {
                RestoApp.AppState.reportPeriod = period;
                RestoApp.UI.renderPage('page-laporan-analisa', null, true);
            }
        },
    },

    App: {
        init() {
            RestoApp.Auth.listen();
            document.addEventListener('submit', (e) => {
                if (e.target.id === 'login-form') {
                    e.preventDefault(); 
                    const button = e.target.querySelector('button[type="submit"]');
                    const errorEl = document.getElementById('login-error');
                    errorEl.style.display = 'none';
                    RestoApp.Utils.handleAsyncButton(button, async () => {
                        try {
                            await RestoApp.Auth.login(document.getElementById('email').value, document.getElementById('password').value);
                        } catch(error) {
                            errorEl.textContent = "Login Gagal: Periksa kembali email dan password Anda.";
                            errorEl.style.display = 'block';
                            throw error;
                        }
                    });
                }
            });
            document.addEventListener('click', (e) => RestoApp.Events.handle(e));
            window.addEventListener('hashchange', () => RestoApp.UI.renderPage(location.hash.substring(1) || 'page-dashboard'));

            const salesReportInput = document.getElementById('sales-report-input');
            salesReportInput.onchange = e => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async event => {
                    try {
                        RestoApp.Events.ActionHandlers.analyzeSalesReport(event.target.result);
                    } catch (error) {
                        RestoApp.UI.showToast('Gagal menganalisa laporan: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
                salesReportInput.value = ''; 
            };
        },
        initOnLogin() {
            RestoApp.UI.renderSidebar();
            RestoApp.API.listenToData();
        },
    }
};

RestoApp.App.init();
</script>
</body>
</html>
